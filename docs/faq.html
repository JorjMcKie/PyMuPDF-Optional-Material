
<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Collection of Recipes &#8212; PyMuPDF 1.18.9 documentation</title>
    <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
    <link rel="stylesheet" href="_static/pyramid.css" type="text/css" />
    <script id="documentation_options" data-url_root="./" src="_static/documentation_options.js"></script>
    <script src="_static/jquery.js"></script>
    <script src="_static/underscore.js"></script>
    <script src="_static/doctools.js"></script>
    <link rel="shortcut icon" href="_static/PyMuPDF.ico"/>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="Using fitz as a Module" href="module.html" />
    <link rel="prev" title="Tutorial" href="tutorial.html" />
<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Neuton&amp;subset=latin" type="text/css" media="screen" charset="utf-8" />
<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Nobile:regular,italic,bold,bolditalic&amp;subset=latin" type="text/css" media="screen" charset="utf-8" />
<!--[if lte IE 6]>
<link rel="stylesheet" href="_static/ie6.css" type="text/css" media="screen" charset="utf-8" />
<![endif]-->

  </head><body>

    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="module.html" title="Using fitz as a Module"
             accesskey="N">next</a> |</li>
        <li class="right" >
          <a href="tutorial.html" title="Tutorial"
             accesskey="P">previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="index.html">PyMuPDF 1.18.9 documentation</a> &#187;</li>
        <li class="nav-item nav-item-this"><a href="">Collection of Recipes</a></li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <div class="section" id="collection-of-recipes">
<span id="faq"></span><h1>Collection of Recipes<a class="headerlink" href="#collection-of-recipes" title="Permalink to this headline">¶</a></h1>
<p>A collection of recipes in “How-To” format for using PyMuPDF. We aim to extend this section over time. Where appropriate we will refer to the corresponding <a class="reference external" href="https://github.com/pymupdf/PyMuPDF/wiki">Wiki</a> pages, but some duplication may still occur.</p>
<hr class="docutils" />
<div class="section" id="images">
<h2>Images<a class="headerlink" href="#images" title="Permalink to this headline">¶</a></h2>
<hr class="docutils" />
<div class="section" id="how-to-make-images-from-document-pages">
<h3>How to Make Images from Document Pages<a class="headerlink" href="#how-to-make-images-from-document-pages" title="Permalink to this headline">¶</a></h3>
<p>This little script will take a document filename and generate a PNG file from each of its pages.</p>
<p>The document can be any supported type like PDF, XPS, etc.</p>
<p>The script works as a command line tool which expects the filename being supplied as a parameter. The generated image files (1 per page) are stored in the directory of the script:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">sys</span><span class="o">,</span> <span class="nn">fitz</span>  <span class="c1"># import the binding</span>
<span class="n">fname</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>  <span class="c1"># get filename from command line</span>
<span class="n">doc</span> <span class="o">=</span> <span class="n">fitz</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">fname</span><span class="p">)</span>  <span class="c1"># open document</span>
<span class="k">for</span> <span class="n">page</span> <span class="ow">in</span> <span class="n">doc</span><span class="p">:</span>  <span class="c1"># iterate through the pages</span>
    <span class="n">pix</span> <span class="o">=</span> <span class="n">page</span><span class="o">.</span><span class="n">get_pixmap</span><span class="p">(</span><span class="n">alpha</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span>  <span class="c1"># render page to an image</span>
    <span class="n">pix</span><span class="o">.</span><span class="n">writePNG</span><span class="p">(</span><span class="s2">&quot;page-</span><span class="si">%i</span><span class="s2">.png&quot;</span> <span class="o">%</span> <span class="n">page</span><span class="o">.</span><span class="n">number</span><span class="p">)</span>  <span class="c1"># store image as a PNG</span>
</pre></div>
</div>
<p>The script directory will now contain PNG image files named <em>page-0.png</em>, <em>page-1.png</em>, etc. Pictures have the dimension of their pages, e.g. 595 x 842 pixels for an A4 portrait sized page. They will have a resolution of 72 dpi in x and y dimension and have no transparency. You can change all that – for how to do this, read the next sections.</p>
</div>
<hr class="docutils" />
<div class="section" id="how-to-increase-image-resolution">
<h3>How to Increase <span class="target" id="index-0"></span>Image Resolution<a class="headerlink" href="#how-to-increase-image-resolution" title="Permalink to this headline">¶</a></h3>
<p>The image of a document page is represented by a <a class="reference internal" href="pixmap.html#pixmap"><span class="std std-ref">Pixmap</span></a>, and the simplest way to create a pixmap is via method <a class="reference internal" href="page.html#Page.get_pixmap" title="Page.get_pixmap"><code class="xref py py-meth docutils literal notranslate"><span class="pre">Page.get_pixmap()</span></code></a>.</p>
<p>This method has many options for influencing the result. The most important among them is the <a class="reference internal" href="matrix.html#matrix"><span class="std std-ref">Matrix</span></a>, which lets you <span class="target" id="index-1"></span>zoom, rotate, distort or mirror the outcome.</p>
<p><a class="reference internal" href="page.html#Page.get_pixmap" title="Page.get_pixmap"><code class="xref py py-meth docutils literal notranslate"><span class="pre">Page.get_pixmap()</span></code></a> by default will use the <a class="reference internal" href="identity.html#identity"><span class="std std-ref">Identity</span></a> matrix, which does nothing.</p>
<p>In the following, we apply a <span class="target" id="index-2"></span>zoom factor of 2 to each dimension, which will generate an image with a four times better resolution for us (and also about 4 times the size):</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">zoom_x</span> <span class="o">=</span> <span class="mf">2.0</span>  <span class="c1"># horizontal zoom</span>
<span class="n">zomm_y</span> <span class="o">=</span> <span class="mf">2.0</span>  <span class="c1"># vertical zoom</span>
<span class="n">mat</span> <span class="o">=</span> <span class="n">fitz</span><span class="o">.</span><span class="n">Matrix</span><span class="p">(</span><span class="n">zoom_x</span><span class="p">,</span> <span class="n">zomm_y</span><span class="p">)</span>  <span class="c1"># zoom factor 2 in each dimension</span>
<span class="n">pix</span> <span class="o">=</span> <span class="n">page</span><span class="o">.</span><span class="n">get_pixmap</span><span class="p">(</span><span class="n">matrix</span><span class="o">=</span><span class="n">mat</span><span class="p">)</span>  <span class="c1"># use &#39;mat&#39; instead of the identity matrix</span>
</pre></div>
</div>
</div>
<hr class="docutils" />
<div class="section" id="how-to-create-partial-pixmaps-clips">
<h3>How to Create <span class="target" id="index-3"></span>Partial Pixmaps (Clips)<a class="headerlink" href="#how-to-create-partial-pixmaps-clips" title="Permalink to this headline">¶</a></h3>
<p>You do not always need the full image of a page. This may be the case e.g. when you display the image in a GUI and would like to zoom into a part of the page.</p>
<p>Let’s assume your GUI window has room to display a full document page, but you now want to fill this room with the bottom right quarter of your page, thus using a four times better resolution.</p>
<p>To achieve this, we define a rectangle equal to the area we want to appear in the GUI and call it “clip”. One way of constructing rectangles in PyMuPDF is by providing two diagonally opposite corners, which is what we are doing here.</p>
<a class="reference internal image-reference" href="_images/img-clip.jpg"><img alt="_images/img-clip.jpg" src="_images/img-clip.jpg" style="width: 195.20000000000002px; height: 260.0px;" /></a>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">mat</span> <span class="o">=</span> <span class="n">fitz</span><span class="o">.</span><span class="n">Matrix</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>  <span class="c1"># zoom factor 2 in each direction</span>
<span class="n">rect</span> <span class="o">=</span> <span class="n">page</span><span class="o">.</span><span class="n">rect</span>  <span class="c1"># the page rectangle</span>
<span class="n">mp</span> <span class="o">=</span> <span class="p">(</span><span class="n">rect</span><span class="o">.</span><span class="n">tl</span> <span class="o">+</span> <span class="n">rect</span><span class="o">.</span><span class="n">br</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span>  <span class="c1"># its middle point, becomes top-left of clip</span>
<span class="n">clip</span> <span class="o">=</span> <span class="n">fitz</span><span class="o">.</span><span class="n">Rect</span><span class="p">(</span><span class="n">mp</span><span class="p">,</span> <span class="n">rect</span><span class="o">.</span><span class="n">br</span><span class="p">)</span>  <span class="c1"># the area we want</span>
<span class="n">pix</span> <span class="o">=</span> <span class="n">page</span><span class="o">.</span><span class="n">get_pixmap</span><span class="p">(</span><span class="n">matrix</span><span class="o">=</span><span class="n">mat</span><span class="p">,</span> <span class="n">clip</span><span class="o">=</span><span class="n">clip</span><span class="p">)</span>
</pre></div>
</div>
<p>In the above we construct <em>clip</em> by specifying two diagonally opposite points: the middle point <em>mp</em> of the page rectangle, and its bottom right, <em>rect.br</em>.</p>
</div>
<hr class="docutils" />
<div class="section" id="how-to-create-or-suppress-annotation-images">
<h3>How to Create or Suppress Annotation Images<a class="headerlink" href="#how-to-create-or-suppress-annotation-images" title="Permalink to this headline">¶</a></h3>
<p>Normally, the pixmap of a page also shows the page’s annotations. Occasionally, this may not be desirable.</p>
<p>To suppress the annotation images on a rendered page, just specify <em>annots=False</em> in <a class="reference internal" href="page.html#Page.get_pixmap" title="Page.get_pixmap"><code class="xref py py-meth docutils literal notranslate"><span class="pre">Page.get_pixmap()</span></code></a>.</p>
<p>You can also render annotations separately: <a class="reference internal" href="annot.html#annot"><span class="std std-ref">Annot</span></a> objects have their own <a class="reference internal" href="annot.html#Annot.get_pixmap" title="Annot.get_pixmap"><code class="xref py py-meth docutils literal notranslate"><span class="pre">Annot.get_pixmap()</span></code></a> method. The resulting pixmap has the same dimensions as the annotation rectangle.</p>
<hr class="docutils" />
</div>
<div class="section" id="how-to-extract-images-non-pdf-documents">
<span id="index-4"></span><h3>How to Extract Images: Non-PDF Documents<a class="headerlink" href="#how-to-extract-images-non-pdf-documents" title="Permalink to this headline">¶</a></h3>
<p>In contrast to the previous sections, this section deals with <strong>extracting</strong> images <strong>contained</strong> in documents, so they can be displayed as part of one or more pages.</p>
<p>If you want recreate the original image in file form or as a memory area, you have basically two options:</p>
<ol class="arabic">
<li><p>Convert your document to a PDF, and then use one of the PDF-only extraction methods. This snippet will convert a document to PDF:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">pdfbytes</span> <span class="o">=</span> <span class="n">doc</span><span class="o">.</span><span class="n">convert_to_pdf</span><span class="p">()</span>  <span class="c1"># this a bytes object</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">pdf</span> <span class="o">=</span> <span class="n">fitz</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="s2">&quot;pdf&quot;</span><span class="p">,</span> <span class="n">pdfbytes</span><span class="p">)</span>  <span class="c1"># open it as a PDF document</span>
<span class="gp">&gt;&gt;&gt; </span><span class="c1"># now use &#39;pdf&#39; like any PDF document</span>
</pre></div>
</div>
</li>
<li><p>Use <a class="reference internal" href="page.html#Page.get_text" title="Page.get_text"><code class="xref py py-meth docutils literal notranslate"><span class="pre">Page.get_text()</span></code></a> with the “dict” parameter. This will extract all text and images shown on the page, formatted as a Python dictionary. Every image will occur in an image block, containing meta information and the binary image data. For details of the dictionary’s structure, see <a class="reference internal" href="textpage.html#textpage"><span class="std std-ref">TextPage</span></a>. The method works equally well for PDF files. This creates a list of all images shown on a page:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">d</span> <span class="o">=</span> <span class="n">page</span><span class="o">.</span><span class="n">get_text</span><span class="p">(</span><span class="s2">&quot;dict&quot;</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">blocks</span> <span class="o">=</span> <span class="n">d</span><span class="p">[</span><span class="s2">&quot;blocks&quot;</span><span class="p">]</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">imgblocks</span> <span class="o">=</span> <span class="p">[</span><span class="n">b</span> <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="n">blocks</span> <span class="k">if</span> <span class="n">b</span><span class="p">[</span><span class="s2">&quot;type&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">]</span>
</pre></div>
</div>
</li>
</ol>
<p>Each item if “imgblocks” is a dictionary which looks like this:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="p">{</span><span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;bbox&quot;</span><span class="p">:</span> <span class="p">(</span><span class="n">x0</span><span class="p">,</span> <span class="n">y0</span><span class="p">,</span> <span class="n">x1</span><span class="p">,</span> <span class="n">y1</span><span class="p">),</span> <span class="s2">&quot;width&quot;</span><span class="p">:</span> <span class="n">w</span><span class="p">,</span> <span class="s2">&quot;height&quot;</span><span class="p">:</span> <span class="n">h</span><span class="p">,</span> <span class="s2">&quot;ext&quot;</span><span class="p">:</span> <span class="s2">&quot;png&quot;</span><span class="p">,</span> <span class="s2">&quot;image&quot;</span><span class="p">:</span> <span class="sa">b</span><span class="s2">&quot;...&quot;</span><span class="p">}</span>
</pre></div>
</div>
<hr class="docutils" />
</div>
<div class="section" id="how-to-extract-images-pdf-documents">
<span id="index-5"></span><h3>How to Extract Images: PDF Documents<a class="headerlink" href="#how-to-extract-images-pdf-documents" title="Permalink to this headline">¶</a></h3>
<p>Like any other “object” in a PDF, images are identified by a cross reference number (<a class="reference internal" href="glossary.html#xref" title="xref"><code class="xref py py-data docutils literal notranslate"><span class="pre">xref</span></code></a>, an integer). If you know this number, you have two ways to access the image’s data:</p>
<ol class="arabic simple">
<li><p><strong>Create</strong> a <a class="reference internal" href="pixmap.html#pixmap"><span class="std std-ref">Pixmap</span></a> of the image with instruction <em>pix = fitz.Pixmap(doc, xref)</em>. This method is <strong>very</strong> fast (single digit micro-seconds). The pixmap’s properties (width, height, …) will reflect the ones of the image. In this case there is no way to tell which image format the embedded original has.</p></li>
<li><p><strong>Extract</strong> the image with <em>img = doc.extract_image(xref)</em>. This is a dictionary containing the binary image data as <em>img[“image”]</em>. A number of meta data are also provided – mostly the same as you would find in the pixmap of the image. The major difference is string <em>img[“ext”]</em>, which specifies the image format: apart from “png”, strings like “jpeg”, “bmp”, “tiff”, etc. can also occur. Use this string as the file extension if you want to store to disk. The execution speed of this method should be compared to the combined speed of the statements <em>pix = fitz.Pixmap(doc, xref);pix.getPNGData()</em>. If the embedded image is in PNG format, the speed of <a class="reference internal" href="functions.html#Document.extract_image" title="Document.extract_image"><code class="xref py py-meth docutils literal notranslate"><span class="pre">Document.extract_image()</span></code></a> is about the same (and the binary image data are identical). Otherwise, this method is <strong>thousands of times faster</strong>, and the <strong>image data is much smaller</strong>.</p></li>
</ol>
<p>The question remains: <strong>“How do I know those ‘xref’ numbers of images?”</strong>. There are two answers to this:</p>
<ol class="loweralpha simple">
<li><p><strong>“Inspect the page objects:”</strong> Loop through the items of <a class="reference internal" href="page.html#Page.get_images" title="Page.get_images"><code class="xref py py-meth docutils literal notranslate"><span class="pre">Page.get_images()</span></code></a>. It is a list of list, and its items look like <em>[xref, smask, …]</em>, containing the <a class="reference internal" href="glossary.html#xref" title="xref"><code class="xref py py-data docutils literal notranslate"><span class="pre">xref</span></code></a> of an image. This <a class="reference internal" href="glossary.html#xref" title="xref"><code class="xref py py-data docutils literal notranslate"><span class="pre">xref</span></code></a> can then be used with one of the above methods. Use this method for <strong>valid (undamaged)</strong> documents. Be wary however, that the same image may be referenced multiple times (by different pages), so you might want to provide a mechanism avoiding multiple extracts.</p></li>
<li><p><strong>“No need to know:”</strong> Loop through the list of <strong>all xrefs</strong> of the document and perform a <a class="reference internal" href="functions.html#Document.extract_image" title="Document.extract_image"><code class="xref py py-meth docutils literal notranslate"><span class="pre">Document.extract_image()</span></code></a> for each one. If the returned dictionary is empty, then continue – this <a class="reference internal" href="glossary.html#xref" title="xref"><code class="xref py py-data docutils literal notranslate"><span class="pre">xref</span></code></a> is no image. Use this method if the PDF is <strong>damaged (unusable pages)</strong>. Note that a PDF often contains “pseudo-images” (“stencil masks”) with the special purpose of defining the transparency of some other image. You may want to provide logic to exclude those from extraction. Also have a look at the next section.</p></li>
</ol>
<p>For both extraction approaches, there exist ready-to-use general purpose scripts:</p>
<p><a class="reference external" href="https://github.com/JorjMcKie/PyMuPDF-Utilities/blob/master/extract-imga.py">extract-imga.py</a> extracts images page by page:</p>
<a class="reference internal image-reference" href="_images/img-extract-imga.jpg"><img alt="_images/img-extract-imga.jpg" src="_images/img-extract-imga.jpg" style="width: 263.2px; height: 228.8px;" /></a>
<p>and <a class="reference external" href="https://github.com/JorjMcKie/PyMuPDF-Utilities/blob/master/extract-imgb.py">extract-imgb.py</a> extracts images by xref table:</p>
<a class="reference internal image-reference" href="_images/img-extract-imgb.jpg"><img alt="_images/img-extract-imgb.jpg" src="_images/img-extract-imgb.jpg" style="width: 262.40000000000003px; height: 229.60000000000002px;" /></a>
</div>
<hr class="docutils" />
<div class="section" id="how-to-handle-stencil-masks">
<h3>How to Handle Stencil Masks<a class="headerlink" href="#how-to-handle-stencil-masks" title="Permalink to this headline">¶</a></h3>
<p>Some images in PDFs are accompanied by <strong>stencil masks</strong>. In their simplest form stencil masks represent alpha (transparency) bytes stored as separate images. In order to reconstruct the original of an image, which has a stencil mask, it must be “enriched” with transparency bytes taken from its stencil mask.</p>
<p>Whether an image does have such a stencil mask can be recognized in one of two ways in PyMuPDF:</p>
<ol class="arabic simple">
<li><p>An item of <a class="reference internal" href="document.html#Document.get_page_images" title="Document.get_page_images"><code class="xref py py-meth docutils literal notranslate"><span class="pre">Document.get_page_images()</span></code></a> has the general format <em>[xref, smask, …]</em>, where <em>xref</em> is the image’s <a class="reference internal" href="glossary.html#xref" title="xref"><code class="xref py py-data docutils literal notranslate"><span class="pre">xref</span></code></a> and <em>smask</em>, if positive, is the <a class="reference internal" href="glossary.html#xref" title="xref"><code class="xref py py-data docutils literal notranslate"><span class="pre">xref</span></code></a> of a stencil mask.</p></li>
<li><p>The (dictionary) results of <a class="reference internal" href="functions.html#Document.extract_image" title="Document.extract_image"><code class="xref py py-meth docutils literal notranslate"><span class="pre">Document.extract_image()</span></code></a> have a key <em>“smask”</em>, which also contains any stencil mask’s <a class="reference internal" href="glossary.html#xref" title="xref"><code class="xref py py-data docutils literal notranslate"><span class="pre">xref</span></code></a> if positive.</p></li>
</ol>
<p>If <em>smask == 0</em> then the image encountered via <a class="reference internal" href="glossary.html#xref" title="xref"><code class="xref py py-data docutils literal notranslate"><span class="pre">xref</span></code></a> can be processed as it is.</p>
<p>To recover the original image using PyMuPDF, the procedure depicted as follows must be executed:</p>
<a class="reference internal image-reference" href="_images/img-stencil.jpg"><img alt="_images/img-stencil.jpg" src="_images/img-stencil.jpg" style="width: 394.8px; height: 203.4px;" /></a>
<div class="doctest highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">pix1</span> <span class="o">=</span> <span class="n">fitz</span><span class="o">.</span><span class="n">Pixmap</span><span class="p">(</span><span class="n">doc</span><span class="p">,</span> <span class="n">xref</span><span class="p">)</span>    <span class="c1"># (1) pixmap of image w/o alpha</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">pix2</span> <span class="o">=</span> <span class="n">fitz</span><span class="o">.</span><span class="n">Pixmap</span><span class="p">(</span><span class="n">doc</span><span class="p">,</span> <span class="n">smask</span><span class="p">)</span>   <span class="c1"># (2) stencil pixmap</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">pix</span> <span class="o">=</span> <span class="n">fitz</span><span class="o">.</span><span class="n">Pixmap</span><span class="p">(</span><span class="n">pix1</span><span class="p">)</span>          <span class="c1"># (3) copy of pix1, empty alpha channel added</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">pix</span><span class="o">.</span><span class="n">setAlpha</span><span class="p">(</span><span class="n">pix2</span><span class="o">.</span><span class="n">samples</span><span class="p">)</span>       <span class="c1"># (4) fill alpha channel</span>
</pre></div>
</div>
<p>Step (1) creates a pixmap of the “netto” image. Step (2) does the same with the stencil mask. Please note that the <a class="reference internal" href="pixmap.html#Pixmap.samples" title="Pixmap.samples"><code class="xref py py-attr docutils literal notranslate"><span class="pre">Pixmap.samples</span></code></a> attribute of <em>pix2</em> contains the alpha bytes that must be stored in the final pixmap. This is what happens in step (3) and (4).</p>
<p>The scripts <a class="reference external" href="https://github.com/JorjMcKie/PyMuPDF-Utilities/blob/master/extract-imga.py">extract-imga.py</a>, and <a class="reference external" href="https://github.com/JorjMcKie/PyMuPDF-Utilities/blob/master/extract-imgb.py">extract-imgb.py</a> above also contain this logic.</p>
<hr class="docutils" />
</div>
<div class="section" id="how-to-make-one-pdf-of-all-your-pictures-or-files">
<span id="index-6"></span><h3>How to Make one PDF of all your Pictures (or Files)<a class="headerlink" href="#how-to-make-one-pdf-of-all-your-pictures-or-files" title="Permalink to this headline">¶</a></h3>
<p>We show here <strong>three scripts</strong> that take a list of (image and other) files and put them all in one PDF.</p>
<p><strong>Method 1: Inserting Images as Pages</strong></p>
<p>The first one converts each image to a PDF page with the same dimensions. The result will be a PDF with one page per image. It will only work for supported image file formats:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">os</span><span class="o">,</span> <span class="nn">fitz</span>
<span class="kn">import</span> <span class="nn">PySimpleGUI</span> <span class="k">as</span> <span class="nn">psg</span>  <span class="c1"># for showing a progress bar</span>
<span class="n">doc</span> <span class="o">=</span> <span class="n">fitz</span><span class="o">.</span><span class="n">open</span><span class="p">()</span>  <span class="c1"># PDF with the pictures</span>
<span class="n">imgdir</span> <span class="o">=</span> <span class="s2">&quot;D:/2012_10_05&quot;</span>  <span class="c1"># where the pics are</span>
<span class="n">imglist</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">imgdir</span><span class="p">)</span>  <span class="c1"># list of them</span>
<span class="n">imgcount</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">imglist</span><span class="p">)</span>  <span class="c1"># pic count</span>

<span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">f</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">imglist</span><span class="p">):</span>
    <span class="n">img</span> <span class="o">=</span> <span class="n">fitz</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">imgdir</span><span class="p">,</span> <span class="n">f</span><span class="p">))</span>  <span class="c1"># open pic as document</span>
    <span class="n">rect</span> <span class="o">=</span> <span class="n">img</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">rect</span>  <span class="c1"># pic dimension</span>
    <span class="n">pdfbytes</span> <span class="o">=</span> <span class="n">img</span><span class="o">.</span><span class="n">convert_to_pdf</span><span class="p">()</span>  <span class="c1"># make a PDF stream</span>
    <span class="n">img</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>  <span class="c1"># no longer needed</span>
    <span class="n">imgPDF</span> <span class="o">=</span> <span class="n">fitz</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="s2">&quot;pdf&quot;</span><span class="p">,</span> <span class="n">pdfbytes</span><span class="p">)</span>  <span class="c1"># open stream as PDF</span>
    <span class="n">page</span> <span class="o">=</span> <span class="n">doc</span><span class="o">.</span><span class="n">new_page</span><span class="p">(</span><span class="n">width</span> <span class="o">=</span> <span class="n">rect</span><span class="o">.</span><span class="n">width</span><span class="p">,</span>  <span class="c1"># new page with ...</span>
                       <span class="n">height</span> <span class="o">=</span> <span class="n">rect</span><span class="o">.</span><span class="n">height</span><span class="p">)</span>  <span class="c1"># pic dimension</span>
    <span class="n">page</span><span class="o">.</span><span class="n">show_pdf_page</span><span class="p">(</span><span class="n">rect</span><span class="p">,</span> <span class="n">imgPDF</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>  <span class="c1"># image fills the page</span>
    <span class="n">psg</span><span class="o">.</span><span class="n">EasyProgressMeter</span><span class="p">(</span><span class="s2">&quot;Import Images&quot;</span><span class="p">,</span>  <span class="c1"># show our progress</span>
        <span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">imgcount</span><span class="p">)</span>

<span class="n">doc</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="s2">&quot;all-my-pics.pdf&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p>This will generate a PDF only marginally larger than the combined pictures’ size. Some numbers on performance:</p>
<p>The above script needed about 1 minute on my machine for 149 pictures with a total size of 514 MB (and about the same resulting PDF size).</p>
<a class="reference internal image-reference" href="_images/img-import-progress.jpg"><img alt="_images/img-import-progress.jpg" src="_images/img-import-progress.jpg" style="width: 264.0px; height: 217.60000000000002px;" /></a>
<p>Look <a class="reference external" href="https://github.com/JorjMcKie/PyMuPDF-Utilities/blob/master/all-my-pics-inserted.py">here</a> for a more complete source code: it offers a directory selection dialog and skips unsupported files and non-file entries.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>We might have used <a class="reference internal" href="page.html#Page.insert_image" title="Page.insert_image"><code class="xref py py-meth docutils literal notranslate"><span class="pre">Page.insert_image()</span></code></a> instead of <a class="reference internal" href="page.html#Page.show_pdf_page" title="Page.show_pdf_page"><code class="xref py py-meth docutils literal notranslate"><span class="pre">Page.show_pdf_page()</span></code></a>, and the result would have been a similar looking file. However, depending on the image type, it may store <strong>images uncompressed</strong>. Therefore, the save option <em>deflate = True</em> must be used to achieve a reasonable file size, which hugely increases the runtime for large numbers of images. So this alternative <strong>cannot be recommended</strong> here.</p>
</div>
<p><strong>Method 2: Embedding Files</strong></p>
<p>The second script <strong>embeds</strong> arbitrary files – not only images. The resulting PDF will have just one (empty) page, required for technical reasons. To later access the embedded files again, you would need a suitable PDF viewer that can display and / or extract embedded files:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">os</span><span class="o">,</span> <span class="nn">fitz</span>
<span class="kn">import</span> <span class="nn">PySimpleGUI</span> <span class="k">as</span> <span class="nn">psg</span>  <span class="c1"># for showing progress bar</span>
<span class="n">doc</span> <span class="o">=</span> <span class="n">fitz</span><span class="o">.</span><span class="n">open</span><span class="p">()</span>  <span class="c1"># PDF with the pictures</span>
<span class="n">imgdir</span> <span class="o">=</span> <span class="s2">&quot;D:/2012_10_05&quot;</span>  <span class="c1"># where my files are</span>

<span class="n">imglist</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">imgdir</span><span class="p">)</span>  <span class="c1"># list of pictures</span>
<span class="n">imgcount</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">imglist</span><span class="p">)</span>  <span class="c1"># pic count</span>
<span class="n">imglist</span><span class="o">.</span><span class="n">sort</span><span class="p">()</span>  <span class="c1"># nicely sort them</span>

<span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">f</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">imglist</span><span class="p">):</span>
    <span class="n">img</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">imgdir</span><span class="p">,</span><span class="n">f</span><span class="p">),</span> <span class="s2">&quot;rb&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>  <span class="c1"># make pic stream</span>
    <span class="n">doc</span><span class="o">.</span><span class="n">embfile_add</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="n">filename</span><span class="o">=</span><span class="n">f</span><span class="p">,</span>  <span class="c1"># and embed it</span>
                        <span class="n">ufilename</span><span class="o">=</span><span class="n">f</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="n">f</span><span class="p">)</span>
    <span class="n">psg</span><span class="o">.</span><span class="n">EasyProgressMeter</span><span class="p">(</span><span class="s2">&quot;Embedding Files&quot;</span><span class="p">,</span>  <span class="c1"># show our progress</span>
        <span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">imgcount</span><span class="p">)</span>

<span class="n">page</span> <span class="o">=</span> <span class="n">doc</span><span class="o">.</span><span class="n">new_page</span><span class="p">()</span>  <span class="c1"># at least 1 page is needed</span>

<span class="n">doc</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="s2">&quot;all-my-pics-embedded.pdf&quot;</span><span class="p">)</span>
</pre></div>
</div>
<a class="reference internal image-reference" href="_images/img-embed-progress.jpg"><img alt="_images/img-embed-progress.jpg" src="_images/img-embed-progress.jpg" style="width: 265.6px; height: 219.20000000000002px;" /></a>
<p>This is by far the fastest method, and it also produces the smallest possible output file size. The above pictures needed 20 seconds on my machine and yielded a PDF size of 510 MB. Look <a class="reference external" href="https://github.com/JorjMcKie/PyMuPDF-Utilities/blob/master/all-my-pics-embedded.py">here</a> for a more complete source code: it offers a directory selection dialog and skips non-file entries.</p>
<p><strong>Method 3: Attaching Files</strong></p>
<p>A third way to achieve this task is <strong>attaching files</strong> via page annotations see <a class="reference external" href="https://github.com/JorjMcKie/PyMuPDF-Utilities/blob/master/all-my-pics-attached.py">here</a> for the complete source code.</p>
<p>This has a similar performance as the previous script and it also produces a similar file size. It will produce PDF pages which show a ‘FileAttachment’ icon for each attached file.</p>
<img alt="_images/img-attach-result.jpg" src="_images/img-attach-result.jpg" />
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Both, the <strong>embed</strong> and the <strong>attach</strong> methods can be used for <strong>arbitrary files</strong> – not just images.</p>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>We strongly recommend using the awesome package <a class="reference external" href="https://pypi.org/project/PySimpleGUI/">PySimpleGUI</a> to display a progress meter for tasks that may run for an extended time span. It’s pure Python, uses Tkinter (no additional GUI package) and requires just one more line of code!</p>
</div>
<hr class="docutils" />
</div>
<div class="section" id="how-to-create-vector-images">
<span id="index-7"></span><h3>How to Create Vector Images<a class="headerlink" href="#how-to-create-vector-images" title="Permalink to this headline">¶</a></h3>
<p>The usual way to create an image from a document page is <a class="reference internal" href="page.html#Page.get_pixmap" title="Page.get_pixmap"><code class="xref py py-meth docutils literal notranslate"><span class="pre">Page.get_pixmap()</span></code></a>. A pixmap represents a raster image, so you must decide on its quality (i.e. resolution) at creation time. It cannot be changed later.</p>
<p>PyMuPDF also offers a way to create a <strong>vector image</strong> of a page in SVG format (scalable vector graphics, defined in XML syntax). SVG images remain precise across zooming levels (of course with the exception of any raster graphic elements embedded therein).</p>
<p>Instruction <em>svg = page.get_svg_image(matrix=fitz.Identity)</em> delivers a UTF-8 string <em>svg</em> which can be stored with extension “.svg”.</p>
<hr class="docutils" />
</div>
<div class="section" id="how-to-convert-images">
<span id="index-8"></span><h3>How to Convert Images<a class="headerlink" href="#how-to-convert-images" title="Permalink to this headline">¶</a></h3>
<p>Just as a feature among others, PyMuPDF’s image conversion is easy. It may avoid using other graphics packages like PIL/Pillow in many cases.</p>
<p>Notwithstanding that interfacing with Pillow is almost trivial.</p>
<table class="docutils align-default">
<colgroup>
<col style="width: 22%" />
<col style="width: 24%" />
<col style="width: 54%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p><strong>Input Formats</strong></p></th>
<th class="head"><p><strong>Output Formats</strong></p></th>
<th class="head"><p><strong>Description</strong></p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>BMP</p></td>
<td><p>.</p></td>
<td><p>Windows Bitmap</p></td>
</tr>
<tr class="row-odd"><td><p>JPEG</p></td>
<td><p>.</p></td>
<td><p>Joint Photographic Experts Group</p></td>
</tr>
<tr class="row-even"><td><p>JXR</p></td>
<td><p>.</p></td>
<td><p>JPEG Extended Range</p></td>
</tr>
<tr class="row-odd"><td><p>JPX</p></td>
<td><p>.</p></td>
<td><p>JPEG 2000</p></td>
</tr>
<tr class="row-even"><td><p>GIF</p></td>
<td><p>.</p></td>
<td><p>Graphics Interchange Format</p></td>
</tr>
<tr class="row-odd"><td><p>TIFF</p></td>
<td><p>.</p></td>
<td><p>Tagged Image File Format</p></td>
</tr>
<tr class="row-even"><td><p>PNG</p></td>
<td><p>PNG</p></td>
<td><p>Portable Network Graphics</p></td>
</tr>
<tr class="row-odd"><td><p>PNM</p></td>
<td><p>PNM</p></td>
<td><p>Portable Anymap</p></td>
</tr>
<tr class="row-even"><td><p>PGM</p></td>
<td><p>PGM</p></td>
<td><p>Portable Graymap</p></td>
</tr>
<tr class="row-odd"><td><p>PBM</p></td>
<td><p>PBM</p></td>
<td><p>Portable Bitmap</p></td>
</tr>
<tr class="row-even"><td><p>PPM</p></td>
<td><p>PPM</p></td>
<td><p>Portable Pixmap</p></td>
</tr>
<tr class="row-odd"><td><p>PAM</p></td>
<td><p>PAM</p></td>
<td><p>Portable Arbitrary Map</p></td>
</tr>
<tr class="row-even"><td><p>.</p></td>
<td><p>PSD</p></td>
<td><p>Adobe Photoshop Document</p></td>
</tr>
<tr class="row-odd"><td><p>.</p></td>
<td><p>PS</p></td>
<td><p>Adobe Postscript</p></td>
</tr>
</tbody>
</table>
<p>The general scheme is just the following two lines:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">pix</span> <span class="o">=</span> <span class="n">fitz</span><span class="o">.</span><span class="n">Pixmap</span><span class="p">(</span><span class="s2">&quot;input.xxx&quot;</span><span class="p">)</span>  <span class="c1"># any supported input format</span>
<span class="n">pix</span><span class="o">.</span><span class="n">writeImage</span><span class="p">(</span><span class="s2">&quot;output.yyy&quot;</span><span class="p">)</span>  <span class="c1"># any supported output format</span>
</pre></div>
</div>
<p><strong>Remarks</strong></p>
<ol class="arabic simple">
<li><p>The <strong>input</strong> argument of <em>fitz.Pixmap(arg)</em> can be a file or a bytes / io.BytesIO object containing an image.</p></li>
<li><p>Instead of an output <strong>file</strong>, you can also create a bytes object via <em>pix.getImageData(“yyy”)</em> and pass this around.</p></li>
<li><p>As a matter of course, input and output formats must be compatible in terms of colorspace and transparency. The <em>Pixmap</em> class has batteries included if adjustments are needed.</p></li>
</ol>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p><strong>Convert JPEG to Photoshop</strong>:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">pix</span> <span class="o">=</span> <span class="n">fitz</span><span class="o">.</span><span class="n">Pixmap</span><span class="p">(</span><span class="s2">&quot;myfamily.jpg&quot;</span><span class="p">)</span>
<span class="n">pix</span><span class="o">.</span><span class="n">writeImage</span><span class="p">(</span><span class="s2">&quot;myfamily.psd&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p><strong>Save to JPEG</strong> using PIL/Pillow:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">PIL</span> <span class="kn">import</span> <span class="n">Image</span>
<span class="n">pix</span> <span class="o">=</span> <span class="n">fitz</span><span class="o">.</span><span class="n">Pixmap</span><span class="p">(</span><span class="o">...</span><span class="p">)</span>
<span class="n">img</span> <span class="o">=</span> <span class="n">Image</span><span class="o">.</span><span class="n">frombytes</span><span class="p">(</span><span class="s2">&quot;RGB&quot;</span><span class="p">,</span> <span class="p">[</span><span class="n">pix</span><span class="o">.</span><span class="n">width</span><span class="p">,</span> <span class="n">pix</span><span class="o">.</span><span class="n">height</span><span class="p">],</span> <span class="n">pix</span><span class="o">.</span><span class="n">samples</span><span class="p">)</span>
<span class="n">img</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="s2">&quot;output.jpg&quot;</span><span class="p">,</span> <span class="s2">&quot;JPEG&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Convert <strong>JPEG to Tkinter PhotoImage</strong>. Any <strong>RGB / no-alpha</strong> image works exactly the same. Conversion to one of the <strong>Portable Anymap</strong> formats (PPM, PGM, etc.) does the trick, because they are supported by all Tkinter versions:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">if</span> <span class="nb">str</span> <span class="ow">is</span> <span class="nb">bytes</span><span class="p">:</span>  <span class="c1"># this is Python 2!</span>
    <span class="kn">import</span> <span class="nn">Tkinter</span> <span class="k">as</span> <span class="nn">tk</span>
<span class="k">else</span><span class="p">:</span>  <span class="c1"># Python 3 or later!</span>
    <span class="kn">import</span> <span class="nn">tkinter</span> <span class="k">as</span> <span class="nn">tk</span>
<span class="n">pix</span> <span class="o">=</span> <span class="n">fitz</span><span class="o">.</span><span class="n">Pixmap</span><span class="p">(</span><span class="s2">&quot;input.jpg&quot;</span><span class="p">)</span>  <span class="c1"># or any RGB / no-alpha image</span>
<span class="n">tkimg</span> <span class="o">=</span> <span class="n">tk</span><span class="o">.</span><span class="n">PhotoImage</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">pix</span><span class="o">.</span><span class="n">getImageData</span><span class="p">(</span><span class="s2">&quot;ppm&quot;</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Convert <strong>PNG with alpha</strong> to Tkinter PhotoImage. This requires <strong>removing the alpha bytes</strong>, before we can do the PPM conversion:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">if</span> <span class="nb">str</span> <span class="ow">is</span> <span class="nb">bytes</span><span class="p">:</span>  <span class="c1"># this is Python 2!</span>
    <span class="kn">import</span> <span class="nn">Tkinter</span> <span class="k">as</span> <span class="nn">tk</span>
<span class="k">else</span><span class="p">:</span>  <span class="c1"># Python 3 or later!</span>
    <span class="kn">import</span> <span class="nn">tkinter</span> <span class="k">as</span> <span class="nn">tk</span>
<span class="n">pix</span> <span class="o">=</span> <span class="n">fitz</span><span class="o">.</span><span class="n">Pixmap</span><span class="p">(</span><span class="s2">&quot;input.png&quot;</span><span class="p">)</span>  <span class="c1"># may have an alpha channel</span>
<span class="k">if</span> <span class="n">pix</span><span class="o">.</span><span class="n">alpha</span><span class="p">:</span>  <span class="c1"># we have an alpha channel!</span>
    <span class="n">pix</span> <span class="o">=</span> <span class="n">fitz</span><span class="o">.</span><span class="n">Pixmap</span><span class="p">(</span><span class="n">pix</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>  <span class="c1"># remove it</span>
<span class="n">tkimg</span> <span class="o">=</span> <span class="n">tk</span><span class="o">.</span><span class="n">PhotoImage</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">pix</span><span class="o">.</span><span class="n">getImageData</span><span class="p">(</span><span class="s2">&quot;ppm&quot;</span><span class="p">))</span>
</pre></div>
</div>
</div>
<hr class="docutils" />
</div>
<div class="section" id="how-to-use-pixmaps-gluing-images">
<span id="index-9"></span><h3>How to Use Pixmaps: Gluing Images<a class="headerlink" href="#how-to-use-pixmaps-gluing-images" title="Permalink to this headline">¶</a></h3>
<p>This shows how pixmaps can be used for purely graphical, non-document purposes. The script reads an image file and creates a new image which consist of 3 * 4 tiles of the original:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">fitz</span>
<span class="n">src</span> <span class="o">=</span> <span class="n">fitz</span><span class="o">.</span><span class="n">Pixmap</span><span class="p">(</span><span class="s2">&quot;img-7edges.png&quot;</span><span class="p">)</span>      <span class="c1"># create pixmap from a picture</span>
<span class="n">col</span> <span class="o">=</span> <span class="mi">3</span>                                  <span class="c1"># tiles per row</span>
<span class="n">lin</span> <span class="o">=</span> <span class="mi">4</span>                                  <span class="c1"># tiles per column</span>
<span class="n">tar_w</span> <span class="o">=</span> <span class="n">src</span><span class="o">.</span><span class="n">width</span> <span class="o">*</span> <span class="n">col</span>                  <span class="c1"># width of target</span>
<span class="n">tar_h</span> <span class="o">=</span> <span class="n">src</span><span class="o">.</span><span class="n">height</span> <span class="o">*</span> <span class="n">lin</span>                 <span class="c1"># height of target</span>

<span class="c1"># create target pixmap</span>
<span class="n">tar_pix</span> <span class="o">=</span> <span class="n">fitz</span><span class="o">.</span><span class="n">Pixmap</span><span class="p">(</span><span class="n">src</span><span class="o">.</span><span class="n">colorspace</span><span class="p">,</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">tar_w</span><span class="p">,</span> <span class="n">tar_h</span><span class="p">),</span> <span class="n">src</span><span class="o">.</span><span class="n">alpha</span><span class="p">)</span>

<span class="c1"># now fill target with the tiles</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">col</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">lin</span><span class="p">):</span>
        <span class="n">src</span><span class="o">.</span><span class="n">setOrigin</span><span class="p">(</span><span class="n">src</span><span class="o">.</span><span class="n">width</span> <span class="o">*</span> <span class="n">i</span><span class="p">,</span> <span class="n">src</span><span class="o">.</span><span class="n">height</span> <span class="o">*</span> <span class="n">j</span><span class="p">)</span>
        <span class="n">tar_pix</span><span class="o">.</span><span class="n">copyPixmap</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="n">src</span><span class="o">.</span><span class="n">irect</span><span class="p">)</span> <span class="c1"># copy input to new loc</span>

<span class="n">tar_pix</span><span class="o">.</span><span class="n">writePNG</span><span class="p">(</span><span class="s2">&quot;tar.png&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p>This is the input picture:</p>
<a class="reference internal image-reference" href="_images/img-7edges.png"><img alt="_images/img-7edges.png" src="_images/img-7edges.png" style="width: 66.0px; height: 60.06px;" /></a>
<p>Here is the output:</p>
<a class="reference internal image-reference" href="_images/img-target.png"><img alt="_images/img-target.png" src="_images/img-target.png" style="width: 198.0px; height: 240.24px;" /></a>
<hr class="docutils" />
</div>
<div class="section" id="how-to-use-pixmaps-making-a-fractal">
<span id="index-10"></span><h3>How to Use Pixmaps: Making a Fractal<a class="headerlink" href="#how-to-use-pixmaps-making-a-fractal" title="Permalink to this headline">¶</a></h3>
<p>Here is another Pixmap example that creates <strong>Sierpinski’s Carpet</strong> – a fractal generalizing the <strong>Cantor Set</strong> to two dimensions. Given a square carpet, mark its 9 sub-suqares (3 times 3) and cut out the one in the center. Treat each of the remaining eight sub-squares in the same way, and continue <em>ad infinitum</em>. The end result is a set with area zero and fractal dimension 1.8928…</p>
<p>This script creates a approximate image of it as a PNG, by going down to one-pixel granularity. To increase the image precision, change the value of n (precision):</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">fitz</span><span class="o">,</span> <span class="nn">time</span>
<span class="k">if</span> <span class="ow">not</span> <span class="nb">list</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="n">fitz</span><span class="o">.</span><span class="n">VersionBind</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">)))</span> <span class="o">&gt;=</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">14</span><span class="p">,</span> <span class="mi">8</span><span class="p">]:</span>
    <span class="k">raise</span> <span class="ne">SystemExit</span><span class="p">(</span><span class="s2">&quot;need PyMuPDF v1.14.8 for this script&quot;</span><span class="p">)</span>
<span class="n">n</span> <span class="o">=</span> <span class="mi">6</span>                             <span class="c1"># depth (precision)</span>
<span class="n">d</span> <span class="o">=</span> <span class="mi">3</span><span class="o">**</span><span class="n">n</span>                          <span class="c1"># edge length</span>

<span class="n">t0</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">perf_counter</span><span class="p">()</span>
<span class="n">ir</span> <span class="o">=</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">d</span><span class="p">,</span> <span class="n">d</span><span class="p">)</span>                 <span class="c1"># the pixmap rectangle</span>

<span class="n">pm</span> <span class="o">=</span> <span class="n">fitz</span><span class="o">.</span><span class="n">Pixmap</span><span class="p">(</span><span class="n">fitz</span><span class="o">.</span><span class="n">csRGB</span><span class="p">,</span> <span class="n">ir</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
<span class="n">pm</span><span class="o">.</span><span class="n">setRect</span><span class="p">(</span><span class="n">pm</span><span class="o">.</span><span class="n">irect</span><span class="p">,</span> <span class="p">(</span><span class="mi">255</span><span class="p">,</span><span class="mi">255</span><span class="p">,</span><span class="mi">0</span><span class="p">))</span> <span class="c1"># fill it with some background color</span>

<span class="n">color</span> <span class="o">=</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">255</span><span class="p">)</span>               <span class="c1"># color to fill the punch holes</span>

<span class="c1"># alternatively, define a &#39;fill&#39; pixmap for the punch holes</span>
<span class="c1"># this could be anything, e.g. some photo image ...</span>
<span class="n">fill</span> <span class="o">=</span> <span class="n">fitz</span><span class="o">.</span><span class="n">Pixmap</span><span class="p">(</span><span class="n">fitz</span><span class="o">.</span><span class="n">csRGB</span><span class="p">,</span> <span class="n">ir</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span> <span class="c1"># same size as &#39;pm&#39;</span>
<span class="n">fill</span><span class="o">.</span><span class="n">setRect</span><span class="p">(</span><span class="n">fill</span><span class="o">.</span><span class="n">irect</span><span class="p">,</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">255</span><span class="p">,</span> <span class="mi">255</span><span class="p">))</span>   <span class="c1"># put some color in</span>

<span class="k">def</span> <span class="nf">punch</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">step</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Recursively &quot;punch a hole&quot; in the central square of a pixmap.</span>

<span class="sd">    Arguments are top-left coords and the step width.</span>

<span class="sd">    Some alternative punching methods are commented out.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">s</span> <span class="o">=</span> <span class="n">step</span> <span class="o">//</span> <span class="mi">3</span>                 <span class="c1"># the new step</span>
    <span class="c1"># iterate through the 9 sub-squares</span>
    <span class="c1"># the central one will be filled with the color</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">i</span> <span class="o">!=</span> <span class="n">j</span> <span class="ow">or</span> <span class="n">i</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>  <span class="c1"># this is not the central cube</span>
                <span class="k">if</span> <span class="n">s</span> <span class="o">&gt;=</span> <span class="mi">3</span><span class="p">:</span>        <span class="c1"># recursing needed?</span>
                    <span class="n">punch</span><span class="p">(</span><span class="n">x</span><span class="o">+</span><span class="n">i</span><span class="o">*</span><span class="n">s</span><span class="p">,</span> <span class="n">y</span><span class="o">+</span><span class="n">j</span><span class="o">*</span><span class="n">s</span><span class="p">,</span> <span class="n">s</span><span class="p">)</span>       <span class="c1"># recurse</span>
            <span class="k">else</span><span class="p">:</span>                 <span class="c1"># punching alternatives are:</span>
                <span class="n">pm</span><span class="o">.</span><span class="n">setRect</span><span class="p">((</span><span class="n">x</span><span class="o">+</span><span class="n">s</span><span class="p">,</span> <span class="n">y</span><span class="o">+</span><span class="n">s</span><span class="p">,</span> <span class="n">x</span><span class="o">+</span><span class="mi">2</span><span class="o">*</span><span class="n">s</span><span class="p">,</span> <span class="n">y</span><span class="o">+</span><span class="mi">2</span><span class="o">*</span><span class="n">s</span><span class="p">),</span> <span class="n">color</span><span class="p">)</span>     <span class="c1"># fill with a color</span>
                <span class="c1">#pm.copyPixmap(fill, (x+s, y+s, x+2*s, y+2*s))  # copy from fill</span>
                <span class="c1">#pm.invertIRect((x+s, y+s, x+2*s, y+2*s))       # invert colors</span>

    <span class="k">return</span>

<span class="c1">#==============================================================================</span>
<span class="c1"># main program</span>
<span class="c1">#==============================================================================</span>
<span class="c1"># now start punching holes into the pixmap</span>
<span class="n">punch</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">d</span><span class="p">)</span>
<span class="n">t1</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">perf_counter</span><span class="p">()</span>
<span class="n">pm</span><span class="o">.</span><span class="n">writeImage</span><span class="p">(</span><span class="s2">&quot;sierpinski-punch.png&quot;</span><span class="p">)</span>
<span class="n">t2</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">perf_counter</span><span class="p">()</span>
<span class="nb">print</span> <span class="p">(</span><span class="s2">&quot;</span><span class="si">%g</span><span class="s2"> sec to create / fill the pixmap&quot;</span> <span class="o">%</span> <span class="nb">round</span><span class="p">(</span><span class="n">t1</span><span class="o">-</span><span class="n">t0</span><span class="p">,</span><span class="mi">3</span><span class="p">))</span>
<span class="nb">print</span> <span class="p">(</span><span class="s2">&quot;</span><span class="si">%g</span><span class="s2"> sec to save the image&quot;</span> <span class="o">%</span> <span class="nb">round</span><span class="p">(</span><span class="n">t2</span><span class="o">-</span><span class="n">t1</span><span class="p">,</span><span class="mi">3</span><span class="p">))</span>
</pre></div>
</div>
<p>The result should look something like this:</p>
<a class="reference internal image-reference" href="_images/img-sierpinski.png"><img alt="_images/img-sierpinski.png" src="_images/img-sierpinski.png" style="width: 240.57000000000002px; height: 240.57000000000002px;" /></a>
</div>
<hr class="docutils" />
<div class="section" id="how-to-interface-with-numpy">
<h3>How to Interface with NumPy<a class="headerlink" href="#how-to-interface-with-numpy" title="Permalink to this headline">¶</a></h3>
<p>This shows how to create a PNG file from a numpy array (several times faster than most other methods):</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">fitz</span>
<span class="c1">#==============================================================================</span>
<span class="c1"># create a fun-colored width * height PNG with fitz and numpy</span>
<span class="c1">#==============================================================================</span>
<span class="n">height</span> <span class="o">=</span> <span class="mi">150</span>
<span class="n">width</span>  <span class="o">=</span> <span class="mi">100</span>
<span class="n">bild</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">((</span><span class="n">height</span><span class="p">,</span> <span class="n">width</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">)</span>

<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">height</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">width</span><span class="p">):</span>
        <span class="c1"># one pixel (some fun coloring)</span>
        <span class="n">bild</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="p">[(</span><span class="n">i</span><span class="o">+</span><span class="n">j</span><span class="p">)</span><span class="o">%</span><span class="mi">256</span><span class="p">,</span> <span class="n">i</span><span class="o">%</span><span class="mi">256</span><span class="p">,</span> <span class="n">j</span><span class="o">%</span><span class="mi">256</span><span class="p">]</span>

<span class="n">samples</span> <span class="o">=</span> <span class="nb">bytearray</span><span class="p">(</span><span class="n">bild</span><span class="o">.</span><span class="n">tostring</span><span class="p">())</span>    <span class="c1"># get plain pixel data from numpy array</span>
<span class="n">pix</span> <span class="o">=</span> <span class="n">fitz</span><span class="o">.</span><span class="n">Pixmap</span><span class="p">(</span><span class="n">fitz</span><span class="o">.</span><span class="n">csRGB</span><span class="p">,</span> <span class="n">width</span><span class="p">,</span> <span class="n">height</span><span class="p">,</span> <span class="n">samples</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="n">pix</span><span class="o">.</span><span class="n">writePNG</span><span class="p">(</span><span class="s2">&quot;test.png&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<hr class="docutils" />
<div class="section" id="how-to-add-images-to-a-pdf-page">
<h3>How to Add Images to a PDF Page<a class="headerlink" href="#how-to-add-images-to-a-pdf-page" title="Permalink to this headline">¶</a></h3>
<p>There are two methods to add images to a PDF page: <a class="reference internal" href="page.html#Page.insert_image" title="Page.insert_image"><code class="xref py py-meth docutils literal notranslate"><span class="pre">Page.insert_image()</span></code></a> and <a class="reference internal" href="page.html#Page.show_pdf_page" title="Page.show_pdf_page"><code class="xref py py-meth docutils literal notranslate"><span class="pre">Page.show_pdf_page()</span></code></a>. Both methods have things in common, but there also exist differences.</p>
<table class="docutils align-default">
<colgroup>
<col style="width: 28%" />
<col style="width: 34%" />
<col style="width: 38%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p><strong>Criterion</strong></p></th>
<th class="head"><p><a class="reference internal" href="page.html#Page.insert_image" title="Page.insert_image"><code class="xref py py-meth docutils literal notranslate"><span class="pre">Page.insert_image()</span></code></a></p></th>
<th class="head"><p><a class="reference internal" href="page.html#Page.show_pdf_page" title="Page.show_pdf_page"><code class="xref py py-meth docutils literal notranslate"><span class="pre">Page.show_pdf_page()</span></code></a></p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>displayable content</p></td>
<td><p>image file, image in memory, pixmap</p></td>
<td><p>PDF page</p></td>
</tr>
<tr class="row-odd"><td><p>display resolution</p></td>
<td><p>image resolution</p></td>
<td><p>vectorized (except raster page content)</p></td>
</tr>
<tr class="row-even"><td><p>rotation</p></td>
<td><p>multiple of 90 degrees</p></td>
<td><p>any angle</p></td>
</tr>
<tr class="row-odd"><td><p>clipping</p></td>
<td><p>no (full image only)</p></td>
<td><p>yes</p></td>
</tr>
<tr class="row-even"><td><p>keep aspect ratio</p></td>
<td><p>yes (default option)</p></td>
<td><p>yes (default option)</p></td>
</tr>
<tr class="row-odd"><td><p>transparency (water marking)</p></td>
<td><p>depends on image</p></td>
<td><p>yes</p></td>
</tr>
<tr class="row-even"><td><p>location / placement</p></td>
<td><p>scaled to fit target rectangle</p></td>
<td><p>scaled to fit target rectangle</p></td>
</tr>
<tr class="row-odd"><td><p>performance</p></td>
<td><p>automatic prevention of duplicates;
MD5 calculation on every execution</p></td>
<td><p>automatic prevention of duplicates;
faster than <a class="reference internal" href="page.html#Page.insert_image" title="Page.insert_image"><code class="xref py py-meth docutils literal notranslate"><span class="pre">Page.insert_image()</span></code></a></p></td>
</tr>
<tr class="row-even"><td><p>multi-page image support</p></td>
<td><p>no</p></td>
<td><p>yes</p></td>
</tr>
<tr class="row-odd"><td><p>ease of use</p></td>
<td><p>simple, intuitive;
performance considerations apply
for multiple insertions of same image</p></td>
<td><p>simple, intuitive;
<strong>usable for all document types</strong>
(including images!) after conversion to
PDF via <a class="reference internal" href="document.html#Document.convert_to_pdf" title="Document.convert_to_pdf"><code class="xref py py-meth docutils literal notranslate"><span class="pre">Document.convert_to_pdf()</span></code></a></p></td>
</tr>
</tbody>
</table>
<p>Basic code pattern for <a class="reference internal" href="page.html#Page.insert_image" title="Page.insert_image"><code class="xref py py-meth docutils literal notranslate"><span class="pre">Page.insert_image()</span></code></a>. <strong>Exactly one</strong> of the parameters <strong>filename / stream / pixmap</strong> must be given:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">page</span><span class="o">.</span><span class="n">insert_image</span><span class="p">(</span>
    <span class="n">rect</span><span class="p">,</span>                  <span class="c1"># where to place the image (rect-like)</span>
    <span class="n">filename</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>         <span class="c1"># image in a file</span>
    <span class="n">stream</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>           <span class="c1"># image in memory (bytes)</span>
    <span class="n">pixmap</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>           <span class="c1"># image from pixmap</span>
    <span class="n">rotate</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>              <span class="c1"># rotate (int, multiple of 90)</span>
    <span class="n">keep_proportion</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>  <span class="c1"># keep aspect ratio</span>
    <span class="n">overlay</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>          <span class="c1"># put in foreground</span>
<span class="p">)</span>
</pre></div>
</div>
<p>Basic code pattern for <a class="reference internal" href="page.html#Page.show_pdf_page" title="Page.show_pdf_page"><code class="xref py py-meth docutils literal notranslate"><span class="pre">Page.show_pdf_page()</span></code></a>. Source and target PDF must be different <a class="reference internal" href="document.html#document"><span class="std std-ref">Document</span></a> objects (but may be opened from the same file):</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">page</span><span class="o">.</span><span class="n">show_pdf_page</span><span class="p">(</span>
    <span class="n">rect</span><span class="p">,</span>                  <span class="c1"># where to place the image (rect-like)</span>
    <span class="n">src</span><span class="p">,</span>                   <span class="c1"># source PDF</span>
    <span class="n">pno</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>                 <span class="c1"># page number in source PDF</span>
    <span class="n">clip</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>             <span class="c1"># only display this area (rect-like)</span>
    <span class="n">rotate</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>              <span class="c1"># rotate (float, any value)</span>
    <span class="n">keep_proportion</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>  <span class="c1"># keep aspect ratio</span>
    <span class="n">overlay</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>          <span class="c1"># put in foreground</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="text">
<h2>Text<a class="headerlink" href="#text" title="Permalink to this headline">¶</a></h2>
<hr class="docutils" />
<div class="section" id="how-to-extract-all-document-text">
<h3>How to Extract all Document Text<a class="headerlink" href="#how-to-extract-all-document-text" title="Permalink to this headline">¶</a></h3>
<p>This script will take a document filename and generate a text file from all of its text.</p>
<p>The document can be any supported type like PDF, XPS, etc.</p>
<p>The script works as a command line tool which expects the document filename supplied as a parameter. It generates one text file named “filename.txt” in the script directory. Text of pages is separated by a form feed character:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">sys</span><span class="o">,</span> <span class="nn">fitz</span>
<span class="n">fname</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>  <span class="c1"># get document filename</span>
<span class="n">doc</span> <span class="o">=</span> <span class="n">fitz</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">fname</span><span class="p">)</span>  <span class="c1"># open document</span>
<span class="n">out</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">fname</span> <span class="o">+</span> <span class="s2">&quot;.txt&quot;</span><span class="p">,</span> <span class="s2">&quot;wb&quot;</span><span class="p">)</span>  <span class="c1"># open text output</span>
<span class="k">for</span> <span class="n">page</span> <span class="ow">in</span> <span class="n">doc</span><span class="p">:</span>  <span class="c1"># iterate the document pages</span>
    <span class="n">text</span> <span class="o">=</span> <span class="n">page</span><span class="o">.</span><span class="n">get_text</span><span class="p">()</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s2">&quot;utf8&quot;</span><span class="p">)</span>  <span class="c1"># get plain text (is in UTF-8)</span>
    <span class="n">out</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">text</span><span class="p">)</span>  <span class="c1"># write text of page</span>
    <span class="n">out</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="nb">bytes</span><span class="p">((</span><span class="mi">12</span><span class="p">,)))</span>  <span class="c1"># write page delimiter (form feed 0x0C)</span>
<span class="n">out</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</pre></div>
</div>
<p>The output will be plain text as it is coded in the document. No effort is made to prettify in any way. Specifically for PDF, this may mean output not in usual reading order, unexpected line breaks and so forth.</p>
<p>You have many options to cure this – see chapter <a class="reference internal" href="app2.html#appendix2"><span class="std std-ref">Appendix 2: Details on Text Extraction</span></a>. Among them are:</p>
<ol class="arabic simple">
<li><p>Extract text in HTML format and store it as a HTML document, so it can be viewed in any browser.</p></li>
<li><p>Extract text as a list of text blocks via <em>Page.get_text(“blocks”)</em>. Each item of this list contains position information for its text, which can be used to establish a convenient reading order.</p></li>
<li><p>Extract a list of single words via <em>Page.get_text(“words”)</em>. Its items are words with position information. Use it to determine text contained in a given rectangle – see next section.</p></li>
</ol>
<p>See the following two section for examples and further explanations.</p>
</div>
<div class="section" id="how-to-extract-text-from-within-a-rectangle">
<span id="index-11"></span><h3>How to Extract Text from within a Rectangle<a class="headerlink" href="#how-to-extract-text-from-within-a-rectangle" title="Permalink to this headline">¶</a></h3>
<p>There is now (v1.18.0) more than one way to achieve this. We therefore have created a <a class="reference external" href="https://github.com/pymupdf/PyMuPDF-Utilities/tree/master/textbox-extraction">folder</a> in the PyMuPDF-Utilities repository specifically dealing with this topic.</p>
<hr class="docutils" />
</div>
<div class="section" id="how-to-extract-text-in-natural-reading-order">
<span id="index-12"></span><h3>How to Extract Text in Natural Reading Order<a class="headerlink" href="#how-to-extract-text-in-natural-reading-order" title="Permalink to this headline">¶</a></h3>
<p>One of the common issues with PDF text extraction is, that text may not appear in any particular reading order.</p>
<p>Responsible for this effect is the PDF creator (software or a human). For example, page headers may have been inserted in a separate step – after the document had been produced. In such a case, the header text will appear at the end of a page text extraction (although it will be correctly shown by PDF viewer software). For example, the following snippet will add some header and footer lines to an existing PDF:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">doc</span> <span class="o">=</span> <span class="n">fitz</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="s2">&quot;some.pdf&quot;</span><span class="p">)</span>
<span class="n">header</span> <span class="o">=</span> <span class="s2">&quot;Header&quot;</span>  <span class="c1"># text in header</span>
<span class="n">footer</span> <span class="o">=</span> <span class="s2">&quot;Page </span><span class="si">%i</span><span class="s2"> of </span><span class="si">%i</span><span class="s2">&quot;</span>  <span class="c1"># text in footer</span>
<span class="k">for</span> <span class="n">page</span> <span class="ow">in</span> <span class="n">doc</span><span class="p">:</span>
    <span class="n">page</span><span class="o">.</span><span class="n">insert_text</span><span class="p">((</span><span class="mi">50</span><span class="p">,</span> <span class="mi">50</span><span class="p">),</span> <span class="n">header</span><span class="p">)</span>  <span class="c1"># insert header</span>
    <span class="n">page</span><span class="o">.</span><span class="n">insert_text</span><span class="p">(</span>  <span class="c1"># insert footer 50 points above page bottom</span>
        <span class="p">(</span><span class="mi">50</span><span class="p">,</span> <span class="n">page</span><span class="o">.</span><span class="n">rect</span><span class="o">.</span><span class="n">height</span> <span class="o">-</span> <span class="mi">50</span><span class="p">),</span>
        <span class="n">footer</span> <span class="o">%</span> <span class="p">(</span><span class="n">page</span><span class="o">.</span><span class="n">number</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">doc</span><span class="p">)),</span>
    <span class="p">)</span>
</pre></div>
</div>
<p>The text sequence extracted from a page modified in this way will look like this:</p>
<ol class="arabic simple">
<li><p>original text</p></li>
<li><p>header line</p></li>
<li><p>footer line</p></li>
</ol>
<p>PyMuPDF has several means to re-establish some reading sequence or even to re-generate a layout close to the original.</p>
<p>As a starting point take the above mentioned <a class="reference external" href="https://github.com/pymupdf/PyMuPDF/wiki/How-to-extract-text-from-a-rectangle">script</a> and then use the full page rectangle.</p>
<p>On rare occasions, when the PDF creator has been “over-creative”, extracted text does not even keep the correct reading sequence of <strong>single letters</strong>: instead of the two words “DELUXE PROPERTY” you might sometimes get an anagram, consisting of 8 words like “DEL”, “XE” , “P”, “OP”, “RTY”, “U”, “R” and “E”.</p>
<p>Such a PDF is also not searchable by all PDF viewers, but it is displayed correctly and looks harmless.</p>
<p>In those cases, the following function will help composing the original words of the page. The resulting list is also searchable and can be used to deliver rectangles for the found text locations:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">operator</span> <span class="kn">import</span> <span class="n">itemgetter</span>
<span class="kn">from</span> <span class="nn">itertools</span> <span class="kn">import</span> <span class="n">groupby</span>
<span class="kn">import</span> <span class="nn">fitz</span>

<span class="k">def</span> <span class="nf">recover</span><span class="p">(</span><span class="n">words</span><span class="p">,</span> <span class="n">rect</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Word recovery.</span>

<span class="sd">    Notes:</span>
<span class="sd">        Method &#39;get_textWords()&#39; does not try to recover words, if their single</span>
<span class="sd">        letters do not appear in correct lexical order. This function steps in</span>
<span class="sd">        here and creates a new list of recovered words.</span>
<span class="sd">    Args:</span>
<span class="sd">        words: list of words as created by &#39;get_textWords()&#39;</span>
<span class="sd">        rect: rectangle to consider (usually the full page)</span>
<span class="sd">    Returns:</span>
<span class="sd">        List of recovered words. Same format as &#39;get_text_words&#39;, but left out</span>
<span class="sd">        block, line and word number - a list of items of the following format:</span>
<span class="sd">        [x0, y0, x1, y1, &quot;word&quot;]</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># build my sublist of words contained in given rectangle</span>
    <span class="n">mywords</span> <span class="o">=</span> <span class="p">[</span><span class="n">w</span> <span class="k">for</span> <span class="n">w</span> <span class="ow">in</span> <span class="n">words</span> <span class="k">if</span> <span class="n">fitz</span><span class="o">.</span><span class="n">Rect</span><span class="p">(</span><span class="n">w</span><span class="p">[:</span><span class="mi">4</span><span class="p">])</span> <span class="ow">in</span> <span class="n">rect</span><span class="p">]</span>

    <span class="c1"># sort the words by lower line, then by word start coordinate</span>
    <span class="n">mywords</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="n">itemgetter</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>  <span class="c1"># sort by y1, x0 of word rectangle</span>

    <span class="c1"># build word groups on same line</span>
    <span class="n">grouped_lines</span> <span class="o">=</span> <span class="n">groupby</span><span class="p">(</span><span class="n">mywords</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="n">itemgetter</span><span class="p">(</span><span class="mi">3</span><span class="p">))</span>

    <span class="n">words_out</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># we will return this</span>

    <span class="c1"># iterate through the grouped lines</span>
    <span class="c1"># for each line coordinate (&quot;_&quot;), the list of words is given</span>
    <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">words_in_line</span> <span class="ow">in</span> <span class="n">grouped_lines</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">w</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">words_in_line</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>  <span class="c1"># store first word</span>
                <span class="n">x0</span><span class="p">,</span> <span class="n">y0</span><span class="p">,</span> <span class="n">x1</span><span class="p">,</span> <span class="n">y1</span><span class="p">,</span> <span class="n">word</span> <span class="o">=</span> <span class="n">w</span><span class="p">[:</span><span class="mi">5</span><span class="p">]</span>
                <span class="k">continue</span>

            <span class="n">r</span> <span class="o">=</span> <span class="n">fitz</span><span class="o">.</span><span class="n">Rect</span><span class="p">(</span><span class="n">w</span><span class="p">[:</span><span class="mi">4</span><span class="p">])</span>  <span class="c1"># word rect</span>

            <span class="c1"># Compute word distance threshold as 20% of width of 1 letter.</span>
            <span class="c1"># So we should be safe joining text pieces into one word if they</span>
            <span class="c1"># have a distance shorter than that.</span>
            <span class="n">threshold</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">width</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">w</span><span class="p">[</span><span class="mi">4</span><span class="p">])</span> <span class="o">/</span> <span class="mi">5</span>
            <span class="k">if</span> <span class="n">r</span><span class="o">.</span><span class="n">x0</span> <span class="o">&lt;=</span> <span class="n">x1</span> <span class="o">+</span> <span class="n">threshold</span><span class="p">:</span>  <span class="c1"># join with previous word</span>
                <span class="n">word</span> <span class="o">+=</span> <span class="n">w</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span>  <span class="c1"># add string</span>
                <span class="n">x1</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">x1</span>  <span class="c1"># new end-of-word coordinate</span>
                <span class="n">y0</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">y0</span><span class="p">,</span> <span class="n">r</span><span class="o">.</span><span class="n">y0</span><span class="p">)</span>  <span class="c1"># extend word rect upper bound</span>
                <span class="k">continue</span>

            <span class="c1"># now have a new word, output previous one</span>
            <span class="n">words_out</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">x0</span><span class="p">,</span> <span class="n">y0</span><span class="p">,</span> <span class="n">x1</span><span class="p">,</span> <span class="n">y1</span><span class="p">,</span> <span class="n">word</span><span class="p">])</span>

            <span class="c1"># store the new word</span>
            <span class="n">x0</span><span class="p">,</span> <span class="n">y0</span><span class="p">,</span> <span class="n">x1</span><span class="p">,</span> <span class="n">y1</span><span class="p">,</span> <span class="n">word</span> <span class="o">=</span> <span class="n">w</span><span class="p">[:</span><span class="mi">5</span><span class="p">]</span>

        <span class="c1"># output word waiting for completion</span>
        <span class="n">words_out</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">x0</span><span class="p">,</span> <span class="n">y0</span><span class="p">,</span> <span class="n">x1</span><span class="p">,</span> <span class="n">y1</span><span class="p">,</span> <span class="n">word</span><span class="p">])</span>

    <span class="k">return</span> <span class="n">words_out</span>

<span class="k">def</span> <span class="nf">search_for</span><span class="p">(</span><span class="n">text</span><span class="p">,</span> <span class="n">words</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Search for text in items of list of words</span>

<span class="sd">    Notes:</span>
<span class="sd">        Can be adjusted / extended in obvious ways, e.g. using regular</span>
<span class="sd">        expressions, or being case insensitive, or only looking for complete</span>
<span class="sd">        words, etc.</span>
<span class="sd">    Args:</span>
<span class="sd">        text: string to be searched for</span>
<span class="sd">        words: list of items in format delivered by &#39;get_text_words()&#39;.</span>
<span class="sd">    Returns:</span>
<span class="sd">        List of rectangles, one for each found locations.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">rect_list</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">w</span> <span class="ow">in</span> <span class="n">words</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">text</span> <span class="ow">in</span> <span class="n">w</span><span class="p">[</span><span class="mi">4</span><span class="p">]:</span>
            <span class="n">rect_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">fitz</span><span class="o">.</span><span class="n">Rect</span><span class="p">(</span><span class="n">w</span><span class="p">[:</span><span class="mi">4</span><span class="p">]))</span>

    <span class="k">return</span> <span class="n">rect_list</span>
</pre></div>
</div>
</div>
<hr class="docutils" />
<div class="section" id="how-to-extract-tables-from-documents">
<h3>How to <span class="target" id="index-13"></span>Extract Tables from Documents<a class="headerlink" href="#how-to-extract-tables-from-documents" title="Permalink to this headline">¶</a></h3>
<p>If you see a table in a document, you are not normally looking at something like an embedded Excel or other identifiable object. It usually is just text, formatted to appear as appropriate.</p>
<p>Extracting a tabular data from such a page area therefore means that you must find a way to <strong>(1)</strong> graphically indicate table and column borders, and <strong>(2)</strong> then extract text based on this information.</p>
<p>The wxPython GUI script <a class="reference external" href="https://github.com/pymupdf/PyMuPDF-Utilities/tree/master/examples/wxTableExtract.py">wxTableExtract.py</a> strives to exactly do that. You may want to have a look at it and adjust it to your liking.</p>
</div>
<hr class="docutils" />
<div class="section" id="how-to-mark-extracted-text">
<h3>How to Mark Extracted Text<a class="headerlink" href="#how-to-mark-extracted-text" title="Permalink to this headline">¶</a></h3>
<p>There is a standard search function to search for arbitrary text on a page: <a class="reference internal" href="page.html#Page.search_for" title="Page.search_for"><code class="xref py py-meth docutils literal notranslate"><span class="pre">Page.search_for()</span></code></a>. It returns a list of <a class="reference internal" href="rect.html#rect"><span class="std std-ref">Rect</span></a> objects which surround a found occurrence. These rectangles can for example be used to automatically insert annotations which visibly mark the found text.</p>
<p>This method has advantages and drawbacks. Pros are</p>
<ul class="simple">
<li><p>The search string can contain blanks and wrap across lines</p></li>
<li><p>Upper or lower case characters are treated equal</p></li>
<li><p>Word hyphenation at line ends is detected and resolved</p></li>
<li><p>return may also be a list of <a class="reference internal" href="quad.html#quad"><span class="std std-ref">Quad</span></a> objects to precisely locate text that is <strong>not parallel</strong> to either axis – using <a class="reference internal" href="quad.html#quad"><span class="std std-ref">Quad</span></a> output is also recommend, when page rotation is not zero.</p></li>
</ul>
<p>But you also have other options:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">fitz</span>

<span class="k">def</span> <span class="nf">mark_word</span><span class="p">(</span><span class="n">page</span><span class="p">,</span> <span class="n">text</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Underline each word that contains &#39;text&#39;.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">found</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">wlist</span> <span class="o">=</span> <span class="n">page</span><span class="o">.</span><span class="n">getTex</span><span class="p">(</span><span class="s2">&quot;words&quot;</span><span class="p">)</span>  <span class="c1"># make the word list</span>
    <span class="k">for</span> <span class="n">w</span> <span class="ow">in</span> <span class="n">wlist</span><span class="p">:</span>  <span class="c1"># scan through all words on page</span>
        <span class="k">if</span> <span class="n">text</span> <span class="ow">in</span> <span class="n">w</span><span class="p">[</span><span class="mi">4</span><span class="p">]:</span>  <span class="c1"># w[4] is the word&#39;s string</span>
            <span class="n">found</span> <span class="o">+=</span> <span class="mi">1</span>  <span class="c1"># count</span>
            <span class="n">r</span> <span class="o">=</span> <span class="n">fitz</span><span class="o">.</span><span class="n">Rect</span><span class="p">(</span><span class="n">w</span><span class="p">[:</span><span class="mi">4</span><span class="p">])</span>  <span class="c1"># make rect from word bbox</span>
            <span class="n">page</span><span class="o">.</span><span class="n">addUnderlineAnnot</span><span class="p">(</span><span class="n">r</span><span class="p">)</span>  <span class="c1"># underline</span>
    <span class="k">return</span> <span class="n">found</span>

<span class="n">fname</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>  <span class="c1"># filename</span>
<span class="n">text</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>  <span class="c1"># search string</span>
<span class="n">doc</span> <span class="o">=</span> <span class="n">fitz</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">fname</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;underlining words containing &#39;</span><span class="si">%s</span><span class="s2">&#39; in document &#39;</span><span class="si">%s</span><span class="s2">&#39;&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">word</span><span class="p">,</span> <span class="n">doc</span><span class="o">.</span><span class="n">name</span><span class="p">))</span>

<span class="n">new_doc</span> <span class="o">=</span> <span class="kc">False</span>  <span class="c1"># indicator if anything found at all</span>

<span class="k">for</span> <span class="n">page</span> <span class="ow">in</span> <span class="n">doc</span><span class="p">:</span>  <span class="c1"># scan through the pages</span>
    <span class="n">found</span> <span class="o">=</span> <span class="n">mark_word</span><span class="p">(</span><span class="n">page</span><span class="p">,</span> <span class="n">text</span><span class="p">)</span>  <span class="c1"># mark the page&#39;s words</span>
    <span class="k">if</span> <span class="n">found</span><span class="p">:</span>  <span class="c1"># if anything found ...</span>
        <span class="n">new_doc</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;found &#39;</span><span class="si">%s</span><span class="s2">&#39; </span><span class="si">%i</span><span class="s2"> times on page </span><span class="si">%i</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">text</span><span class="p">,</span> <span class="n">found</span><span class="p">,</span> <span class="n">page</span><span class="o">.</span><span class="n">number</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span>

<span class="k">if</span> <span class="n">new_doc</span><span class="p">:</span>
    <span class="n">doc</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="s2">&quot;marked-&quot;</span> <span class="o">+</span> <span class="n">doc</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
</pre></div>
</div>
<p>This script uses <code class="xref py py-meth docutils literal notranslate"><span class="pre">Page.get_text(&quot;words&quot;)()</span></code> to look for a string, handed in via cli parameter. This method separates a page’s text into “words” using spaces and line breaks as delimiters. Therefore the words in this lists do not contain these characters. Further remarks:</p>
<ul class="simple">
<li><p>If found, the <strong>complete word containing the string</strong> is marked (underlined) – not only the search string.</p></li>
<li><p>The search string may <strong>not contain spaces</strong> or other white space.</p></li>
<li><p>As shown here, upper / lower cases are <strong>respected</strong>. But this can be changed by using the string method <em>lower()</em> (or even regular expressions) in function <em>mark_word</em>.</p></li>
<li><p>There is <strong>no upper limit</strong>: all occurrences will be detected.</p></li>
<li><p>You can use <strong>anything</strong> to mark the word: ‘Underline’, ‘Highlight’, ‘StrikeThrough’ or ‘Square’ annotations, etc.</p></li>
<li><p>Here is an example snippet of a page of this manual, where “MuPDF” has been used as the search string. Note that all strings <strong>containing “MuPDF”</strong> have been completely underlined (not just the search string).</p></li>
</ul>
<a class="reference internal image-reference" href="_images/img-markedpdf.jpg"><img alt="_images/img-markedpdf.jpg" src="_images/img-markedpdf.jpg" style="width: 439.2px; height: 219.6px;" /></a>
</div>
<hr class="docutils" />
<div class="section" id="how-to-mark-searched-text">
<h3>How to Mark Searched Text<a class="headerlink" href="#how-to-mark-searched-text" title="Permalink to this headline">¶</a></h3>
<p>This script searches for text and marks it:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># -*- coding: utf-8 -*-</span>
<span class="kn">import</span> <span class="nn">fitz</span>

<span class="c1"># the document to annotate</span>
<span class="n">doc</span> <span class="o">=</span> <span class="n">fitz</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="s2">&quot;tilted-text.pdf&quot;</span><span class="p">)</span>

<span class="c1"># the text to be marked</span>
<span class="n">t</span> <span class="o">=</span> <span class="s2">&quot;¡La práctica hace el campeón!&quot;</span>

<span class="c1"># work with first page only</span>
<span class="n">page</span> <span class="o">=</span> <span class="n">doc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

<span class="c1"># get list of text locations</span>
<span class="c1"># we use &quot;quads&quot;, not rectangles because text may be tilted!</span>
<span class="n">rl</span> <span class="o">=</span> <span class="n">page</span><span class="o">.</span><span class="n">search_for</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">quads</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>

<span class="c1"># mark all found quads with one annotation</span>
<span class="n">page</span><span class="o">.</span><span class="n">addSquigglyAnnot</span><span class="p">(</span><span class="n">rl</span><span class="p">)</span>

<span class="c1"># save to a new PDF</span>
<span class="n">doc</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="s2">&quot;a-squiggly.pdf&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p>The result looks like this:</p>
<a class="reference internal image-reference" href="_images/img-textmarker.jpg"><img alt="_images/img-textmarker.jpg" src="_images/img-textmarker.jpg" style="width: 234.4px; height: 273.6px;" /></a>
</div>
<hr class="docutils" />
<div class="section" id="how-to-mark-non-horizontal-text">
<h3>How to Mark Non-horizontal Text<a class="headerlink" href="#how-to-mark-non-horizontal-text" title="Permalink to this headline">¶</a></h3>
<p>The previous section already shows an example for marking non-horizontal text detected by text <strong>searching</strong>.</p>
<p>But text <strong>extraction</strong> with the “dict” option of <a class="reference internal" href="page.html#Page.get_text" title="Page.get_text"><code class="xref py py-meth docutils literal notranslate"><span class="pre">Page.get_text()</span></code></a> may also return text with a non-zero angle to the x-axis. This is reflected by the value of the <code class="docutils literal notranslate"><span class="pre">&quot;dir&quot;</span></code> key of the line dictionary: it is the tuple <code class="docutils literal notranslate"><span class="pre">(cosine,</span> <span class="pre">sine)</span></code> of that angle.</p>
<p>Currently, all bboxes returned by the method’s are rectangles only – no quads. So we can mark the span text (correctly) only, if the <strong>angle is 0, 90, 180 or 270 degrees.</strong></p>
<p>In this case we can convert the span bbox into the right quad by choosing the right sequence of its corners:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">r</span> <span class="o">=</span> <span class="n">fitz</span><span class="o">.</span><span class="n">Rect</span><span class="p">(</span><span class="n">span</span><span class="p">[</span><span class="s2">&quot;bbox&quot;</span><span class="p">])</span>

<span class="k">if</span> <span class="n">line</span><span class="p">[</span><span class="s2">&quot;dir&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">):</span>  <span class="c1"># rotation 0</span>
    <span class="n">q</span> <span class="o">=</span> <span class="n">fitz</span><span class="o">.</span><span class="n">Quad</span><span class="p">(</span><span class="n">r</span><span class="p">)</span>

<span class="k">elif</span> <span class="n">line</span><span class="p">[</span><span class="s2">&quot;dir&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">):</span>  <span class="c1"># rotation 90</span>
    <span class="n">q</span> <span class="o">=</span> <span class="n">fitz</span><span class="o">.</span><span class="n">Quad</span><span class="p">(</span><span class="n">r</span><span class="o">.</span><span class="n">bl</span><span class="p">,</span> <span class="n">r</span><span class="o">.</span><span class="n">tl</span><span class="p">,</span> <span class="n">r</span><span class="o">.</span><span class="n">br</span><span class="p">,</span> <span class="n">r</span><span class="o">.</span><span class="n">tr</span><span class="p">)</span>

<span class="k">elif</span> <span class="n">line</span><span class="p">[</span><span class="s2">&quot;dir&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">):</span>  <span class="c1"># rotation 180</span>
    <span class="n">q</span> <span class="o">=</span> <span class="n">fitz</span><span class="o">.</span><span class="n">Quad</span><span class="p">(</span><span class="n">r</span><span class="o">.</span><span class="n">br</span><span class="p">,</span> <span class="n">r</span><span class="o">.</span><span class="n">bl</span><span class="p">,</span> <span class="n">r</span><span class="o">.</span><span class="n">tr</span><span class="p">,</span> <span class="n">r</span><span class="o">.</span><span class="n">tl</span><span class="p">)</span>

<span class="k">elif</span> <span class="n">line</span><span class="p">[</span><span class="s2">&quot;dir&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">):</span>  <span class="c1"># rotation 270</span>
    <span class="n">q</span> <span class="o">=</span> <span class="n">fitz</span><span class="o">.</span><span class="n">Quad</span><span class="p">(</span><span class="n">r</span><span class="o">.</span><span class="n">tr</span><span class="p">,</span> <span class="n">r</span><span class="o">.</span><span class="n">br</span><span class="p">,</span> <span class="n">r</span><span class="o">.</span><span class="n">tl</span><span class="p">,</span> <span class="n">r</span><span class="o">.</span><span class="n">bl</span><span class="p">)</span>

<span class="k">else</span><span class="p">:</span>
    <span class="n">q</span> <span class="o">=</span> <span class="n">fitz</span><span class="o">.</span><span class="n">Quad</span><span class="p">(</span><span class="n">r</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;warning: unsupported text flow&quot;</span><span class="p">)</span>

<span class="n">annot</span> <span class="o">=</span> <span class="n">page</span><span class="o">.</span><span class="n">addHighlightAnnot</span><span class="p">(</span><span class="n">q</span><span class="p">)</span>
</pre></div>
</div>
</div>
<hr class="docutils" />
<div class="section" id="how-to-analyze-font-characteristics">
<h3>How to Analyze Font Characteristics<a class="headerlink" href="#how-to-analyze-font-characteristics" title="Permalink to this headline">¶</a></h3>
<p>To analyze the characteristics of text in a PDF use this elementary script as a starting point:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">fitz</span>


<span class="k">def</span> <span class="nf">flags_decomposer</span><span class="p">(</span><span class="n">flags</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Make font flags human readable.&quot;&quot;&quot;</span>
    <span class="n">l</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">if</span> <span class="n">flags</span> <span class="o">&amp;</span> <span class="mi">2</span> <span class="o">**</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">l</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;superscript&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">flags</span> <span class="o">&amp;</span> <span class="mi">2</span> <span class="o">**</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">l</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;italic&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">flags</span> <span class="o">&amp;</span> <span class="mi">2</span> <span class="o">**</span> <span class="mi">2</span><span class="p">:</span>
        <span class="n">l</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;serifed&quot;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">l</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;sans&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">flags</span> <span class="o">&amp;</span> <span class="mi">2</span> <span class="o">**</span> <span class="mi">3</span><span class="p">:</span>
        <span class="n">l</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;monospaced&quot;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">l</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;proportional&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">flags</span> <span class="o">&amp;</span> <span class="mi">2</span> <span class="o">**</span> <span class="mi">4</span><span class="p">:</span>
        <span class="n">l</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;bold&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">l</span><span class="p">)</span>


<span class="n">doc</span> <span class="o">=</span> <span class="n">fitz</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="s2">&quot;text-tester.pdf&quot;</span><span class="p">)</span>
<span class="n">page</span> <span class="o">=</span> <span class="n">doc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

<span class="c1"># read page text as a dictionary, suppressing extra spaces in CJK fonts</span>
<span class="n">blocks</span> <span class="o">=</span> <span class="n">page</span><span class="o">.</span><span class="n">get_text</span><span class="p">(</span><span class="s2">&quot;dict&quot;</span><span class="p">,</span> <span class="n">flags</span><span class="o">=</span><span class="mi">11</span><span class="p">)[</span><span class="s2">&quot;blocks&quot;</span><span class="p">]</span>
<span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="n">blocks</span><span class="p">:</span>  <span class="c1"># iterate through the text blocks</span>
    <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="n">b</span><span class="p">[</span><span class="s2">&quot;lines&quot;</span><span class="p">]:</span>  <span class="c1"># iterate through the text lines</span>
        <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">l</span><span class="p">[</span><span class="s2">&quot;spans&quot;</span><span class="p">]:</span>  <span class="c1"># iterate through the text spans</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
            <span class="n">font_properties</span> <span class="o">=</span> <span class="s2">&quot;Font: &#39;</span><span class="si">%s</span><span class="s2">&#39; (</span><span class="si">%s</span><span class="s2">), size </span><span class="si">%g</span><span class="s2">, color #</span><span class="si">%06x</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span>
                <span class="n">s</span><span class="p">[</span><span class="s2">&quot;font&quot;</span><span class="p">],</span>  <span class="c1"># font name</span>
                <span class="n">flags_decomposer</span><span class="p">(</span><span class="n">s</span><span class="p">[</span><span class="s2">&quot;flags&quot;</span><span class="p">]),</span>  <span class="c1"># readable font flags</span>
                <span class="n">s</span><span class="p">[</span><span class="s2">&quot;size&quot;</span><span class="p">],</span>  <span class="c1"># font size</span>
                <span class="n">s</span><span class="p">[</span><span class="s2">&quot;color&quot;</span><span class="p">],</span>  <span class="c1"># font color</span>
            <span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Text: &#39;</span><span class="si">%s</span><span class="s2">&#39;&quot;</span> <span class="o">%</span> <span class="n">s</span><span class="p">[</span><span class="s2">&quot;text&quot;</span><span class="p">])</span>  <span class="c1"># simple print of text</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">font_properties</span><span class="p">)</span>
</pre></div>
</div>
<p>Here is the PDF page and the script output:</p>
<a class="reference internal image-reference" href="_images/img-pdftext.jpg"><img alt="_images/img-pdftext.jpg" src="_images/img-pdftext.jpg" style="width: 1536.8000000000002px; height: 900.0px;" /></a>
</div>
<hr class="docutils" />
<div class="section" id="how-to-insert-text">
<h3>How to Insert Text<a class="headerlink" href="#how-to-insert-text" title="Permalink to this headline">¶</a></h3>
<p>PyMuPDF provides ways to insert text on new or existing PDF pages with the following features:</p>
<ul>
<li><p>choose the font, including built-in fonts and fonts that are available as files</p></li>
<li><p>choose text characteristics like bold, italic, font size, font color, etc.</p></li>
<li><p>position the text in multiple ways:</p>
<blockquote>
<div><ul class="simple">
<li><p>either as simple line-oriented output starting at a certain point,</p></li>
<li><p>or fitting text in a box provided as a rectangle, in which case text alignment choices are also available,</p></li>
<li><p>choose whether text should be put in foreground (overlay existing content),</p></li>
<li><p>all text can be arbitrarily “morphed”, i.e. its appearance can be changed via a <a class="reference internal" href="matrix.html#matrix"><span class="std std-ref">Matrix</span></a>, to achieve effects like scaling, shearing or mirroring,</p></li>
<li><p>independently from morphing and in addition to that, text can be rotated by integer multiples of 90 degrees.</p></li>
</ul>
</div></blockquote>
</li>
</ul>
<p>All of the above is provided by three basic <a class="reference internal" href="page.html#page"><span class="std std-ref">Page</span></a>, resp. <a class="reference internal" href="shape.html#shape"><span class="std std-ref">Shape</span></a> methods:</p>
<ul>
<li><p><a class="reference internal" href="page.html#Page.insert_font" title="Page.insert_font"><code class="xref py py-meth docutils literal notranslate"><span class="pre">Page.insert_font()</span></code></a> – install a font for the page for later reference. The result is reflected in the output of <a class="reference internal" href="document.html#Document.get_page_fonts" title="Document.get_page_fonts"><code class="xref py py-meth docutils literal notranslate"><span class="pre">Document.get_page_fonts()</span></code></a>. The font can be:</p>
<blockquote>
<div><ul class="simple">
<li><p>provided as a file,</p></li>
<li><p>already present somewhere in <strong>this or another</strong> PDF, or</p></li>
<li><p>be a <strong>built-in</strong> font.</p></li>
</ul>
</div></blockquote>
</li>
<li><p><a class="reference internal" href="page.html#Page.insert_text" title="Page.insert_text"><code class="xref py py-meth docutils literal notranslate"><span class="pre">Page.insert_text()</span></code></a> – write some lines of text. Internally, this uses <a class="reference internal" href="shape.html#Shape.insert_text" title="Shape.insert_text"><code class="xref py py-meth docutils literal notranslate"><span class="pre">Shape.insert_text()</span></code></a>.</p></li>
<li><p><a class="reference internal" href="page.html#Page.insert_textbox" title="Page.insert_textbox"><code class="xref py py-meth docutils literal notranslate"><span class="pre">Page.insert_textbox()</span></code></a> – fit text in a given rectangle. Here you can choose text alignment features (left, right, centered, justified) and you keep control as to whether text actually fits. Internally, this uses <a class="reference internal" href="shape.html#Shape.insert_textbox" title="Shape.insert_textbox"><code class="xref py py-meth docutils literal notranslate"><span class="pre">Shape.insert_textbox()</span></code></a>.</p></li>
</ul>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Both text insertion methods automatically install the font as necessary.</p>
</div>
<div class="section" id="how-to-write-text-lines">
<h4>How to Write Text Lines<a class="headerlink" href="#how-to-write-text-lines" title="Permalink to this headline">¶</a></h4>
<p>Output some text lines on a page:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">fitz</span>
<span class="n">doc</span> <span class="o">=</span> <span class="n">fitz</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="o">...</span><span class="p">)</span>  <span class="c1"># new or existing PDF</span>
<span class="n">page</span> <span class="o">=</span> <span class="n">doc</span><span class="o">.</span><span class="n">new_page</span><span class="p">()</span>  <span class="c1"># new or existing page via doc[n]</span>
<span class="n">p</span> <span class="o">=</span> <span class="n">fitz</span><span class="o">.</span><span class="n">Point</span><span class="p">(</span><span class="mi">50</span><span class="p">,</span> <span class="mi">72</span><span class="p">)</span>  <span class="c1"># start point of 1st line</span>

<span class="n">text</span> <span class="o">=</span> <span class="s2">&quot;Some text,</span><span class="se">\n</span><span class="s2">spread across</span><span class="se">\n</span><span class="s2">several lines.&quot;</span>
<span class="c1"># the same result is achievable by</span>
<span class="c1"># text = [&quot;Some text&quot;, &quot;spread across&quot;, &quot;several lines.&quot;]</span>

<span class="n">rc</span> <span class="o">=</span> <span class="n">page</span><span class="o">.</span><span class="n">insert_text</span><span class="p">(</span><span class="n">p</span><span class="p">,</span>  <span class="c1"># bottom-left of 1st char</span>
                     <span class="n">text</span><span class="p">,</span>  <span class="c1"># the text (honors &#39;\n&#39;)</span>
                     <span class="n">fontname</span> <span class="o">=</span> <span class="s2">&quot;helv&quot;</span><span class="p">,</span>  <span class="c1"># the default font</span>
                     <span class="n">fontsize</span> <span class="o">=</span> <span class="mi">11</span><span class="p">,</span>  <span class="c1"># the default font size</span>
                     <span class="n">rotate</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>  <span class="c1"># also available: 90, 180, 270</span>
                     <span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%i</span><span class="s2"> lines printed on page </span><span class="si">%i</span><span class="s2">.&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">rc</span><span class="p">,</span> <span class="n">page</span><span class="o">.</span><span class="n">number</span><span class="p">))</span>

<span class="n">doc</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="s2">&quot;text.pdf&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p>With this method, only the <strong>number of lines</strong> will be controlled to not go beyond page height. Surplus lines will not be written and the number of actual lines will be returned. The calculation uses <em>1.2 * fontsize</em> as the line height and 36 points (0.5 inches) as bottom margin.</p>
<p>Line <strong>width is ignored</strong>. The surplus part of a line will simply be invisible.</p>
<p>However, for built-in fonts there are ways to calculate the line width beforehand - see <a class="reference internal" href="functions.html#getTextlength" title="getTextlength"><code class="xref py py-meth docutils literal notranslate"><span class="pre">getTextlength()</span></code></a>.</p>
<p>Here is another example. It inserts 4 text strings using the four different rotation options, and thereby explains, how the text insertion point must be chosen to achieve the desired result:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">fitz</span>
<span class="n">doc</span> <span class="o">=</span> <span class="n">fitz</span><span class="o">.</span><span class="n">open</span><span class="p">()</span>
<span class="n">page</span> <span class="o">=</span> <span class="n">doc</span><span class="o">.</span><span class="n">new_page</span><span class="p">()</span>
<span class="c1"># the text strings, each having 3 lines</span>
<span class="n">text1</span> <span class="o">=</span> <span class="s2">&quot;rotate=0</span><span class="se">\n</span><span class="s2">Line 2</span><span class="se">\n</span><span class="s2">Line 3&quot;</span>
<span class="n">text2</span> <span class="o">=</span> <span class="s2">&quot;rotate=90</span><span class="se">\n</span><span class="s2">Line 2</span><span class="se">\n</span><span class="s2">Line 3&quot;</span>
<span class="n">text3</span> <span class="o">=</span> <span class="s2">&quot;rotate=-90</span><span class="se">\n</span><span class="s2">Line 2</span><span class="se">\n</span><span class="s2">Line 3&quot;</span>
<span class="n">text4</span> <span class="o">=</span> <span class="s2">&quot;rotate=180</span><span class="se">\n</span><span class="s2">Line 2</span><span class="se">\n</span><span class="s2">Line 3&quot;</span>
<span class="n">red</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="c1"># the color for the red dots</span>
<span class="c1"># the insertion points, each with a 25 pix distance from the corners</span>
<span class="n">p1</span> <span class="o">=</span> <span class="n">fitz</span><span class="o">.</span><span class="n">Point</span><span class="p">(</span><span class="mi">25</span><span class="p">,</span> <span class="mi">25</span><span class="p">)</span>
<span class="n">p2</span> <span class="o">=</span> <span class="n">fitz</span><span class="o">.</span><span class="n">Point</span><span class="p">(</span><span class="n">page</span><span class="o">.</span><span class="n">rect</span><span class="o">.</span><span class="n">width</span> <span class="o">-</span> <span class="mi">25</span><span class="p">,</span> <span class="mi">25</span><span class="p">)</span>
<span class="n">p3</span> <span class="o">=</span> <span class="n">fitz</span><span class="o">.</span><span class="n">Point</span><span class="p">(</span><span class="mi">25</span><span class="p">,</span> <span class="n">page</span><span class="o">.</span><span class="n">rect</span><span class="o">.</span><span class="n">height</span> <span class="o">-</span> <span class="mi">25</span><span class="p">)</span>
<span class="n">p4</span> <span class="o">=</span> <span class="n">fitz</span><span class="o">.</span><span class="n">Point</span><span class="p">(</span><span class="n">page</span><span class="o">.</span><span class="n">rect</span><span class="o">.</span><span class="n">width</span> <span class="o">-</span> <span class="mi">25</span><span class="p">,</span> <span class="n">page</span><span class="o">.</span><span class="n">rect</span><span class="o">.</span><span class="n">height</span> <span class="o">-</span> <span class="mi">25</span><span class="p">)</span>
<span class="c1"># create a Shape to draw on</span>
<span class="n">shape</span> <span class="o">=</span> <span class="n">page</span><span class="o">.</span><span class="n">new_shape</span><span class="p">()</span>

<span class="c1"># draw the insertion points as red, filled dots</span>
<span class="n">shape</span><span class="o">.</span><span class="n">draw_circle</span><span class="p">(</span><span class="n">p1</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
<span class="n">shape</span><span class="o">.</span><span class="n">draw_circle</span><span class="p">(</span><span class="n">p2</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
<span class="n">shape</span><span class="o">.</span><span class="n">draw_circle</span><span class="p">(</span><span class="n">p3</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
<span class="n">shape</span><span class="o">.</span><span class="n">draw_circle</span><span class="p">(</span><span class="n">p4</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
<span class="n">shape</span><span class="o">.</span><span class="n">finish</span><span class="p">(</span><span class="n">width</span><span class="o">=</span><span class="mf">0.3</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">red</span><span class="p">,</span> <span class="n">fill</span><span class="o">=</span><span class="n">red</span><span class="p">)</span>

<span class="c1"># insert the text strings</span>
<span class="n">shape</span><span class="o">.</span><span class="n">insert_text</span><span class="p">(</span><span class="n">p1</span><span class="p">,</span> <span class="n">text1</span><span class="p">)</span>
<span class="n">shape</span><span class="o">.</span><span class="n">insert_text</span><span class="p">(</span><span class="n">p3</span><span class="p">,</span> <span class="n">text2</span><span class="p">,</span> <span class="n">rotate</span><span class="o">=</span><span class="mi">90</span><span class="p">)</span>
<span class="n">shape</span><span class="o">.</span><span class="n">insert_text</span><span class="p">(</span><span class="n">p2</span><span class="p">,</span> <span class="n">text3</span><span class="p">,</span> <span class="n">rotate</span><span class="o">=-</span><span class="mi">90</span><span class="p">)</span>
<span class="n">shape</span><span class="o">.</span><span class="n">insert_text</span><span class="p">(</span><span class="n">p4</span><span class="p">,</span> <span class="n">text4</span><span class="p">,</span> <span class="n">rotate</span><span class="o">=</span><span class="mi">180</span><span class="p">)</span>

<span class="c1"># store our work to the page</span>
<span class="n">shape</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
<span class="n">doc</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="o">...</span><span class="p">)</span>
</pre></div>
</div>
<p>This is the result:</p>
<a class="reference internal image-reference" href="_images/img-inserttext.jpg"><img alt="_images/img-inserttext.jpg" src="_images/img-inserttext.jpg" style="width: 221.76000000000002px; height: 260.7px;" /></a>
</div>
<hr class="docutils" />
<div class="section" id="how-to-fill-a-text-box">
<h4>How to Fill a Text Box<a class="headerlink" href="#how-to-fill-a-text-box" title="Permalink to this headline">¶</a></h4>
<p>This script fills 4 different rectangles with text, each time choosing a different rotation value:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">fitz</span>
<span class="n">doc</span> <span class="o">=</span> <span class="n">fitz</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="o">...</span><span class="p">)</span>  <span class="c1"># new or existing PDF</span>
<span class="n">page</span> <span class="o">=</span> <span class="n">doc</span><span class="o">.</span><span class="n">new_page</span><span class="p">()</span>  <span class="c1"># new page, or choose doc[n]</span>
<span class="n">r1</span> <span class="o">=</span> <span class="n">fitz</span><span class="o">.</span><span class="n">Rect</span><span class="p">(</span><span class="mi">50</span><span class="p">,</span><span class="mi">100</span><span class="p">,</span><span class="mi">100</span><span class="p">,</span><span class="mi">150</span><span class="p">)</span>  <span class="c1"># a 50x50 rectangle</span>
<span class="n">disp</span> <span class="o">=</span> <span class="n">fitz</span><span class="o">.</span><span class="n">Rect</span><span class="p">(</span><span class="mi">55</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">55</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>  <span class="c1"># add this to get more rects</span>
<span class="n">r2</span> <span class="o">=</span> <span class="n">r1</span> <span class="o">+</span> <span class="n">disp</span>  <span class="c1"># 2nd rect</span>
<span class="n">r3</span> <span class="o">=</span> <span class="n">r1</span> <span class="o">+</span> <span class="n">disp</span> <span class="o">*</span> <span class="mi">2</span>  <span class="c1"># 3rd rect</span>
<span class="n">r4</span> <span class="o">=</span> <span class="n">r1</span> <span class="o">+</span> <span class="n">disp</span> <span class="o">*</span> <span class="mi">3</span>  <span class="c1"># 4th rect</span>
<span class="n">t1</span> <span class="o">=</span> <span class="s2">&quot;text with rotate = 0.&quot;</span>  <span class="c1"># the texts we will put in</span>
<span class="n">t2</span> <span class="o">=</span> <span class="s2">&quot;text with rotate = 90.&quot;</span>
<span class="n">t3</span> <span class="o">=</span> <span class="s2">&quot;text with rotate = -90.&quot;</span>
<span class="n">t4</span> <span class="o">=</span> <span class="s2">&quot;text with rotate = 180.&quot;</span>
<span class="n">red</span>  <span class="o">=</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span>  <span class="c1"># some colors</span>
<span class="n">gold</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span>
<span class="n">blue</span> <span class="o">=</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
<span class="sd">&quot;&quot;&quot;We use a Shape object (something like a canvas) to output the text and</span>
<span class="sd">the rectangles surrounding it for demonstration.</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="n">shape</span> <span class="o">=</span> <span class="n">page</span><span class="o">.</span><span class="n">new_shape</span><span class="p">()</span>  <span class="c1"># create Shape</span>
<span class="n">shape</span><span class="o">.</span><span class="n">draw_rect</span><span class="p">(</span><span class="n">r1</span><span class="p">)</span>  <span class="c1"># draw rectangles</span>
<span class="n">shape</span><span class="o">.</span><span class="n">draw_rect</span><span class="p">(</span><span class="n">r2</span><span class="p">)</span>  <span class="c1"># giving them</span>
<span class="n">shape</span><span class="o">.</span><span class="n">draw_rect</span><span class="p">(</span><span class="n">r3</span><span class="p">)</span>  <span class="c1"># a yellow background</span>
<span class="n">shape</span><span class="o">.</span><span class="n">draw_rect</span><span class="p">(</span><span class="n">r4</span><span class="p">)</span>  <span class="c1"># and a red border</span>
<span class="n">shape</span><span class="o">.</span><span class="n">finish</span><span class="p">(</span><span class="n">width</span> <span class="o">=</span> <span class="mf">0.3</span><span class="p">,</span> <span class="n">color</span> <span class="o">=</span> <span class="n">red</span><span class="p">,</span> <span class="n">fill</span> <span class="o">=</span> <span class="n">gold</span><span class="p">)</span>
<span class="c1"># Now insert text in the rectangles. Font &quot;Helvetica&quot; will be used</span>
<span class="c1"># by default. A return code rc &lt; 0 indicates insufficient space (not checked here).</span>
<span class="n">rc</span> <span class="o">=</span> <span class="n">shape</span><span class="o">.</span><span class="n">insert_textbox</span><span class="p">(</span><span class="n">r1</span><span class="p">,</span> <span class="n">t1</span><span class="p">,</span> <span class="n">color</span> <span class="o">=</span> <span class="n">blue</span><span class="p">)</span>
<span class="n">rc</span> <span class="o">=</span> <span class="n">shape</span><span class="o">.</span><span class="n">insert_textbox</span><span class="p">(</span><span class="n">r2</span><span class="p">,</span> <span class="n">t2</span><span class="p">,</span> <span class="n">color</span> <span class="o">=</span> <span class="n">blue</span><span class="p">,</span> <span class="n">rotate</span> <span class="o">=</span> <span class="mi">90</span><span class="p">)</span>
<span class="n">rc</span> <span class="o">=</span> <span class="n">shape</span><span class="o">.</span><span class="n">insert_textbox</span><span class="p">(</span><span class="n">r3</span><span class="p">,</span> <span class="n">t3</span><span class="p">,</span> <span class="n">color</span> <span class="o">=</span> <span class="n">blue</span><span class="p">,</span> <span class="n">rotate</span> <span class="o">=</span> <span class="o">-</span><span class="mi">90</span><span class="p">)</span>
<span class="n">rc</span> <span class="o">=</span> <span class="n">shape</span><span class="o">.</span><span class="n">insert_textbox</span><span class="p">(</span><span class="n">r4</span><span class="p">,</span> <span class="n">t4</span><span class="p">,</span> <span class="n">color</span> <span class="o">=</span> <span class="n">blue</span><span class="p">,</span> <span class="n">rotate</span> <span class="o">=</span> <span class="mi">180</span><span class="p">)</span>
<span class="n">shape</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>  <span class="c1"># write all stuff to page /Contents</span>
<span class="n">doc</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="s2">&quot;...&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p>Several default values were used above: font “Helvetica”, font size 11 and text alignment “left”. The result will look like this:</p>
<a class="reference internal image-reference" href="_images/img-textbox.jpg"><img alt="_images/img-textbox.jpg" src="_images/img-textbox.jpg" style="width: 354.5px; height: 90.0px;" /></a>
</div>
<hr class="docutils" />
<div class="section" id="how-to-use-non-standard-encoding">
<h4>How to Use Non-Standard Encoding<a class="headerlink" href="#how-to-use-non-standard-encoding" title="Permalink to this headline">¶</a></h4>
<p>Since v1.14, MuPDF allows Greek and Russian encoding variants for the <a class="reference internal" href="vars.html#Base14_Fonts" title="Base14_Fonts"><code class="xref py py-data docutils literal notranslate"><span class="pre">Base14_Fonts</span></code></a>. In PyMuPDF this is supported via an additional <em>encoding</em> argument. Effectively, this is relevant for Helvetica, Times-Roman and Courier (and their bold / italic forms) and characters outside the ASCII code range only. Elsewhere, the argument is ignored. Here is how to request Russian encoding with the standard font Helvetica:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">page</span><span class="o">.</span><span class="n">insert_text</span><span class="p">(</span><span class="n">point</span><span class="p">,</span> <span class="n">russian_text</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="n">fitz</span><span class="o">.</span><span class="n">TEXT_ENCODING_CYRILLIC</span><span class="p">)</span>
</pre></div>
</div>
<p>The valid encoding values are TEXT_ENCODING_LATIN (0), TEXT_ENCODING_GREEK (1), and TEXT_ENCODING_CYRILLIC (2, Russian) with Latin being the default. Encoding can be specified by all relevant font and text insertion methods.</p>
<p>By the above statement, the fontname <em>helv</em> is automatically connected to the Russian font variant of Helvetica. Any subsequent text insertion with <strong>this fontname</strong> will use the Russian Helvetica encoding.</p>
<p>If you change the fontname just slightly, you can also achieve an <strong>encoding “mixture”</strong> for the <strong>same base font</strong> on the same page:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">fitz</span>
<span class="n">doc</span><span class="o">=</span><span class="n">fitz</span><span class="o">.</span><span class="n">open</span><span class="p">()</span>
<span class="n">page</span> <span class="o">=</span> <span class="n">doc</span><span class="o">.</span><span class="n">new_page</span><span class="p">()</span>
<span class="n">shape</span> <span class="o">=</span> <span class="n">page</span><span class="o">.</span><span class="n">new_shape</span><span class="p">()</span>
<span class="n">t</span><span class="o">=</span><span class="s2">&quot;Sômé tèxt wìth nöñ-Lâtîn characterß.&quot;</span>
<span class="n">shape</span><span class="o">.</span><span class="n">insert_text</span><span class="p">((</span><span class="mi">50</span><span class="p">,</span><span class="mi">70</span><span class="p">),</span> <span class="n">t</span><span class="p">,</span> <span class="n">fontname</span><span class="o">=</span><span class="s2">&quot;helv&quot;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="n">fitz</span><span class="o">.</span><span class="n">TEXT_ENCODING_LATIN</span><span class="p">)</span>
<span class="n">shape</span><span class="o">.</span><span class="n">insert_text</span><span class="p">((</span><span class="mi">50</span><span class="p">,</span><span class="mi">90</span><span class="p">),</span> <span class="n">t</span><span class="p">,</span> <span class="n">fontname</span><span class="o">=</span><span class="s2">&quot;HElv&quot;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="n">fitz</span><span class="o">.</span><span class="n">TEXT_ENCODING_GREEK</span><span class="p">)</span>
<span class="n">shape</span><span class="o">.</span><span class="n">insert_text</span><span class="p">((</span><span class="mi">50</span><span class="p">,</span><span class="mi">110</span><span class="p">),</span> <span class="n">t</span><span class="p">,</span> <span class="n">fontname</span><span class="o">=</span><span class="s2">&quot;HELV&quot;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="n">fitz</span><span class="o">.</span><span class="n">TEXT_ENCODING_CYRILLIC</span><span class="p">)</span>
<span class="n">shape</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
<span class="n">doc</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="s2">&quot;t.pdf&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p>The result:</p>
<a class="reference internal image-reference" href="_images/img-encoding.jpg"><img alt="_images/img-encoding.jpg" src="_images/img-encoding.jpg" style="width: 412.0px; height: 110.5px;" /></a>
<p>The snippet above indeed leads to three different copies of the Helvetica font in the PDF. Each copy is uniquely identified (and referenceable) by using the correct upper-lower case spelling of the reserved word “helv”:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">doc</span><span class="o">.</span><span class="n">get_page_fonts</span><span class="p">(</span><span class="mi">0</span><span class="p">):</span> <span class="nb">print</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>

<span class="p">[</span><span class="mi">6</span><span class="p">,</span> <span class="s1">&#39;n/a&#39;</span><span class="p">,</span> <span class="s1">&#39;Type1&#39;</span><span class="p">,</span> <span class="s1">&#39;Helvetica&#39;</span><span class="p">,</span> <span class="s1">&#39;helv&#39;</span><span class="p">,</span> <span class="s1">&#39;WinAnsiEncoding&#39;</span><span class="p">]</span>
<span class="p">[</span><span class="mi">7</span><span class="p">,</span> <span class="s1">&#39;n/a&#39;</span><span class="p">,</span> <span class="s1">&#39;Type1&#39;</span><span class="p">,</span> <span class="s1">&#39;Helvetica&#39;</span><span class="p">,</span> <span class="s1">&#39;HElv&#39;</span><span class="p">,</span> <span class="s1">&#39;WinAnsiEncoding&#39;</span><span class="p">]</span>
<span class="p">[</span><span class="mi">8</span><span class="p">,</span> <span class="s1">&#39;n/a&#39;</span><span class="p">,</span> <span class="s1">&#39;Type1&#39;</span><span class="p">,</span> <span class="s1">&#39;Helvetica&#39;</span><span class="p">,</span> <span class="s1">&#39;HELV&#39;</span><span class="p">,</span> <span class="s1">&#39;WinAnsiEncoding&#39;</span><span class="p">]</span>
</pre></div>
</div>
</div>
</div>
</div>
<hr class="docutils" />
<div class="section" id="annotations">
<h2>Annotations<a class="headerlink" href="#annotations" title="Permalink to this headline">¶</a></h2>
<p>In v1.14.0, annotation handling has been considerably extended:</p>
<ul class="simple">
<li><p>New annotation type support for ‘Ink’, ‘Rubber Stamp’ and ‘Squiggly’ annotations. Ink annots simulate handwriting by combining one or more lists of interconnected points. Stamps are intended to visually inform about a document’s status or intended usage (like “draft”, “confidential”, etc.). ‘Squiggly’ is a text marker annot, which underlines selected text with a zigzagged line.</p></li>
<li><dl class="simple">
<dt>Extended ‘FreeText’ support:</dt><dd><ol class="arabic simple">
<li><p>all characters from the <em>Latin</em> character set are now available,</p></li>
<li><p>colors of text, rectangle background and rectangle border can be independently set</p></li>
<li><p>text in rectangle can be rotated by either +90 or -90 degrees</p></li>
<li><p>text is automatically wrapped (made multi-line) in available rectangle</p></li>
<li><p>all Base-14 fonts are now available (<em>normal</em> variants only, i.e. no bold, no italic).</p></li>
</ol>
</dd>
</dl>
</li>
<li><p>MuPDF now supports line end icons for ‘Line’ annots (only). PyMuPDF supported that in v1.13.x already – and for (almost) the full range of applicable types. So we adjusted the appearance of ‘Polygon’ and ‘PolyLine’ annots to closely resemble the one of MuPDF for ‘Line’.</p></li>
<li><p>MuPDF now provides its own annotation icons where relevant. PyMuPDF switched to using them (for ‘FileAttachment’ and ‘Text’ [“sticky note”] so far).</p></li>
<li><p>MuPDF now also supports ‘Caret’, ‘Movie’, ‘Sound’ and ‘Signature’ annotations, which we may include in PyMuPDF at some later time.</p></li>
</ul>
<div class="section" id="how-to-add-and-modify-annotations">
<h3>How to Add and Modify Annotations<a class="headerlink" href="#how-to-add-and-modify-annotations" title="Permalink to this headline">¶</a></h3>
<p>In PyMuPDF, new annotations can be added via <a class="reference internal" href="page.html#page"><span class="std std-ref">Page</span></a> methods. Once an annotation exists, it can be modified to a large extent using methods of the <a class="reference internal" href="annot.html#annot"><span class="std std-ref">Annot</span></a> class.</p>
<p>In contrast to many other tools, initial insert of annotations happens with a minimum number of properties. We leave it to the programmer to e.g. set attributes like author, creation date or subject.</p>
<p>As an overview for these capabilities, look at the following script that fills a PDF page with most of the available annotations. Look in the next sections for more special situations:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># -*- coding: utf-8 -*-</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">-------------------------------------------------------------------------------</span>
<span class="sd">Demo script showing how annotations can be added to a PDF using PyMuPDF.</span>

<span class="sd">It contains the following annotation types:</span>
<span class="sd">Caret, Text, FreeText, text markers (underline, strike-out, highlight,</span>
<span class="sd">squiggle), Circle, Square, Line, PolyLine, Polygon, FileAttachment, Stamp</span>
<span class="sd">and Redaction.</span>
<span class="sd">There is some effort to vary appearances by adding colors, line ends,</span>
<span class="sd">opacity, rotation, dashed lines, etc.</span>

<span class="sd">Dependencies</span>
<span class="sd">------------</span>
<span class="sd">PyMuPDF v1.17.0</span>
<span class="sd">-------------------------------------------------------------------------------</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="kn">from</span> <span class="nn">__future__</span> <span class="kn">import</span> <span class="n">print_function</span>

<span class="kn">import</span> <span class="nn">gc</span>
<span class="kn">import</span> <span class="nn">sys</span>

<span class="kn">import</span> <span class="nn">fitz</span>

<span class="nb">print</span><span class="p">(</span><span class="n">fitz</span><span class="o">.</span><span class="vm">__doc__</span><span class="p">)</span>
<span class="k">if</span> <span class="n">fitz</span><span class="o">.</span><span class="n">VersionBind</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">)</span> <span class="o">&lt;</span> <span class="p">[</span><span class="s2">&quot;1&quot;</span><span class="p">,</span> <span class="s2">&quot;17&quot;</span><span class="p">,</span> <span class="s2">&quot;0&quot;</span><span class="p">]:</span>
    <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="s2">&quot;PyMuPDF v1.17.0+ is needed.&quot;</span><span class="p">)</span>

<span class="n">gc</span><span class="o">.</span><span class="n">set_debug</span><span class="p">(</span><span class="n">gc</span><span class="o">.</span><span class="n">DEBUG_UNCOLLECTABLE</span><span class="p">)</span>

<span class="n">highlight</span> <span class="o">=</span> <span class="s2">&quot;this text is highlighted&quot;</span>
<span class="n">underline</span> <span class="o">=</span> <span class="s2">&quot;this text is underlined&quot;</span>
<span class="n">strikeout</span> <span class="o">=</span> <span class="s2">&quot;this text is striked out&quot;</span>
<span class="n">squiggled</span> <span class="o">=</span> <span class="s2">&quot;this text is zigzag-underlined&quot;</span>
<span class="n">red</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
<span class="n">blue</span> <span class="o">=</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
<span class="n">gold</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
<span class="n">green</span> <span class="o">=</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>

<span class="n">displ</span> <span class="o">=</span> <span class="n">fitz</span><span class="o">.</span><span class="n">Rect</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">50</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">50</span><span class="p">)</span>
<span class="n">r</span> <span class="o">=</span> <span class="n">fitz</span><span class="o">.</span><span class="n">Rect</span><span class="p">(</span><span class="mi">72</span><span class="p">,</span> <span class="mi">72</span><span class="p">,</span> <span class="mi">220</span><span class="p">,</span> <span class="mi">100</span><span class="p">)</span>
<span class="n">t1</span> <span class="o">=</span> <span class="sa">u</span><span class="s2">&quot;têxt üsès Lätiñ charß,</span><span class="se">\n</span><span class="s2">EUR: €, mu: µ, super scripts: ²³!&quot;</span>


<span class="k">def</span> <span class="nf">print_descr</span><span class="p">(</span><span class="n">annot</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Print a short description to the right of each annot rect.&quot;&quot;&quot;</span>
    <span class="n">annot</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">insert_text</span><span class="p">(</span>
        <span class="n">annot</span><span class="o">.</span><span class="n">rect</span><span class="o">.</span><span class="n">br</span> <span class="o">+</span> <span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="o">-</span><span class="mi">5</span><span class="p">),</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> annotation&quot;</span> <span class="o">%</span> <span class="n">annot</span><span class="o">.</span><span class="n">type</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="n">red</span>
    <span class="p">)</span>


<span class="n">doc</span> <span class="o">=</span> <span class="n">fitz</span><span class="o">.</span><span class="n">open</span><span class="p">()</span>
<span class="n">page</span> <span class="o">=</span> <span class="n">doc</span><span class="o">.</span><span class="n">new_page</span><span class="p">()</span>

<span class="n">page</span><span class="o">.</span><span class="n">set_rotation</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

<span class="n">annot</span> <span class="o">=</span> <span class="n">page</span><span class="o">.</span><span class="n">addCaretAnnot</span><span class="p">(</span><span class="n">r</span><span class="o">.</span><span class="n">tl</span><span class="p">)</span>
<span class="n">print_descr</span><span class="p">(</span><span class="n">annot</span><span class="p">)</span>

<span class="n">r</span> <span class="o">=</span> <span class="n">r</span> <span class="o">+</span> <span class="n">displ</span>
<span class="n">annot</span> <span class="o">=</span> <span class="n">page</span><span class="o">.</span><span class="n">addFreetextAnnot</span><span class="p">(</span>
    <span class="n">r</span><span class="p">,</span>
    <span class="n">t1</span><span class="p">,</span>
    <span class="n">fontsize</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span>
    <span class="n">rotate</span><span class="o">=</span><span class="mi">90</span><span class="p">,</span>
    <span class="n">text_color</span><span class="o">=</span><span class="n">blue</span><span class="p">,</span>
    <span class="n">fill_color</span><span class="o">=</span><span class="n">gold</span><span class="p">,</span>
    <span class="n">align</span><span class="o">=</span><span class="n">fitz</span><span class="o">.</span><span class="n">TEXT_ALIGN_CENTER</span><span class="p">,</span>
<span class="p">)</span>
<span class="n">annot</span><span class="o">.</span><span class="n">set_border</span><span class="p">(</span><span class="n">width</span><span class="o">=</span><span class="mf">0.3</span><span class="p">,</span> <span class="n">dashes</span><span class="o">=</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
<span class="n">annot</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">text_color</span><span class="o">=</span><span class="n">blue</span><span class="p">,</span> <span class="n">fill_color</span><span class="o">=</span><span class="n">gold</span><span class="p">)</span>
<span class="n">print_descr</span><span class="p">(</span><span class="n">annot</span><span class="p">)</span>

<span class="n">r</span> <span class="o">=</span> <span class="n">annot</span><span class="o">.</span><span class="n">rect</span> <span class="o">+</span> <span class="n">displ</span>
<span class="n">annot</span> <span class="o">=</span> <span class="n">page</span><span class="o">.</span><span class="n">addTextAnnot</span><span class="p">(</span><span class="n">r</span><span class="o">.</span><span class="n">tl</span><span class="p">,</span> <span class="n">t1</span><span class="p">)</span>
<span class="n">print_descr</span><span class="p">(</span><span class="n">annot</span><span class="p">)</span>

<span class="c1"># Adding text marker annotations:</span>
<span class="c1"># first insert a unique text, then search for it, then mark it</span>
<span class="n">pos</span> <span class="o">=</span> <span class="n">annot</span><span class="o">.</span><span class="n">rect</span><span class="o">.</span><span class="n">tl</span> <span class="o">+</span> <span class="n">displ</span><span class="o">.</span><span class="n">tl</span>
<span class="n">page</span><span class="o">.</span><span class="n">insert_text</span><span class="p">(</span>
    <span class="n">pos</span><span class="p">,</span>  <span class="c1"># insertion point</span>
    <span class="n">highlight</span><span class="p">,</span>  <span class="c1"># inserted text</span>
    <span class="n">morph</span><span class="o">=</span><span class="p">(</span><span class="n">pos</span><span class="p">,</span> <span class="n">fitz</span><span class="o">.</span><span class="n">Matrix</span><span class="p">(</span><span class="o">-</span><span class="mi">5</span><span class="p">)),</span>  <span class="c1"># rotate around insertion point</span>
<span class="p">)</span>
<span class="n">rl</span> <span class="o">=</span> <span class="n">page</span><span class="o">.</span><span class="n">search_for</span><span class="p">(</span><span class="n">highlight</span><span class="p">,</span> <span class="n">quads</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>  <span class="c1"># need a quad b/o tilted text</span>
<span class="n">annot</span> <span class="o">=</span> <span class="n">page</span><span class="o">.</span><span class="n">addHighlightAnnot</span><span class="p">(</span><span class="n">rl</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
<span class="n">print_descr</span><span class="p">(</span><span class="n">annot</span><span class="p">)</span>

<span class="n">pos</span> <span class="o">=</span> <span class="n">annot</span><span class="o">.</span><span class="n">rect</span><span class="o">.</span><span class="n">bl</span>  <span class="c1"># next insertion point</span>
<span class="n">page</span><span class="o">.</span><span class="n">insert_text</span><span class="p">(</span><span class="n">pos</span><span class="p">,</span> <span class="n">underline</span><span class="p">,</span> <span class="n">morph</span><span class="o">=</span><span class="p">(</span><span class="n">pos</span><span class="p">,</span> <span class="n">fitz</span><span class="o">.</span><span class="n">Matrix</span><span class="p">(</span><span class="o">-</span><span class="mi">10</span><span class="p">)))</span>
<span class="n">rl</span> <span class="o">=</span> <span class="n">page</span><span class="o">.</span><span class="n">search_for</span><span class="p">(</span><span class="n">underline</span><span class="p">,</span> <span class="n">quads</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">annot</span> <span class="o">=</span> <span class="n">page</span><span class="o">.</span><span class="n">addUnderlineAnnot</span><span class="p">(</span><span class="n">rl</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
<span class="n">print_descr</span><span class="p">(</span><span class="n">annot</span><span class="p">)</span>

<span class="n">pos</span> <span class="o">=</span> <span class="n">annot</span><span class="o">.</span><span class="n">rect</span><span class="o">.</span><span class="n">bl</span>
<span class="n">page</span><span class="o">.</span><span class="n">insert_text</span><span class="p">(</span><span class="n">pos</span><span class="p">,</span> <span class="n">strikeout</span><span class="p">,</span> <span class="n">morph</span><span class="o">=</span><span class="p">(</span><span class="n">pos</span><span class="p">,</span> <span class="n">fitz</span><span class="o">.</span><span class="n">Matrix</span><span class="p">(</span><span class="o">-</span><span class="mi">15</span><span class="p">)))</span>
<span class="n">rl</span> <span class="o">=</span> <span class="n">page</span><span class="o">.</span><span class="n">search_for</span><span class="p">(</span><span class="n">strikeout</span><span class="p">,</span> <span class="n">quads</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">annot</span> <span class="o">=</span> <span class="n">page</span><span class="o">.</span><span class="n">addStrikeoutAnnot</span><span class="p">(</span><span class="n">rl</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
<span class="n">print_descr</span><span class="p">(</span><span class="n">annot</span><span class="p">)</span>

<span class="n">pos</span> <span class="o">=</span> <span class="n">annot</span><span class="o">.</span><span class="n">rect</span><span class="o">.</span><span class="n">bl</span>
<span class="n">page</span><span class="o">.</span><span class="n">insert_text</span><span class="p">(</span><span class="n">pos</span><span class="p">,</span> <span class="n">squiggled</span><span class="p">,</span> <span class="n">morph</span><span class="o">=</span><span class="p">(</span><span class="n">pos</span><span class="p">,</span> <span class="n">fitz</span><span class="o">.</span><span class="n">Matrix</span><span class="p">(</span><span class="o">-</span><span class="mi">20</span><span class="p">)))</span>
<span class="n">rl</span> <span class="o">=</span> <span class="n">page</span><span class="o">.</span><span class="n">search_for</span><span class="p">(</span><span class="n">squiggled</span><span class="p">,</span> <span class="n">quads</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">annot</span> <span class="o">=</span> <span class="n">page</span><span class="o">.</span><span class="n">addSquigglyAnnot</span><span class="p">(</span><span class="n">rl</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
<span class="n">print_descr</span><span class="p">(</span><span class="n">annot</span><span class="p">)</span>

<span class="n">pos</span> <span class="o">=</span> <span class="n">annot</span><span class="o">.</span><span class="n">rect</span><span class="o">.</span><span class="n">bl</span>
<span class="n">r</span> <span class="o">=</span> <span class="n">fitz</span><span class="o">.</span><span class="n">Rect</span><span class="p">(</span><span class="n">pos</span><span class="p">,</span> <span class="n">pos</span><span class="o">.</span><span class="n">x</span> <span class="o">+</span> <span class="mi">75</span><span class="p">,</span> <span class="n">pos</span><span class="o">.</span><span class="n">y</span> <span class="o">+</span> <span class="mi">35</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">20</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">20</span><span class="p">)</span>
<span class="n">annot</span> <span class="o">=</span> <span class="n">page</span><span class="o">.</span><span class="n">addPolylineAnnot</span><span class="p">([</span><span class="n">r</span><span class="o">.</span><span class="n">bl</span><span class="p">,</span> <span class="n">r</span><span class="o">.</span><span class="n">tr</span><span class="p">,</span> <span class="n">r</span><span class="o">.</span><span class="n">br</span><span class="p">,</span> <span class="n">r</span><span class="o">.</span><span class="n">tl</span><span class="p">])</span>  <span class="c1"># &#39;Polyline&#39;</span>
<span class="n">annot</span><span class="o">.</span><span class="n">set_border</span><span class="p">(</span><span class="n">width</span><span class="o">=</span><span class="mf">0.3</span><span class="p">,</span> <span class="n">dashes</span><span class="o">=</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
<span class="n">annot</span><span class="o">.</span><span class="n">set_colors</span><span class="p">(</span><span class="n">stroke</span><span class="o">=</span><span class="n">blue</span><span class="p">,</span> <span class="n">fill</span><span class="o">=</span><span class="n">green</span><span class="p">)</span>
<span class="n">annot</span><span class="o">.</span><span class="n">set_line_ends</span><span class="p">(</span><span class="n">fitz</span><span class="o">.</span><span class="n">PDF_ANNOT_LE_CLOSED_ARROW</span><span class="p">,</span> <span class="n">fitz</span><span class="o">.</span><span class="n">PDF_ANNOT_LE_R_CLOSED_ARROW</span><span class="p">)</span>
<span class="n">annot</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">fill_color</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
<span class="n">print_descr</span><span class="p">(</span><span class="n">annot</span><span class="p">)</span>

<span class="n">r</span> <span class="o">+=</span> <span class="n">displ</span>
<span class="n">annot</span> <span class="o">=</span> <span class="n">page</span><span class="o">.</span><span class="n">addPolygonAnnot</span><span class="p">([</span><span class="n">r</span><span class="o">.</span><span class="n">bl</span><span class="p">,</span> <span class="n">r</span><span class="o">.</span><span class="n">tr</span><span class="p">,</span> <span class="n">r</span><span class="o">.</span><span class="n">br</span><span class="p">,</span> <span class="n">r</span><span class="o">.</span><span class="n">tl</span><span class="p">])</span>  <span class="c1"># &#39;Polygon&#39;</span>
<span class="n">annot</span><span class="o">.</span><span class="n">set_border</span><span class="p">(</span><span class="n">width</span><span class="o">=</span><span class="mf">0.3</span><span class="p">,</span> <span class="n">dashes</span><span class="o">=</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
<span class="n">annot</span><span class="o">.</span><span class="n">set_colors</span><span class="p">(</span><span class="n">stroke</span><span class="o">=</span><span class="n">blue</span><span class="p">,</span> <span class="n">fill</span><span class="o">=</span><span class="n">gold</span><span class="p">)</span>
<span class="n">annot</span><span class="o">.</span><span class="n">set_line_ends</span><span class="p">(</span><span class="n">fitz</span><span class="o">.</span><span class="n">PDF_ANNOT_LE_DIAMOND</span><span class="p">,</span> <span class="n">fitz</span><span class="o">.</span><span class="n">PDF_ANNOT_LE_CIRCLE</span><span class="p">)</span>
<span class="n">annot</span><span class="o">.</span><span class="n">update</span><span class="p">()</span>
<span class="n">print_descr</span><span class="p">(</span><span class="n">annot</span><span class="p">)</span>

<span class="n">r</span> <span class="o">+=</span> <span class="n">displ</span>
<span class="n">annot</span> <span class="o">=</span> <span class="n">page</span><span class="o">.</span><span class="n">addLineAnnot</span><span class="p">(</span><span class="n">r</span><span class="o">.</span><span class="n">tr</span><span class="p">,</span> <span class="n">r</span><span class="o">.</span><span class="n">bl</span><span class="p">)</span>  <span class="c1"># &#39;Line&#39;</span>
<span class="n">annot</span><span class="o">.</span><span class="n">set_border</span><span class="p">(</span><span class="n">width</span><span class="o">=</span><span class="mf">0.3</span><span class="p">,</span> <span class="n">dashes</span><span class="o">=</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
<span class="n">annot</span><span class="o">.</span><span class="n">set_colors</span><span class="p">(</span><span class="n">stroke</span><span class="o">=</span><span class="n">blue</span><span class="p">,</span> <span class="n">fill</span><span class="o">=</span><span class="n">gold</span><span class="p">)</span>
<span class="n">annot</span><span class="o">.</span><span class="n">set_line_ends</span><span class="p">(</span><span class="n">fitz</span><span class="o">.</span><span class="n">PDF_ANNOT_LE_DIAMOND</span><span class="p">,</span> <span class="n">fitz</span><span class="o">.</span><span class="n">PDF_ANNOT_LE_CIRCLE</span><span class="p">)</span>
<span class="n">annot</span><span class="o">.</span><span class="n">update</span><span class="p">()</span>
<span class="n">print_descr</span><span class="p">(</span><span class="n">annot</span><span class="p">)</span>

<span class="n">r</span> <span class="o">+=</span> <span class="n">displ</span>
<span class="n">annot</span> <span class="o">=</span> <span class="n">page</span><span class="o">.</span><span class="n">addRectAnnot</span><span class="p">(</span><span class="n">r</span><span class="p">)</span>  <span class="c1"># &#39;Square&#39;</span>
<span class="n">annot</span><span class="o">.</span><span class="n">set_border</span><span class="p">(</span><span class="n">width</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">dashes</span><span class="o">=</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">])</span>
<span class="n">annot</span><span class="o">.</span><span class="n">set_colors</span><span class="p">(</span><span class="n">stroke</span><span class="o">=</span><span class="n">blue</span><span class="p">,</span> <span class="n">fill</span><span class="o">=</span><span class="n">gold</span><span class="p">)</span>
<span class="n">annot</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">opacity</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
<span class="n">print_descr</span><span class="p">(</span><span class="n">annot</span><span class="p">)</span>

<span class="n">r</span> <span class="o">+=</span> <span class="n">displ</span>
<span class="n">annot</span> <span class="o">=</span> <span class="n">page</span><span class="o">.</span><span class="n">addCircleAnnot</span><span class="p">(</span><span class="n">r</span><span class="p">)</span>  <span class="c1"># &#39;Circle&#39;</span>
<span class="n">annot</span><span class="o">.</span><span class="n">set_border</span><span class="p">(</span><span class="n">width</span><span class="o">=</span><span class="mf">0.3</span><span class="p">,</span> <span class="n">dashes</span><span class="o">=</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
<span class="n">annot</span><span class="o">.</span><span class="n">set_colors</span><span class="p">(</span><span class="n">stroke</span><span class="o">=</span><span class="n">blue</span><span class="p">,</span> <span class="n">fill</span><span class="o">=</span><span class="n">gold</span><span class="p">)</span>
<span class="n">annot</span><span class="o">.</span><span class="n">update</span><span class="p">()</span>
<span class="n">print_descr</span><span class="p">(</span><span class="n">annot</span><span class="p">)</span>

<span class="n">r</span> <span class="o">+=</span> <span class="n">displ</span>
<span class="n">annot</span> <span class="o">=</span> <span class="n">page</span><span class="o">.</span><span class="n">addFileAnnot</span><span class="p">(</span>
    <span class="n">r</span><span class="o">.</span><span class="n">tl</span><span class="p">,</span> <span class="sa">b</span><span class="s2">&quot;just anything for testing&quot;</span><span class="p">,</span> <span class="s2">&quot;testdata.txt&quot;</span>  <span class="c1"># &#39;FileAttachment&#39;</span>
<span class="p">)</span>
<span class="n">print_descr</span><span class="p">(</span><span class="n">annot</span><span class="p">)</span>  <span class="c1"># annot.rect</span>

<span class="n">r</span> <span class="o">+=</span> <span class="n">displ</span>
<span class="n">annot</span> <span class="o">=</span> <span class="n">page</span><span class="o">.</span><span class="n">addStampAnnot</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">stamp</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>  <span class="c1"># &#39;Stamp&#39;</span>
<span class="n">annot</span><span class="o">.</span><span class="n">set_colors</span><span class="p">(</span><span class="n">stroke</span><span class="o">=</span><span class="n">green</span><span class="p">)</span>
<span class="n">annot</span><span class="o">.</span><span class="n">update</span><span class="p">()</span>
<span class="n">print_descr</span><span class="p">(</span><span class="n">annot</span><span class="p">)</span>

<span class="n">r</span> <span class="o">+=</span> <span class="n">displ</span> <span class="o">+</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">50</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span>
<span class="n">rc</span> <span class="o">=</span> <span class="n">page</span><span class="o">.</span><span class="n">insert_textbox</span><span class="p">(</span>
    <span class="n">r</span><span class="p">,</span>
    <span class="s2">&quot;This content will be removed upon applying the redaction.&quot;</span><span class="p">,</span>
    <span class="n">color</span><span class="o">=</span><span class="n">blue</span><span class="p">,</span>
    <span class="n">align</span><span class="o">=</span><span class="n">fitz</span><span class="o">.</span><span class="n">TEXT_ALIGN_CENTER</span><span class="p">,</span>
<span class="p">)</span>
<span class="n">annot</span> <span class="o">=</span> <span class="n">page</span><span class="o">.</span><span class="n">addRedactAnnot</span><span class="p">(</span><span class="n">r</span><span class="p">)</span>
<span class="n">print_descr</span><span class="p">(</span><span class="n">annot</span><span class="p">)</span>

<span class="n">doc</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="vm">__file__</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;.py&quot;</span><span class="p">,</span> <span class="s2">&quot;-</span><span class="si">%i</span><span class="s2">.pdf&quot;</span> <span class="o">%</span> <span class="n">page</span><span class="o">.</span><span class="n">rotation</span><span class="p">),</span> <span class="n">deflate</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
<p>This script should lead to the following output:</p>
<a class="reference internal image-reference" href="_images/img-annots.jpg"><img alt="_images/img-annots.jpg" src="_images/img-annots.jpg" style="width: 296.8px; height: 656.0px;" /></a>
</div>
<hr class="docutils" />
<div class="section" id="how-to-use-freetext">
<h3>How to Use FreeText<a class="headerlink" href="#how-to-use-freetext" title="Permalink to this headline">¶</a></h3>
<p>This script shows a couple of ways to deal with ‘FreeText’ annotations:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># -*- coding: utf-8 -*-</span>
<span class="kn">import</span> <span class="nn">fitz</span>

<span class="c1"># some colors</span>
<span class="n">blue</span>  <span class="o">=</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
<span class="n">green</span> <span class="o">=</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span>
<span class="n">red</span>   <span class="o">=</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span>
<span class="n">gold</span>  <span class="o">=</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span>

<span class="c1"># a new PDF with 1 page</span>
<span class="n">doc</span> <span class="o">=</span> <span class="n">fitz</span><span class="o">.</span><span class="n">open</span><span class="p">()</span>
<span class="n">page</span> <span class="o">=</span> <span class="n">doc</span><span class="o">.</span><span class="n">new_page</span><span class="p">()</span>

<span class="c1"># 3 rectangles, same size, above each other</span>
<span class="n">r1</span> <span class="o">=</span> <span class="n">fitz</span><span class="o">.</span><span class="n">Rect</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span><span class="mi">100</span><span class="p">,</span><span class="mi">200</span><span class="p">,</span><span class="mi">150</span><span class="p">)</span>
<span class="n">r2</span> <span class="o">=</span> <span class="n">r1</span> <span class="o">+</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">75</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">75</span><span class="p">)</span>
<span class="n">r3</span> <span class="o">=</span> <span class="n">r2</span> <span class="o">+</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">75</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">75</span><span class="p">)</span>

<span class="c1"># the text, Latin alphabet</span>
<span class="n">t</span> <span class="o">=</span> <span class="s2">&quot;¡Un pequeño texto para practicar!&quot;</span>

<span class="c1"># add 3 annots, modify the last one somewhat</span>
<span class="n">a1</span> <span class="o">=</span> <span class="n">page</span><span class="o">.</span><span class="n">addFreetextAnnot</span><span class="p">(</span><span class="n">r1</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">red</span><span class="p">)</span>
<span class="n">a2</span> <span class="o">=</span> <span class="n">page</span><span class="o">.</span><span class="n">addFreetextAnnot</span><span class="p">(</span><span class="n">r2</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">fontname</span><span class="o">=</span><span class="s2">&quot;Ti&quot;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">blue</span><span class="p">)</span>
<span class="n">a3</span> <span class="o">=</span> <span class="n">page</span><span class="o">.</span><span class="n">addFreetextAnnot</span><span class="p">(</span><span class="n">r3</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">fontname</span><span class="o">=</span><span class="s2">&quot;Co&quot;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">blue</span><span class="p">,</span> <span class="n">rotate</span><span class="o">=</span><span class="mi">90</span><span class="p">)</span>
<span class="n">a3</span><span class="o">.</span><span class="n">set_border</span><span class="p">(</span><span class="n">width</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">a3</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">fontsize</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span> <span class="n">fill_color</span><span class="o">=</span><span class="n">gold</span><span class="p">)</span>

<span class="c1"># save the PDF</span>
<span class="n">doc</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="s2">&quot;a-freetext.pdf&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p>The result looks like this:</p>
<a class="reference internal image-reference" href="_images/img-freetext.jpg"><img alt="_images/img-freetext.jpg" src="_images/img-freetext.jpg" style="width: 155.20000000000002px; height: 288.0px;" /></a>
</div>
<hr class="docutils" />
<div class="section" id="using-buttons-and-javascript">
<h3>Using Buttons and JavaScript<a class="headerlink" href="#using-buttons-and-javascript" title="Permalink to this headline">¶</a></h3>
<p>Since MuPDF v1.16, ‘FreeText’ annotations no longer support bold or italic versions of the Times-Roman, Helvetica or Courier fonts.</p>
<p>A big <strong>thank you</strong> to our user <a class="reference external" href="https://github.com/kurokawaikki">&#64;kurokawaikki</a>, who contributed the following script to <strong>circumvent this restriction</strong>.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Problem: Since MuPDF v1.16 a &#39;Freetext&#39; annotation font is restricted to the</span>
<span class="sd">&quot;normal&quot; versions (no bold, no italics) of Times-Roman, Helvetica, Courier.</span>
<span class="sd">It is impossible to use PyMuPDF to modify this.</span>

<span class="sd">Solution: Using Adobe&#39;s JavaScript API, it is possible to manipulate properties</span>
<span class="sd">of Freetext annotations. Check out these references:</span>
<span class="sd">https://www.adobe.com/content/dam/acom/en/devnet/acrobat/pdfs/js_api_reference.pdf,</span>
<span class="sd">or https://www.adobe.com/devnet/acrobat/documentation.html.</span>

<span class="sd">Function &#39;this.getAnnots()&#39;  will return all annotations  as an array. We loop</span>
<span class="sd">over this array to set the properties of the text through the &#39;richContents&#39;</span>
<span class="sd">attribute.</span>
<span class="sd">There is no explicit property to set text to bold, but it is possible to set</span>
<span class="sd">fontWeight=800 (400 is the normal size) of richContents.</span>
<span class="sd">Other attributes, like color, italics, etc. can also be set via richContents.</span>

<span class="sd">If we have &#39;FreeText&#39; annotations created with PyMuPDF, we can make use of this</span>
<span class="sd">JavaScript feature to modify the font - thus circumventing the above restriction.</span>

<span class="sd">Use PyMuPDF v1.16.12 to create a push button that executes a Javascript</span>
<span class="sd">containing the desired code. This is what this program does.</span>
<span class="sd">Then open the resulting file with Adobe reader (!).</span>
<span class="sd">After clicking on the button, all Freetext annotations will be bold, and the</span>
<span class="sd">file can be saved.</span>
<span class="sd">If desired, the button can be removed again, using free tools like PyMuPDF or</span>
<span class="sd">PDF XChange editor.</span>

<span class="sd">Note / Caution:</span>
<span class="sd">---------------</span>
<span class="sd">The JavaScript will **only** work if the file is opened with Adobe Acrobat reader!</span>
<span class="sd">When using other PDF viewers, the reaction is unforeseeable.</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="kn">import</span> <span class="nn">sys</span>

<span class="kn">import</span> <span class="nn">fitz</span>

<span class="c1"># this JavaScript will execute when the button is clicked:</span>
<span class="n">jscript</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">var annt = this.getAnnots();</span>
<span class="s2">annt.forEach(function (item, index) {</span>
<span class="s2">    try {</span>
<span class="s2">        var span = item.richContents;</span>
<span class="s2">        span.forEach(function (it, dx) {</span>
<span class="s2">            it.fontWeight = 800;</span>
<span class="s2">        })</span>
<span class="s2">        item.richContents = span;</span>
<span class="s2">    } catch (err) </span><span class="si">{}</span><span class="s2"></span>
<span class="s2">});</span>
<span class="s2">app.alert(&#39;Done&#39;);</span>
<span class="s2">&quot;&quot;&quot;</span>
<span class="n">i_fn</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>  <span class="c1"># input file name</span>
<span class="n">o_fn</span> <span class="o">=</span> <span class="s2">&quot;bold-&quot;</span> <span class="o">+</span> <span class="n">i_fn</span>  <span class="c1"># output filename</span>
<span class="n">doc</span> <span class="o">=</span> <span class="n">fitz</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">i_fn</span><span class="p">)</span>  <span class="c1"># open input</span>
<span class="n">page</span> <span class="o">=</span> <span class="n">doc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>  <span class="c1"># get desired page</span>

<span class="c1"># ------------------------------------------------</span>
<span class="c1"># make a push button for invoking the JavaScript</span>
<span class="c1"># ------------------------------------------------</span>

<span class="n">widget</span> <span class="o">=</span> <span class="n">fitz</span><span class="o">.</span><span class="n">Widget</span><span class="p">()</span>  <span class="c1"># create widget</span>

<span class="c1"># make it a &#39;PushButton&#39;</span>
<span class="n">widget</span><span class="o">.</span><span class="n">field_type</span> <span class="o">=</span> <span class="n">fitz</span><span class="o">.</span><span class="n">PDF_WIDGET_TYPE_BUTTON</span>
<span class="n">widget</span><span class="o">.</span><span class="n">field_flags</span> <span class="o">=</span> <span class="n">fitz</span><span class="o">.</span><span class="n">PDF_BTN_FIELD_IS_PUSHBUTTON</span>

<span class="n">widget</span><span class="o">.</span><span class="n">rect</span> <span class="o">=</span> <span class="n">fitz</span><span class="o">.</span><span class="n">Rect</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">20</span><span class="p">,</span> <span class="mi">20</span><span class="p">)</span>  <span class="c1"># button position</span>

<span class="n">widget</span><span class="o">.</span><span class="n">script</span> <span class="o">=</span> <span class="n">jscript</span>  <span class="c1"># fill in JavaScript source text</span>
<span class="n">widget</span><span class="o">.</span><span class="n">field_name</span> <span class="o">=</span> <span class="s2">&quot;Make bold&quot;</span>  <span class="c1"># arbitrary name</span>
<span class="n">widget</span><span class="o">.</span><span class="n">field_value</span> <span class="o">=</span> <span class="s2">&quot;Off&quot;</span>  <span class="c1"># arbitrary value</span>
<span class="n">widget</span><span class="o">.</span><span class="n">fill_color</span> <span class="o">=</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>  <span class="c1"># make button visible</span>

<span class="n">annot</span> <span class="o">=</span> <span class="n">page</span><span class="o">.</span><span class="n">addWidget</span><span class="p">(</span><span class="n">widget</span><span class="p">)</span>  <span class="c1"># add the widget to the page</span>
<span class="n">doc</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">o_fn</span><span class="p">)</span>  <span class="c1"># output the file</span>

</pre></div>
</div>
</div>
<hr class="docutils" />
<div class="section" id="how-to-use-ink-annotations">
<h3>How to Use Ink Annotations<a class="headerlink" href="#how-to-use-ink-annotations" title="Permalink to this headline">¶</a></h3>
<p>Ink annotations are used to contain freehand scribbling. A typical example maybe an image of your signature consisting of first name and last name. Technically an ink annotation is implemented as a <strong>list of lists of points</strong>. Each point list is regarded as a continuous line connecting the points. Different point lists represent independent line segments of the annotation.</p>
<p>The following script creates an ink annotation with two mathematical curves (sine and cosine function graphs) as line segments:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">math</span>
<span class="kn">import</span> <span class="nn">fitz</span>

<span class="c1">#------------------------------------------------------------------------------</span>
<span class="c1"># preliminary stuff: create function value lists for sine and cosine</span>
<span class="c1">#------------------------------------------------------------------------------</span>
<span class="n">w360</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="mi">2</span>  <span class="c1"># go through full circle</span>
<span class="n">deg</span> <span class="o">=</span> <span class="n">w360</span> <span class="o">/</span> <span class="mi">360</span>  <span class="c1"># 1 degree as radians</span>
<span class="n">rect</span> <span class="o">=</span> <span class="n">fitz</span><span class="o">.</span><span class="n">Rect</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span><span class="mi">200</span><span class="p">,</span> <span class="mi">300</span><span class="p">,</span> <span class="mi">300</span><span class="p">)</span>  <span class="c1"># use this rectangle</span>
<span class="n">first_x</span> <span class="o">=</span> <span class="n">rect</span><span class="o">.</span><span class="n">x0</span>  <span class="c1"># x starts from left</span>
<span class="n">first_y</span> <span class="o">=</span> <span class="n">rect</span><span class="o">.</span><span class="n">y0</span> <span class="o">+</span> <span class="n">rect</span><span class="o">.</span><span class="n">height</span> <span class="o">/</span> <span class="mf">2.</span>  <span class="c1"># rect middle means y = 0</span>
<span class="n">x_step</span> <span class="o">=</span> <span class="n">rect</span><span class="o">.</span><span class="n">width</span> <span class="o">/</span> <span class="mi">360</span>  <span class="c1"># rect width means 360 degrees</span>
<span class="n">y_scale</span> <span class="o">=</span> <span class="n">rect</span><span class="o">.</span><span class="n">height</span> <span class="o">/</span> <span class="mf">2.</span>  <span class="c1"># rect height means 2</span>
<span class="n">sin_points</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># sine values go here</span>
<span class="n">cos_points</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># cosine values go here</span>
<span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">362</span><span class="p">):</span>  <span class="c1"># now fill in the values</span>
    <span class="n">x_coord</span> <span class="o">=</span> <span class="n">x</span> <span class="o">*</span> <span class="n">x_step</span> <span class="o">+</span> <span class="n">first_x</span>  <span class="c1"># current x coordinate</span>
    <span class="n">y</span> <span class="o">=</span> <span class="o">-</span><span class="n">math</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">x</span> <span class="o">*</span> <span class="n">deg</span><span class="p">)</span>  <span class="c1"># sine</span>
    <span class="n">p</span> <span class="o">=</span> <span class="p">(</span><span class="n">x_coord</span><span class="p">,</span> <span class="n">y</span> <span class="o">*</span> <span class="n">y_scale</span> <span class="o">+</span> <span class="n">first_y</span><span class="p">)</span>  <span class="c1"># corresponding point</span>
    <span class="n">sin_points</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>  <span class="c1"># append</span>
    <span class="n">y</span> <span class="o">=</span> <span class="o">-</span><span class="n">math</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">x</span> <span class="o">*</span> <span class="n">deg</span><span class="p">)</span>  <span class="c1"># cosine</span>
    <span class="n">p</span> <span class="o">=</span> <span class="p">(</span><span class="n">x_coord</span><span class="p">,</span> <span class="n">y</span> <span class="o">*</span> <span class="n">y_scale</span> <span class="o">+</span> <span class="n">first_y</span><span class="p">)</span>  <span class="c1"># corresponding point</span>
    <span class="n">cos_points</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>  <span class="c1"># append</span>

<span class="c1">#------------------------------------------------------------------------------</span>
<span class="c1"># create the document with one page</span>
<span class="c1">#------------------------------------------------------------------------------</span>
<span class="n">doc</span> <span class="o">=</span> <span class="n">fitz</span><span class="o">.</span><span class="n">open</span><span class="p">()</span>  <span class="c1"># make new PDF</span>
<span class="n">page</span> <span class="o">=</span> <span class="n">doc</span><span class="o">.</span><span class="n">new_page</span><span class="p">()</span>  <span class="c1"># give it a page</span>

<span class="c1">#------------------------------------------------------------------------------</span>
<span class="c1"># add the Ink annotation, consisting of 2 curve segments</span>
<span class="c1">#------------------------------------------------------------------------------</span>
<span class="n">annot</span> <span class="o">=</span> <span class="n">page</span><span class="o">.</span><span class="n">addInkAnnot</span><span class="p">((</span><span class="n">sin_points</span><span class="p">,</span> <span class="n">cos_points</span><span class="p">))</span>
<span class="c1"># let it look a little nicer</span>
<span class="n">annot</span><span class="o">.</span><span class="n">set_border</span><span class="p">(</span><span class="n">width</span><span class="o">=</span><span class="mf">0.3</span><span class="p">,</span> <span class="n">dashes</span><span class="o">=</span><span class="p">[</span><span class="mi">1</span><span class="p">,])</span>  <span class="c1"># line thickness, some dashing</span>
<span class="n">annot</span><span class="o">.</span><span class="n">set_colors</span><span class="p">(</span><span class="n">stroke</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">))</span>  <span class="c1"># make the lines blue</span>
<span class="n">annot</span><span class="o">.</span><span class="n">update</span><span class="p">()</span>  <span class="c1"># update the appearance</span>

<span class="n">page</span><span class="o">.</span><span class="n">draw_rect</span><span class="p">(</span><span class="n">rect</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>  <span class="c1"># only to demonstrate we did OK</span>

<span class="n">doc</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="s2">&quot;a-inktest.pdf&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p>This is the result:</p>
<a class="reference internal image-reference" href="_images/img-inkannot.jpg"><img alt="_images/img-inkannot.jpg" src="_images/img-inkannot.jpg" style="width: 325.0px; height: 165.0px;" /></a>
</div>
</div>
<hr class="docutils" />
<div class="section" id="drawing-and-graphics">
<h2>Drawing and Graphics<a class="headerlink" href="#drawing-and-graphics" title="Permalink to this headline">¶</a></h2>
<p>PDF files support elementary drawing operations as part of their syntax. This includes basic geometrical objects like lines, curves, circles, rectangles including specifying colors.</p>
<p>The syntax for such operations is defined in “A Operator Summary” on page 985 of the <a class="reference internal" href="app4.html#adobemanual"><span class="std std-ref">Adobe PDF References</span></a>. Specifying these operators for a PDF page happens in its <a class="reference internal" href="glossary.html#contents" title="contents"><code class="xref py py-data docutils literal notranslate"><span class="pre">contents</span></code></a> objects.</p>
<p>PyMuPDF implements a large part of the available features via its <a class="reference internal" href="shape.html#shape"><span class="std std-ref">Shape</span></a> class, which is comparable to notions like “canvas” in other packages (e.g. <a class="reference external" href="https://pypi.org/project/reportlab/">reportlab</a>).</p>
<p>A shape is always created as a <strong>child of a page</strong>, usually with an instruction like <em>shape = page.new_shape()</em>. The class defines numerous methods that perform drawing operations on the page’s area. For example, <em>last_point = shape.draw_rect(rect)</em> draws a rectangle along the borders of a suitably defined <em>rect = fitz.Rect(…)</em>.</p>
<p>The returned <em>last_point</em> <strong>always</strong> is the <a class="reference internal" href="point.html#point"><span class="std std-ref">Point</span></a> where drawing operation ended (“last point”). Every such elementary drawing requires a subsequent <a class="reference internal" href="shape.html#Shape.finish" title="Shape.finish"><code class="xref py py-meth docutils literal notranslate"><span class="pre">Shape.finish()</span></code></a> to “close” it, but there may be multiple drawings which have one common <em>finish()</em> method.</p>
<p>In fact, <a class="reference internal" href="shape.html#Shape.finish" title="Shape.finish"><code class="xref py py-meth docutils literal notranslate"><span class="pre">Shape.finish()</span></code></a> <em>defines</em> a group of preceding draw operations to form one – potentially rather complex – graphics object. PyMuPDF provides several predefined graphics in <a class="reference external" href="https://github.com/JorjMcKie/PyMuPDF-Utilities/blob/master/shapes_and_symbols.py">shapes_and_symbols.py</a> which demonstrate how this works.</p>
<p>If you import this script, you can also directly use its graphics as in the following example:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># -*- coding: utf-8 -*-</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Created on Sun Dec  9 08:34:06 2018</span>

<span class="sd">@author: Jorj</span>
<span class="sd">@license: GNU AFFERO GPL V3</span>

<span class="sd">Create a list of available symbols defined in shapes_and_symbols.py</span>

<span class="sd">This also demonstrates an example usage: how these symbols could be used</span>
<span class="sd">as bullet-point symbols in some text.</span>

<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">import</span> <span class="nn">fitz</span>
<span class="kn">import</span> <span class="nn">shapes_and_symbols</span> <span class="k">as</span> <span class="nn">sas</span>

<span class="c1"># list of available symbol functions and their descriptions</span>
<span class="n">tlist</span> <span class="o">=</span> <span class="p">[</span>
         <span class="p">(</span><span class="n">sas</span><span class="o">.</span><span class="n">arrow</span><span class="p">,</span> <span class="s2">&quot;arrow (easy)&quot;</span><span class="p">),</span>
         <span class="p">(</span><span class="n">sas</span><span class="o">.</span><span class="n">caro</span><span class="p">,</span> <span class="s2">&quot;caro (easy)&quot;</span><span class="p">),</span>
         <span class="p">(</span><span class="n">sas</span><span class="o">.</span><span class="n">clover</span><span class="p">,</span> <span class="s2">&quot;clover (easy)&quot;</span><span class="p">),</span>
         <span class="p">(</span><span class="n">sas</span><span class="o">.</span><span class="n">diamond</span><span class="p">,</span> <span class="s2">&quot;diamond (easy)&quot;</span><span class="p">),</span>
         <span class="p">(</span><span class="n">sas</span><span class="o">.</span><span class="n">dontenter</span><span class="p">,</span> <span class="s2">&quot;do not enter (medium)&quot;</span><span class="p">),</span>
         <span class="p">(</span><span class="n">sas</span><span class="o">.</span><span class="n">frowney</span><span class="p">,</span> <span class="s2">&quot;frowney (medium)&quot;</span><span class="p">),</span>
         <span class="p">(</span><span class="n">sas</span><span class="o">.</span><span class="n">hand</span><span class="p">,</span> <span class="s2">&quot;hand (complex)&quot;</span><span class="p">),</span>
         <span class="p">(</span><span class="n">sas</span><span class="o">.</span><span class="n">heart</span><span class="p">,</span> <span class="s2">&quot;heart (easy)&quot;</span><span class="p">),</span>
         <span class="p">(</span><span class="n">sas</span><span class="o">.</span><span class="n">pencil</span><span class="p">,</span> <span class="s2">&quot;pencil (very complex)&quot;</span><span class="p">),</span>
         <span class="p">(</span><span class="n">sas</span><span class="o">.</span><span class="n">smiley</span><span class="p">,</span> <span class="s2">&quot;smiley (easy)&quot;</span><span class="p">),</span>
         <span class="p">]</span>

<span class="n">r</span> <span class="o">=</span> <span class="n">fitz</span><span class="o">.</span><span class="n">Rect</span><span class="p">(</span><span class="mi">50</span><span class="p">,</span> <span class="mi">50</span><span class="p">,</span> <span class="mi">100</span><span class="p">,</span> <span class="mi">100</span><span class="p">)</span>  <span class="c1"># first rect to contain a symbol</span>
<span class="n">d</span> <span class="o">=</span> <span class="n">fitz</span><span class="o">.</span><span class="n">Rect</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">r</span><span class="o">.</span><span class="n">height</span> <span class="o">+</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">r</span><span class="o">.</span><span class="n">height</span> <span class="o">+</span> <span class="mi">10</span><span class="p">)</span>  <span class="c1"># displacement to next rect</span>
<span class="n">p</span> <span class="o">=</span> <span class="p">(</span><span class="mi">15</span><span class="p">,</span> <span class="o">-</span><span class="n">r</span><span class="o">.</span><span class="n">height</span> <span class="o">*</span> <span class="mf">0.2</span><span class="p">)</span>  <span class="c1"># starting point of explanation text</span>
<span class="n">rlist</span> <span class="o">=</span> <span class="p">[</span><span class="n">r</span><span class="p">]</span>  <span class="c1"># rectangle list</span>

<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">tlist</span><span class="p">)):</span>  <span class="c1"># fill in all the rectangles</span>
    <span class="n">rlist</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">rlist</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">d</span><span class="p">)</span>

<span class="n">doc</span> <span class="o">=</span> <span class="n">fitz</span><span class="o">.</span><span class="n">open</span><span class="p">()</span>  <span class="c1"># create empty PDF</span>
<span class="n">page</span> <span class="o">=</span> <span class="n">doc</span><span class="o">.</span><span class="n">new_page</span><span class="p">()</span>  <span class="c1"># create an empty page</span>
<span class="n">shape</span> <span class="o">=</span> <span class="n">page</span><span class="o">.</span><span class="n">new_shape</span><span class="p">()</span>  <span class="c1"># start a Shape (canvas)</span>

<span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">r</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">rlist</span><span class="p">):</span>
    <span class="n">tlist</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">](</span><span class="n">shape</span><span class="p">,</span> <span class="n">rlist</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>  <span class="c1"># execute symbol creation</span>
    <span class="n">shape</span><span class="o">.</span><span class="n">insert_text</span><span class="p">(</span><span class="n">rlist</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">br</span> <span class="o">+</span> <span class="n">p</span><span class="p">,</span>  <span class="c1"># insert description text</span>
                   <span class="n">tlist</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span> <span class="n">fontsize</span><span class="o">=</span><span class="n">r</span><span class="o">.</span><span class="n">height</span><span class="o">/</span><span class="mf">1.2</span><span class="p">)</span>

<span class="c1"># store everything to the page&#39;s /Contents object</span>
<span class="n">shape</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>

<span class="kn">import</span> <span class="nn">os</span>
<span class="n">scriptdir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="vm">__file__</span><span class="p">)</span>
<span class="n">doc</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">scriptdir</span><span class="p">,</span> <span class="s2">&quot;symbol-list.pdf&quot;</span><span class="p">))</span>  <span class="c1"># save the PDF</span>
</pre></div>
</div>
<p>This is the script’s outcome:</p>
<a class="reference internal image-reference" href="_images/img-symbols.jpg"><img alt="_images/img-symbols.jpg" src="_images/img-symbols.jpg" style="width: 315.5px; height: 377.5px;" /></a>
</div>
<hr class="docutils" />
<div class="section" id="extracting-drawings">
<h2>Extracting Drawings<a class="headerlink" href="#extracting-drawings" title="Permalink to this headline">¶</a></h2>
<p><em>(New in v1.18.0)</em></p>
<p>The drawing commands issued by a page can be extracted. Interestingly, this is possible for <strong>all supported document types</strong> – not just PDF: so you can use it for XPS, EPUB and others as well.</p>
<p>A new page method, <a class="reference internal" href="page.html#Page.get_drawings" title="Page.get_drawings"><code class="xref py py-meth docutils literal notranslate"><span class="pre">Page.get_drawings()</span></code></a> accesses draw commands and converts them into a list of Python dictionaries. Each dictionary – called a “path” – represents a separate drawing – it may be simple like a single line, or a complex combination of lines and curves representing one of the shapes of the previous section.</p>
<p>The <em>path</em> dictionary has been designed such that it can easily be used by the <a class="reference internal" href="shape.html#shape"><span class="std std-ref">Shape</span></a> class and its methods.</p>
<p>The following is a code snippet which extracts the drawings of a page and re-draws them on a new page:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">fitz</span>
<span class="n">doc</span> <span class="o">=</span> <span class="n">fitz</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="s2">&quot;some.file&quot;</span><span class="p">)</span>
<span class="n">page</span> <span class="o">=</span> <span class="n">doc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="n">paths</span> <span class="o">=</span> <span class="n">page</span><span class="o">.</span><span class="n">get_drawings</span><span class="p">()</span>  <span class="c1"># extract existing drawings</span>
<span class="c1"># this is a list of &quot;paths&quot;, which can directly be drawn again using Shape</span>
<span class="c1"># -------------------------------------------------------------------------</span>
<span class="c1">#</span>
<span class="c1"># define some output page with the same dimensions</span>
<span class="n">outpdf</span> <span class="o">=</span> <span class="n">fitz</span><span class="o">.</span><span class="n">open</span><span class="p">()</span>
<span class="n">outpage</span> <span class="o">=</span> <span class="n">outpdf</span><span class="o">.</span><span class="n">new_page</span><span class="p">(</span><span class="n">width</span><span class="o">=</span><span class="n">page</span><span class="o">.</span><span class="n">rect</span><span class="o">.</span><span class="n">width</span><span class="p">,</span> <span class="n">height</span><span class="o">=</span><span class="n">page</span><span class="o">.</span><span class="n">rect</span><span class="o">.</span><span class="n">height</span><span class="p">)</span>
<span class="n">shape</span> <span class="o">=</span> <span class="n">outpage</span><span class="o">.</span><span class="n">new_shape</span><span class="p">()</span>  <span class="c1"># make a drawing canvas for the output page</span>
<span class="c1"># --------------------------------------</span>
<span class="c1"># loop through the paths and draw them</span>
<span class="c1"># --------------------------------------</span>
<span class="k">for</span> <span class="n">path</span> <span class="ow">in</span> <span class="n">paths</span><span class="p">:</span>
    <span class="c1"># ------------------------------------</span>
    <span class="c1"># draw each entry of the &#39;items&#39; list</span>
    <span class="c1"># ------------------------------------</span>
    <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">path</span><span class="p">[</span><span class="s2">&quot;items&quot;</span><span class="p">]:</span>  <span class="c1"># these are the draw commands</span>
        <span class="k">if</span> <span class="n">item</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;l&quot;</span><span class="p">:</span>  <span class="c1"># line</span>
            <span class="n">shape</span><span class="o">.</span><span class="n">draw_line</span><span class="p">(</span><span class="n">item</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">item</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
        <span class="k">elif</span> <span class="n">item</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;re&quot;</span><span class="p">:</span>  <span class="c1"># rectangle</span>
            <span class="n">shape</span><span class="o">.</span><span class="n">draw_rect</span><span class="p">(</span><span class="n">item</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="k">elif</span> <span class="n">item</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;c&quot;</span><span class="p">:</span>  <span class="c1"># curve</span>
            <span class="n">shape</span><span class="o">.</span><span class="n">draw_bezier</span><span class="p">(</span><span class="n">item</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">item</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">item</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="n">item</span><span class="p">[</span><span class="mi">4</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;unhandled drawing&quot;</span><span class="p">,</span> <span class="n">item</span><span class="p">)</span>
    <span class="c1"># ------------------------------------------------------</span>
    <span class="c1"># all items are drawn, now apply the common properties</span>
    <span class="c1"># to finish the path</span>
    <span class="c1"># ------------------------------------------------------</span>
    <span class="n">shape</span><span class="o">.</span><span class="n">finish</span><span class="p">(</span>
        <span class="n">fill</span><span class="o">=</span><span class="n">path</span><span class="p">[</span><span class="s2">&quot;fill&quot;</span><span class="p">],</span>  <span class="c1"># fill color</span>
        <span class="n">color</span><span class="o">=</span><span class="n">path</span><span class="p">[</span><span class="s2">&quot;color&quot;</span><span class="p">],</span>  <span class="c1"># line color</span>
        <span class="n">dashes</span><span class="o">=</span><span class="n">path</span><span class="p">[</span><span class="s2">&quot;dashes&quot;</span><span class="p">],</span>  <span class="c1"># line dashing</span>
        <span class="n">even_odd</span><span class="o">=</span><span class="n">path</span><span class="p">[</span><span class="s2">&quot;even_odd&quot;</span><span class="p">],</span>  <span class="c1"># control color of overlaps</span>
        <span class="n">closePath</span><span class="o">=</span><span class="n">path</span><span class="p">[</span><span class="s2">&quot;closePath&quot;</span><span class="p">],</span>  <span class="c1"># whether to connect last and first point</span>
        <span class="n">lineJoin</span><span class="o">=</span><span class="n">path</span><span class="p">[</span><span class="s2">&quot;lineJoin&quot;</span><span class="p">],</span>  <span class="c1"># how line joins should look like</span>
        <span class="n">lineCap</span><span class="o">=</span><span class="nb">max</span><span class="p">(</span><span class="n">path</span><span class="p">[</span><span class="s2">&quot;lineCap&quot;</span><span class="p">]),</span>  <span class="c1"># how line ends should look like</span>
        <span class="n">width</span><span class="o">=</span><span class="n">path</span><span class="p">[</span><span class="s2">&quot;width&quot;</span><span class="p">],</span>  <span class="c1"># line width</span>
        <span class="n">stroke_opacity</span><span class="o">=</span><span class="n">path</span><span class="p">[</span><span class="s2">&quot;opacity&quot;</span><span class="p">],</span>  <span class="c1"># same value for both</span>
        <span class="n">fill_opacity</span><span class="o">=</span><span class="n">path</span><span class="p">[</span><span class="s2">&quot;opacity&quot;</span><span class="p">],</span>  <span class="c1"># opacity parameters</span>
        <span class="p">)</span>
<span class="c1"># all paths processed - commit the shape to its page</span>
<span class="n">shape</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
<span class="n">outpdf</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="s2">&quot;drawings-page-0.pdf&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p>As can bee seen, there is a high congruence level with the <a class="reference internal" href="shape.html#shape"><span class="std std-ref">Shape</span></a> class. With one exception: For technical reasons <code class="docutils literal notranslate"><span class="pre">lineCap</span></code> is a tuple of 3 numbers here, whereas it is an integer in <a class="reference internal" href="shape.html#shape"><span class="std std-ref">Shape</span></a> (and in PDF). So we simply take the maximum value of that tuple.</p>
<p>Here is a comparison between input and output of an example page, created by the previous script:</p>
<a class="reference internal image-reference" href="_images/img-getdrawings.png"><img alt="_images/img-getdrawings.png" src="_images/img-getdrawings.png" style="width: 804.5px; height: 495.5px;" /></a>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>The reconstruction of graphics like shown here is not perfect. The following aspects will not be reproduced as of this version:</p>
<ul class="simple">
<li><p>Page definitions can be complex and include instructions for not showing / hiding certain areas to keep them invisible. Things like this are ignored by <a class="reference internal" href="page.html#Page.get_drawings" title="Page.get_drawings"><code class="xref py py-meth docutils literal notranslate"><span class="pre">Page.get_drawings()</span></code></a> - it will always return all paths.</p></li>
</ul>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>You can use the path list to make your own lists of e.g. all lines or all rectangles on the page, subselect them by criteria like color or position on the page etc.</p>
</div>
</div>
<hr class="docutils" />
<div class="section" id="multiprocessing">
<h2>Multiprocessing<a class="headerlink" href="#multiprocessing" title="Permalink to this headline">¶</a></h2>
<p>MuPDF has no integrated support for threading - they call themselves “threading-agnostic”. While there do exist tricky possibilities to still use threading with MuPDF, the baseline consequence for <strong>PyMuPDF</strong> is:</p>
<p><strong>No Python threading support</strong>.</p>
<p>Using PyMuPDF in a Python threading environment will lead to blocking effects for the main thread.</p>
<p>However, there exists the option to use Python’s <em>multiprocessing</em> module in a variety of ways.</p>
<p>If you are looking to speed up page-oriented processing for a large document, use this script as a starting point. It should be at least twice as fast as the corresponding sequential processing.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Demonstrate the use of multiprocessing with PyMuPDF.</span>

<span class="sd">Depending on the  number of CPUs, the document is divided in page ranges.</span>
<span class="sd">Each range is then worked on by one process.</span>
<span class="sd">The type of work would typically be text extraction or page rendering. Each</span>
<span class="sd">process must know where to put its results, because this processing pattern</span>
<span class="sd">does not include inter-process communication or data sharing.</span>

<span class="sd">Compared to sequential processing, speed improvements in range of 100% (ie.</span>
<span class="sd">twice as fast) or better can be expected.</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="kn">from</span> <span class="nn">__future__</span> <span class="kn">import</span> <span class="n">print_function</span><span class="p">,</span> <span class="n">division</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">from</span> <span class="nn">multiprocessing</span> <span class="kn">import</span> <span class="n">Pool</span><span class="p">,</span> <span class="n">cpu_count</span>
<span class="kn">import</span> <span class="nn">fitz</span>

<span class="c1"># choose a version specific timer function (bytes == str in Python 2)</span>
<span class="n">mytime</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">clock</span> <span class="k">if</span> <span class="nb">str</span> <span class="ow">is</span> <span class="nb">bytes</span> <span class="k">else</span> <span class="n">time</span><span class="o">.</span><span class="n">perf_counter</span>


<span class="k">def</span> <span class="nf">render_page</span><span class="p">(</span><span class="n">vector</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Render a page range of a document.</span>

<span class="sd">    Notes:</span>
<span class="sd">        The PyMuPDF document cannot be part of the argument, because that</span>
<span class="sd">        cannot be pickled. So we are being passed in just its filename.</span>
<span class="sd">        This is no performance issue, because we are a separate process and</span>
<span class="sd">        need to open the document anyway.</span>
<span class="sd">        Any page-specific function can be processed here - rendering is just</span>
<span class="sd">        an example - text extraction might be another.</span>
<span class="sd">        The work must however be self-contained: no inter-process communication</span>
<span class="sd">        or synchronization is possible with this design.</span>
<span class="sd">        Care must also be taken with which parameters are contained in the</span>
<span class="sd">        argument, because it will be passed in via pickling by the Pool class.</span>
<span class="sd">        So any large objects will increase the overall duration.</span>
<span class="sd">    Args:</span>
<span class="sd">        vector: a list containing required parameters.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># recreate the arguments</span>
    <span class="n">idx</span> <span class="o">=</span> <span class="n">vector</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>  <span class="c1"># this is the segment number we have to process</span>
    <span class="n">cpu</span> <span class="o">=</span> <span class="n">vector</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>  <span class="c1"># number of CPUs</span>
    <span class="n">filename</span> <span class="o">=</span> <span class="n">vector</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>  <span class="c1"># document filename</span>
    <span class="n">mat</span> <span class="o">=</span> <span class="n">vector</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>  <span class="c1"># the matrix for rendering</span>
    <span class="n">doc</span> <span class="o">=</span> <span class="n">fitz</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>  <span class="c1"># open the document</span>
    <span class="n">num_pages</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">doc</span><span class="p">)</span>  <span class="c1"># get number of pages</span>

    <span class="c1"># pages per segment: make sure that cpu * seg_size &gt;= num_pages!</span>
    <span class="n">seg_size</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">num_pages</span> <span class="o">/</span> <span class="n">cpu</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">seg_from</span> <span class="o">=</span> <span class="n">idx</span> <span class="o">*</span> <span class="n">seg_size</span>  <span class="c1"># our first page number</span>
    <span class="n">seg_to</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">seg_from</span> <span class="o">+</span> <span class="n">seg_size</span><span class="p">,</span> <span class="n">num_pages</span><span class="p">)</span>  <span class="c1"># last page number</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">seg_from</span><span class="p">,</span> <span class="n">seg_to</span><span class="p">):</span>  <span class="c1"># work through our page segment</span>
        <span class="n">page</span> <span class="o">=</span> <span class="n">doc</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="c1"># page.get_text(&quot;rawdict&quot;)  # use any page-related type of work here, eg</span>
        <span class="n">pix</span> <span class="o">=</span> <span class="n">page</span><span class="o">.</span><span class="n">get_pixmap</span><span class="p">(</span><span class="n">alpha</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">matrix</span><span class="o">=</span><span class="n">mat</span><span class="p">)</span>
        <span class="c1"># store away the result somewhere ...</span>
        <span class="c1"># pix.writePNG(&quot;p-%i.png&quot; % i)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Processed page numbers </span><span class="si">%i</span><span class="s2"> through </span><span class="si">%i</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">seg_from</span><span class="p">,</span> <span class="n">seg_to</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span>


<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
    <span class="n">t0</span> <span class="o">=</span> <span class="n">mytime</span><span class="p">()</span>  <span class="c1"># start a timer</span>
    <span class="n">filename</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">mat</span> <span class="o">=</span> <span class="n">fitz</span><span class="o">.</span><span class="n">Matrix</span><span class="p">(</span><span class="mf">0.2</span><span class="p">,</span> <span class="mf">0.2</span><span class="p">)</span>  <span class="c1"># the rendering matrix: scale down to 20%</span>
    <span class="n">cpu</span> <span class="o">=</span> <span class="n">cpu_count</span><span class="p">()</span>

    <span class="c1"># make vectors of arguments for the processes</span>
    <span class="n">vectors</span> <span class="o">=</span> <span class="p">[(</span><span class="n">i</span><span class="p">,</span> <span class="n">cpu</span><span class="p">,</span> <span class="n">filename</span><span class="p">,</span> <span class="n">mat</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">cpu</span><span class="p">)]</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Starting </span><span class="si">%i</span><span class="s2"> processes for &#39;</span><span class="si">%s</span><span class="s2">&#39;.&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">cpu</span><span class="p">,</span> <span class="n">filename</span><span class="p">))</span>

    <span class="n">pool</span> <span class="o">=</span> <span class="n">Pool</span><span class="p">()</span>  <span class="c1"># make pool of &#39;cpu_count()&#39; processes</span>
    <span class="n">pool</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">render_page</span><span class="p">,</span> <span class="n">vectors</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>  <span class="c1"># start processes passing each a vector</span>

    <span class="n">t1</span> <span class="o">=</span> <span class="n">mytime</span><span class="p">()</span>  <span class="c1"># stop the timer</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Total time </span><span class="si">%g</span><span class="s2"> seconds&quot;</span> <span class="o">%</span> <span class="nb">round</span><span class="p">(</span><span class="n">t1</span> <span class="o">-</span> <span class="n">t0</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span>
</pre></div>
</div>
<p>Here is a more complex example involving inter-process communication between a main process (showing a GUI) and a child process doing PyMuPDF access to a document.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Created on 2019-05-01</span>

<span class="sd">@author: yinkaisheng@live.com</span>
<span class="sd">@copyright: 2019 yinkaisheng@live.com</span>
<span class="sd">@license: GNU AFFERO GPL 3.0</span>

<span class="sd">Demonstrate the use of multiprocessing with PyMuPDF</span>
<span class="sd">-----------------------------------------------------</span>
<span class="sd">This example shows some more advanced use of multiprocessing.</span>
<span class="sd">The main process show a Qt GUI and establishes a 2-way communication with</span>
<span class="sd">another process, which accesses a supported document.</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">import</span> <span class="nn">multiprocessing</span> <span class="k">as</span> <span class="nn">mp</span>
<span class="kn">import</span> <span class="nn">queue</span>
<span class="kn">import</span> <span class="nn">fitz</span>
<span class="kn">from</span> <span class="nn">PyQt5</span> <span class="kn">import</span> <span class="n">QtCore</span><span class="p">,</span> <span class="n">QtGui</span><span class="p">,</span> <span class="n">QtWidgets</span>

<span class="n">my_timer</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">clock</span> <span class="k">if</span> <span class="nb">str</span> <span class="ow">is</span> <span class="nb">bytes</span> <span class="k">else</span> <span class="n">time</span><span class="o">.</span><span class="n">perf_counter</span>


<span class="k">class</span> <span class="nc">DocForm</span><span class="p">(</span><span class="n">QtWidgets</span><span class="o">.</span><span class="n">QWidget</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">process</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">queNum</span> <span class="o">=</span> <span class="n">mp</span><span class="o">.</span><span class="n">Queue</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">queDoc</span> <span class="o">=</span> <span class="n">mp</span><span class="o">.</span><span class="n">Queue</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">page_count</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">curPageNum</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lastDir</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">timerSend</span> <span class="o">=</span> <span class="n">QtCore</span><span class="o">.</span><span class="n">QTimer</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">timerSend</span><span class="o">.</span><span class="n">timeout</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">onTimerSendPageNum</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">timerGet</span> <span class="o">=</span> <span class="n">QtCore</span><span class="o">.</span><span class="n">QTimer</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">timerGet</span><span class="o">.</span><span class="n">timeout</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">onTimerGetPage</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">timerWaiting</span> <span class="o">=</span> <span class="n">QtCore</span><span class="o">.</span><span class="n">QTimer</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">timerWaiting</span><span class="o">.</span><span class="n">timeout</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">onTimerWaiting</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">initUI</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">initUI</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">vbox</span> <span class="o">=</span> <span class="n">QtWidgets</span><span class="o">.</span><span class="n">QVBoxLayout</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">setLayout</span><span class="p">(</span><span class="n">vbox</span><span class="p">)</span>

        <span class="n">hbox</span> <span class="o">=</span> <span class="n">QtWidgets</span><span class="o">.</span><span class="n">QHBoxLayout</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">btnOpen</span> <span class="o">=</span> <span class="n">QtWidgets</span><span class="o">.</span><span class="n">QPushButton</span><span class="p">(</span><span class="s2">&quot;OpenDocument&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">btnOpen</span><span class="o">.</span><span class="n">clicked</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">openDoc</span><span class="p">)</span>
        <span class="n">hbox</span><span class="o">.</span><span class="n">addWidget</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">btnOpen</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">btnPlay</span> <span class="o">=</span> <span class="n">QtWidgets</span><span class="o">.</span><span class="n">QPushButton</span><span class="p">(</span><span class="s2">&quot;PlayDocument&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">btnPlay</span><span class="o">.</span><span class="n">clicked</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">playDoc</span><span class="p">)</span>
        <span class="n">hbox</span><span class="o">.</span><span class="n">addWidget</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">btnPlay</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">btnStop</span> <span class="o">=</span> <span class="n">QtWidgets</span><span class="o">.</span><span class="n">QPushButton</span><span class="p">(</span><span class="s2">&quot;Stop&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">btnStop</span><span class="o">.</span><span class="n">clicked</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stopPlay</span><span class="p">)</span>
        <span class="n">hbox</span><span class="o">.</span><span class="n">addWidget</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">btnStop</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">label</span> <span class="o">=</span> <span class="n">QtWidgets</span><span class="o">.</span><span class="n">QLabel</span><span class="p">(</span><span class="s2">&quot;0/0&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">label</span><span class="o">.</span><span class="n">setFont</span><span class="p">(</span><span class="n">QtGui</span><span class="o">.</span><span class="n">QFont</span><span class="p">(</span><span class="s2">&quot;Verdana&quot;</span><span class="p">,</span> <span class="mi">20</span><span class="p">))</span>
        <span class="n">hbox</span><span class="o">.</span><span class="n">addWidget</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">label</span><span class="p">)</span>

        <span class="n">vbox</span><span class="o">.</span><span class="n">addLayout</span><span class="p">(</span><span class="n">hbox</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">labelImg</span> <span class="o">=</span> <span class="n">QtWidgets</span><span class="o">.</span><span class="n">QLabel</span><span class="p">(</span><span class="s2">&quot;Document&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span>
        <span class="n">sizePolicy</span> <span class="o">=</span> <span class="n">QtWidgets</span><span class="o">.</span><span class="n">QSizePolicy</span><span class="p">(</span>
            <span class="n">QtWidgets</span><span class="o">.</span><span class="n">QSizePolicy</span><span class="o">.</span><span class="n">Preferred</span><span class="p">,</span> <span class="n">QtWidgets</span><span class="o">.</span><span class="n">QSizePolicy</span><span class="o">.</span><span class="n">Expanding</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">labelImg</span><span class="o">.</span><span class="n">setSizePolicy</span><span class="p">(</span><span class="n">sizePolicy</span><span class="p">)</span>
        <span class="n">vbox</span><span class="o">.</span><span class="n">addWidget</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">labelImg</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">setGeometry</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span> <span class="mi">100</span><span class="p">,</span> <span class="mi">400</span><span class="p">,</span> <span class="mi">600</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">setWindowTitle</span><span class="p">(</span><span class="s2">&quot;PyMuPDF Document Player&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">openDoc</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">path</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">QtWidgets</span><span class="o">.</span><span class="n">QFileDialog</span><span class="o">.</span><span class="n">getOpenFileName</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span>
            <span class="s2">&quot;Open Document&quot;</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">lastDir</span><span class="p">,</span>
            <span class="s2">&quot;All Supported Files (*.pdf;*.epub;*.xps;*.oxps;*.cbz;*.fb2);;PDF Files (*.pdf);;EPUB Files (*.epub);;XPS Files (*.xps);;OpenXPS Files (*.oxps);;CBZ Files (*.cbz);;FB2 Files (*.fb2)&quot;</span><span class="p">,</span>
            <span class="n">options</span><span class="o">=</span><span class="n">QtWidgets</span><span class="o">.</span><span class="n">QFileDialog</span><span class="o">.</span><span class="n">Options</span><span class="p">(),</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="n">path</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">lastDir</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">process</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">queNum</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>  <span class="c1"># use -1 to notify the process to exit</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">timerSend</span><span class="o">.</span><span class="n">stop</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">curPageNum</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">page_count</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">process</span> <span class="o">=</span> <span class="n">mp</span><span class="o">.</span><span class="n">Process</span><span class="p">(</span>
                <span class="n">target</span><span class="o">=</span><span class="n">openDocInProcess</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">queNum</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">queDoc</span><span class="p">)</span>
            <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">process</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">timerGet</span><span class="o">.</span><span class="n">start</span><span class="p">(</span><span class="mi">40</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">label</span><span class="o">.</span><span class="n">setText</span><span class="p">(</span><span class="s2">&quot;0/0&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">queNum</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">startTime</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">perf_counter</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">timerWaiting</span><span class="o">.</span><span class="n">start</span><span class="p">(</span><span class="mi">40</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">playDoc</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">timerSend</span><span class="o">.</span><span class="n">start</span><span class="p">(</span><span class="mi">500</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">stopPlay</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">timerSend</span><span class="o">.</span><span class="n">stop</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">onTimerSendPageNum</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">curPageNum</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">page_count</span> <span class="o">-</span> <span class="mi">1</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">queNum</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">curPageNum</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">timerSend</span><span class="o">.</span><span class="n">stop</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">onTimerGetPage</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">ret</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">queDoc</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">ret</span><span class="p">,</span> <span class="nb">int</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">timerWaiting</span><span class="o">.</span><span class="n">stop</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">page_count</span> <span class="o">=</span> <span class="n">ret</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">label</span><span class="o">.</span><span class="n">setText</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{}</span><span class="s2">/</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">curPageNum</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">page_count</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>  <span class="c1"># tuple, pixmap info</span>
                <span class="n">num</span><span class="p">,</span> <span class="n">samples</span><span class="p">,</span> <span class="n">width</span><span class="p">,</span> <span class="n">height</span><span class="p">,</span> <span class="n">stride</span><span class="p">,</span> <span class="n">alpha</span> <span class="o">=</span> <span class="n">ret</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">curPageNum</span> <span class="o">=</span> <span class="n">num</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">label</span><span class="o">.</span><span class="n">setText</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{}</span><span class="s2">/</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">curPageNum</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">page_count</span><span class="p">))</span>
                <span class="n">fmt</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="n">QtGui</span><span class="o">.</span><span class="n">QImage</span><span class="o">.</span><span class="n">Format_RGBA8888</span>
                    <span class="k">if</span> <span class="n">alpha</span>
                    <span class="k">else</span> <span class="n">QtGui</span><span class="o">.</span><span class="n">QImage</span><span class="o">.</span><span class="n">Format_RGB888</span>
                <span class="p">)</span>
                <span class="n">qimg</span> <span class="o">=</span> <span class="n">QtGui</span><span class="o">.</span><span class="n">QImage</span><span class="p">(</span><span class="n">samples</span><span class="p">,</span> <span class="n">width</span><span class="p">,</span> <span class="n">height</span><span class="p">,</span> <span class="n">stride</span><span class="p">,</span> <span class="n">fmt</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">labelImg</span><span class="o">.</span><span class="n">setPixmap</span><span class="p">(</span><span class="n">QtGui</span><span class="o">.</span><span class="n">QPixmap</span><span class="o">.</span><span class="n">fromImage</span><span class="p">(</span><span class="n">qimg</span><span class="p">))</span>
        <span class="k">except</span> <span class="n">queue</span><span class="o">.</span><span class="n">Empty</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
            <span class="k">pass</span>

    <span class="k">def</span> <span class="nf">onTimerWaiting</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">labelImg</span><span class="o">.</span><span class="n">setText</span><span class="p">(</span>
            <span class="s1">&#39;Loading &quot;</span><span class="si">{}</span><span class="s1">&quot;, </span><span class="si">{:.2f}</span><span class="s1">s&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">file</span><span class="p">,</span> <span class="n">time</span><span class="o">.</span><span class="n">perf_counter</span><span class="p">()</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">startTime</span>
            <span class="p">)</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="nf">closeEvent</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">event</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">queNum</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">event</span><span class="o">.</span><span class="n">accept</span><span class="p">()</span>


<span class="k">def</span> <span class="nf">openDocInProcess</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">queNum</span><span class="p">,</span> <span class="n">quePageInfo</span><span class="p">):</span>
    <span class="n">start</span> <span class="o">=</span> <span class="n">my_timer</span><span class="p">()</span>
    <span class="n">doc</span> <span class="o">=</span> <span class="n">fitz</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
    <span class="n">end</span> <span class="o">=</span> <span class="n">my_timer</span><span class="p">()</span>
    <span class="n">quePageInfo</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="n">doc</span><span class="o">.</span><span class="n">page_count</span><span class="p">)</span>
    <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
        <span class="n">num</span> <span class="o">=</span> <span class="n">queNum</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">num</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">break</span>
        <span class="n">page</span> <span class="o">=</span> <span class="n">doc</span><span class="o">.</span><span class="n">load_page</span><span class="p">(</span><span class="n">num</span><span class="p">)</span>
        <span class="n">pix</span> <span class="o">=</span> <span class="n">page</span><span class="o">.</span><span class="n">get_pixmap</span><span class="p">()</span>
        <span class="n">quePageInfo</span><span class="o">.</span><span class="n">put</span><span class="p">(</span>
            <span class="p">(</span><span class="n">num</span><span class="p">,</span> <span class="n">pix</span><span class="o">.</span><span class="n">samples</span><span class="p">,</span> <span class="n">pix</span><span class="o">.</span><span class="n">width</span><span class="p">,</span> <span class="n">pix</span><span class="o">.</span><span class="n">height</span><span class="p">,</span> <span class="n">pix</span><span class="o">.</span><span class="n">stride</span><span class="p">,</span> <span class="n">pix</span><span class="o">.</span><span class="n">alpha</span><span class="p">)</span>
        <span class="p">)</span>
    <span class="n">doc</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;process exit&quot;</span><span class="p">)</span>


<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
    <span class="n">app</span> <span class="o">=</span> <span class="n">QtWidgets</span><span class="o">.</span><span class="n">QApplication</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">)</span>
    <span class="n">form</span> <span class="o">=</span> <span class="n">DocForm</span><span class="p">()</span>
    <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="n">app</span><span class="o">.</span><span class="n">exec_</span><span class="p">())</span>
</pre></div>
</div>
</div>
<hr class="docutils" />
<div class="section" id="general">
<h2>General<a class="headerlink" href="#general" title="Permalink to this headline">¶</a></h2>
<div class="section" id="how-to-open-with-a-wrong-file-extension">
<h3>How to Open with <span class="target" id="index-14"></span>a Wrong File Extension<a class="headerlink" href="#how-to-open-with-a-wrong-file-extension" title="Permalink to this headline">¶</a></h3>
<p>If you have a document with a wrong file extension for its type, you can still correctly open it.</p>
<p>Assume that “some.file” is actually an XPS. Open it like so:</p>
<div class="doctest highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">doc</span> <span class="o">=</span> <span class="n">fitz</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="s2">&quot;some.file&quot;</span><span class="p">,</span> <span class="n">filetype</span> <span class="o">=</span> <span class="s2">&quot;xps&quot;</span><span class="p">)</span>
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>MuPDF itself does not try to determine the file type from the file contents. <strong>You</strong> are responsible for supplying the filetype info in some way – either implicitly via the file extension, or explicitly as shown. There are pure Python packages like <a class="reference external" href="https://pypi.org/project/filetype/">filetype</a> that help you doing this. Also consult the <a class="reference internal" href="document.html#document"><span class="std std-ref">Document</span></a> chapter for a full description.</p>
</div>
</div>
<hr class="docutils" />
<div class="section" id="how-to-embed-or-attach-files">
<h3>How to <span class="target" id="index-15"></span>Embed or Attach Files<a class="headerlink" href="#how-to-embed-or-attach-files" title="Permalink to this headline">¶</a></h3>
<p>PDF supports incorporating arbitrary data. This can be done in one of two ways: “embedding” or “attaching”. PyMuPDF supports both options.</p>
<ol class="arabic simple">
<li><p>Attached Files: data are <strong>attached to a page</strong> by way of a <em>FileAttachment</em> annotation with this statement: <em>annot = page.addFileAnnot(pos, …)</em>, for details see <a class="reference internal" href="page.html#Page.addFileAnnot" title="Page.addFileAnnot"><code class="xref py py-meth docutils literal notranslate"><span class="pre">Page.addFileAnnot()</span></code></a>. The first parameter “pos” is the <a class="reference internal" href="point.html#point"><span class="std std-ref">Point</span></a>, where a “PushPin” icon should be placed on the page.</p></li>
<li><p>Embedded Files: data are embedded on the <strong>document level</strong> via method <a class="reference internal" href="document.html#Document.embfile_add" title="Document.embfile_add"><code class="xref py py-meth docutils literal notranslate"><span class="pre">Document.embfile_add()</span></code></a>.</p></li>
</ol>
<p>The basic differences between these options are <strong>(1)</strong> you need edit permission to embed a file, but only annotation permission to attach, <strong>(2)</strong> like all annotations, attachments are visible on a page, embedded files are not.</p>
<p>There exist several example scripts: <a class="reference external" href="https://github.com/pymupdf/PyMuPDF-Utilities/tree/master/examples/embedded-list.py">embedded-list.py</a>, <a class="reference external" href="https://github.com/pymupdf/PyMuPDF-Utilities/tree/master/demo/new-annots.py">new-annots.py</a>.</p>
<p>Also look at the sections above and at chapter <a class="reference internal" href="app3.html#appendix-3"><span class="std std-ref">Appendix 3: Considerations on Embedded Files</span></a>.</p>
<hr class="docutils" />
</div>
<div class="section" id="how-to-delete-and-re-arrange-pages">
<span id="index-16"></span><h3>How to Delete and Re-Arrange Pages<a class="headerlink" href="#how-to-delete-and-re-arrange-pages" title="Permalink to this headline">¶</a></h3>
<p>With PyMuPDF you have all options to copy, move, delete or re-arrange the pages of a PDF. Intuitive methods exist that allow you to do this on a page-by-page level, like the <a class="reference internal" href="document.html#Document.copy_page" title="Document.copy_page"><code class="xref py py-meth docutils literal notranslate"><span class="pre">Document.copy_page()</span></code></a> method.</p>
<p>Or you alternatively prepare a complete new page layout in form of a Python sequence, that contains the page numbers you want, in the sequence you want, and as many times as you want each page. The following may illustrate what can be done with <a class="reference internal" href="document.html#Document.select" title="Document.select"><code class="xref py py-meth docutils literal notranslate"><span class="pre">Document.select()</span></code></a>:</p>
<p><em>doc.select([1, 1, 1, 5, 4, 9, 9, 9, 0, 2, 2, 2])</em></p>
<p>Now let’s prepare a PDF for double-sided printing (on a printer not directly supporting this):</p>
<p>The number of pages is given by <em>len(doc)</em> (equal to <em>doc.page_count</em>). The following lists represent the even and the odd page numbers, respectively:</p>
<div class="doctest highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">p_even</span> <span class="o">=</span> <span class="p">[</span><span class="n">p</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">doc</span><span class="p">))</span> <span class="k">if</span> <span class="n">p</span> <span class="o">%</span> <span class="mi">2</span> <span class="o">==</span> <span class="mi">0</span><span class="p">]</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">p_odd</span>  <span class="o">=</span> <span class="p">[</span><span class="n">p</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">doc</span><span class="p">))</span> <span class="k">if</span> <span class="n">p</span> <span class="o">%</span> <span class="mi">2</span> <span class="o">==</span> <span class="mi">1</span><span class="p">]</span>
</pre></div>
</div>
<p>This snippet creates the respective sub documents which can then be used to print the document:</p>
<div class="doctest highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">doc</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">p_even</span><span class="p">)</span>  <span class="c1"># only the even pages left over</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">doc</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="s2">&quot;even.pdf&quot;</span><span class="p">)</span>  <span class="c1"># save the &quot;even&quot; PDF</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">doc</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>  <span class="c1"># recycle the file</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">doc</span> <span class="o">=</span> <span class="n">fitz</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">doc</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>  <span class="c1"># re-open</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">doc</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">p_odd</span><span class="p">)</span>  <span class="c1"># and do the same with the odd pages</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">doc</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="s2">&quot;odd.pdf&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p>For more information also have a look at this Wiki <a class="reference external" href="https://github.com/pymupdf/PyMuPDF/wiki/Rearranging-Pages-of-a-PDF">article</a>.</p>
<p>The following example will reverse the order of all pages (<strong>extremely fast:</strong> sub-second time for the 1310 pages of the <a class="reference internal" href="app4.html#adobemanual"><span class="std std-ref">Adobe PDF References</span></a>):</p>
<div class="doctest highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">lastPage</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">doc</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span>
<span class="gp">&gt;&gt;&gt; </span><span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">lastPage</span><span class="p">):</span>
<span class="go">        doc.move_page(lastPage, i)  # move current last page to the front</span>
</pre></div>
</div>
<p>This snippet duplicates the PDF with itself so that it will contain the pages <em>0, 1, …, n, 0, 1, …, n</em> <strong>(extremely fast and without noticeably increasing the file size!)</strong>:</p>
<div class="doctest highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">page_count</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">doc</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">page_count</span><span class="p">):</span>
<span class="go">        doc.copy_page(i)  # copy this page to after last page</span>
</pre></div>
</div>
</div>
<hr class="docutils" />
<div class="section" id="how-to-join-pdfs">
<h3>How to Join PDFs<a class="headerlink" href="#how-to-join-pdfs" title="Permalink to this headline">¶</a></h3>
<p>It is easy to join PDFs with method <a class="reference internal" href="document.html#Document.insert_pdf" title="Document.insert_pdf"><code class="xref py py-meth docutils literal notranslate"><span class="pre">Document.insert_pdf()</span></code></a>. Given open PDF documents, you can copy page ranges from one to the other. You can select the point where the copied pages should be placed, you can revert the page sequence and also change page rotation. This Wiki <a class="reference external" href="https://github.com/pymupdf/PyMuPDF/wiki/Inserting-Pages-from-other-PDFs">article</a> contains a full description.</p>
<p>The GUI script <a class="reference external" href="https://github.com/pymupdf/PyMuPDF-Utilities/tree/master/examples/PDFjoiner.py">PDFjoiner.py</a> uses this method to join a list of files while also joining the respective table of contents segments. It looks like this:</p>
<a class="reference internal image-reference" href="_images/img-pdfjoiner.jpg"><img alt="_images/img-pdfjoiner.jpg" src="_images/img-pdfjoiner.jpg" style="width: 592.8px; height: 426.59999999999997px;" /></a>
</div>
<hr class="docutils" />
<div class="section" id="how-to-add-pages">
<h3>How to Add Pages<a class="headerlink" href="#how-to-add-pages" title="Permalink to this headline">¶</a></h3>
<p>There two methods for adding new pages to a PDF: <a class="reference internal" href="document.html#Document.insert_page" title="Document.insert_page"><code class="xref py py-meth docutils literal notranslate"><span class="pre">Document.insert_page()</span></code></a> and <a class="reference internal" href="document.html#Document.new_page" title="Document.new_page"><code class="xref py py-meth docutils literal notranslate"><span class="pre">Document.new_page()</span></code></a> (and they share a common code base).</p>
<p><strong>new_page</strong></p>
<p><a class="reference internal" href="document.html#Document.new_page" title="Document.new_page"><code class="xref py py-meth docutils literal notranslate"><span class="pre">Document.new_page()</span></code></a> returns the created <a class="reference internal" href="page.html#page"><span class="std std-ref">Page</span></a> object. Here is the constructor showing defaults:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">doc</span> <span class="o">=</span> <span class="n">fitz</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="o">...</span><span class="p">)</span>  <span class="c1"># some new or existing PDF document</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">page</span> <span class="o">=</span> <span class="n">doc</span><span class="o">.</span><span class="n">new_page</span><span class="p">(</span><span class="n">to</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>  <span class="c1"># insertion point: end of document</span>
<span class="go">                       width = 595,  # page dimension: A4 portrait</span>
<span class="go">                       height = 842)</span>
</pre></div>
</div>
<p>The above could also have been achieved with the short form <em>page = doc.new_page()</em>. The <em>to</em> parameter specifies the document’s page number (0-based) <strong>in front of which</strong> to insert.</p>
<p>To create a page in <em>landscape</em> format, just exchange the width and height values.</p>
<p>Use this to create the page with another pre-defined paper format:</p>
<div class="doctest highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">w</span><span class="p">,</span> <span class="n">h</span> <span class="o">=</span> <span class="n">fitz</span><span class="o">.</span><span class="n">PaperSize</span><span class="p">(</span><span class="s2">&quot;letter-l&quot;</span><span class="p">)</span>  <span class="c1"># &#39;Letter&#39; landscape</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">page</span> <span class="o">=</span> <span class="n">doc</span><span class="o">.</span><span class="n">new_page</span><span class="p">(</span><span class="n">width</span> <span class="o">=</span> <span class="n">w</span><span class="p">,</span> <span class="n">height</span> <span class="o">=</span> <span class="n">h</span><span class="p">)</span>
</pre></div>
</div>
<p>The convenience function <a class="reference internal" href="functions.html#PaperSize" title="PaperSize"><code class="xref py py-meth docutils literal notranslate"><span class="pre">PaperSize()</span></code></a> knows over 40 industry standard paper formats to choose from. To see them, inspect dictionary <a class="reference internal" href="functions.html#paperSizes" title="paperSizes"><code class="xref py py-attr docutils literal notranslate"><span class="pre">paperSizes</span></code></a>. Pass the desired dictionary key to <a class="reference internal" href="functions.html#PaperSize" title="PaperSize"><code class="xref py py-meth docutils literal notranslate"><span class="pre">PaperSize()</span></code></a> to retrieve the paper dimensions. Upper and lower case is supported. If you append “-L” to the format name, the landscape version is returned.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Here is a 3-liner that creates a PDF with one empty page. Its file size is 470 bytes:</p>
<div class="doctest highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">doc</span> <span class="o">=</span> <span class="n">fitz</span><span class="o">.</span><span class="n">open</span><span class="p">()</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">doc</span><span class="o">.</span><span class="n">new_page</span><span class="p">()</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">doc</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="s2">&quot;A4.pdf&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<p><strong>insert_page</strong></p>
<p><a class="reference internal" href="document.html#Document.insert_page" title="Document.insert_page"><code class="xref py py-meth docutils literal notranslate"><span class="pre">Document.insert_page()</span></code></a> also inserts a new page and accepts the same parameters <em>to</em>, <em>width</em> and <em>height</em>. But it lets you also insert arbitrary text into the new page and returns the number of inserted lines:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">doc</span> <span class="o">=</span> <span class="n">fitz</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="o">...</span><span class="p">)</span>  <span class="c1"># some new or existing PDF document</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">n</span> <span class="o">=</span> <span class="n">doc</span><span class="o">.</span><span class="n">insert_page</span><span class="p">(</span><span class="n">to</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>  <span class="c1"># default insertion point</span>
<span class="go">                       text = None,  # string or sequence of strings</span>
<span class="go">                       fontsize = 11,</span>
<span class="go">                       width = 595,</span>
<span class="go">                       height = 842,</span>
<span class="go">                       fontname = &quot;Helvetica&quot;,  # default font</span>
<span class="go">                       fontfile = None,  # any font file name</span>
<span class="go">                       color = (0, 0, 0))  # text color (RGB)</span>
</pre></div>
</div>
<p>The text parameter can be a (sequence of) string (assuming UTF-8 encoding). Insertion will start at <a class="reference internal" href="point.html#point"><span class="std std-ref">Point</span></a> (50, 72), which is one inch below top of page and 50 points from the left. The number of inserted text lines is returned. See the method definition for more details.</p>
</div>
<hr class="docutils" />
<div class="section" id="how-to-dynamically-clean-up-corrupt-pdfs">
<h3>How To Dynamically Clean Up Corrupt PDFs<a class="headerlink" href="#how-to-dynamically-clean-up-corrupt-pdfs" title="Permalink to this headline">¶</a></h3>
<p>This shows a potential use of PyMuPDF with another Python PDF library (the excellent pure Python package <a class="reference external" href="https://pypi.python.org/pypi/pdfrw">pdfrw</a> is used here as an example).</p>
<p>If a clean, non-corrupt / decompressed PDF is needed, one could dynamically invoke PyMuPDF to recover from many problems like so:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">from</span> <span class="nn">io</span> <span class="kn">import</span> <span class="n">BytesIO</span>
<span class="kn">from</span> <span class="nn">pdfrw</span> <span class="kn">import</span> <span class="n">PdfReader</span>
<span class="kn">import</span> <span class="nn">fitz</span>

<span class="c1">#---------------------------------------</span>
<span class="c1"># &#39;Tolerant&#39; PDF reader</span>
<span class="c1">#---------------------------------------</span>
<span class="k">def</span> <span class="nf">reader</span><span class="p">(</span><span class="n">fname</span><span class="p">,</span> <span class="n">password</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
    <span class="n">idata</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">fname</span><span class="p">,</span> <span class="s2">&quot;rb&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>  <span class="c1"># read the PDF into memory and</span>
    <span class="n">ibuffer</span> <span class="o">=</span> <span class="n">BytesIO</span><span class="p">(</span><span class="n">idata</span><span class="p">)</span>  <span class="c1"># convert to stream</span>
    <span class="k">if</span> <span class="n">password</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">PdfReader</span><span class="p">(</span><span class="n">ibuffer</span><span class="p">)</span>  <span class="c1"># if this works: fine!</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="k">pass</span>

    <span class="c1"># either we need a password or it is a problem-PDF</span>
    <span class="c1"># create a repaired / decompressed / decrypted version</span>
    <span class="n">doc</span> <span class="o">=</span> <span class="n">fitz</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="s2">&quot;pdf&quot;</span><span class="p">,</span> <span class="n">ibuffer</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">password</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>  <span class="c1"># decrypt if password provided</span>
        <span class="n">rc</span> <span class="o">=</span> <span class="n">doc</span><span class="o">.</span><span class="n">authenticate</span><span class="p">(</span><span class="n">password</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">rc</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;wrong password&quot;</span><span class="p">)</span>
    <span class="n">c</span> <span class="o">=</span> <span class="n">doc</span><span class="o">.</span><span class="n">tobytes</span><span class="p">(</span><span class="n">garbage</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">deflate</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">del</span> <span class="n">doc</span>  <span class="c1"># close &amp; delete doc</span>
    <span class="k">return</span> <span class="n">PdfReader</span><span class="p">(</span><span class="n">BytesIO</span><span class="p">(</span><span class="n">c</span><span class="p">))</span>  <span class="c1"># let pdfrw retry</span>
<span class="c1">#---------------------------------------</span>
<span class="c1"># Main program</span>
<span class="c1">#---------------------------------------</span>
<span class="n">pdf</span> <span class="o">=</span> <span class="n">reader</span><span class="p">(</span><span class="s2">&quot;pymupdf.pdf&quot;</span><span class="p">,</span> <span class="n">password</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="c1"># include a password if necessary</span>
<span class="nb">print</span> <span class="n">pdf</span><span class="o">.</span><span class="n">Info</span>
<span class="c1"># do further processing</span>
</pre></div>
</div>
<p>With the command line utility <em>pdftk</em> (<a class="reference external" href="https://www.pdflabs.com/tools/pdftk-the-pdf-toolkit/">available</a> for Windows only, but reported to also run under <a class="reference external" href="https://www.winehq.org/">Wine</a>) a similar result can be achieved, see <a class="reference external" href="http://www.overthere.co.uk/2013/07/22/improving-pypdf2-with-pdftk/">here</a>. However, you must invoke it as a separate process via <em>subprocess.Popen</em>, using stdin and stdout as communication vehicles.</p>
</div>
<div class="section" id="how-to-split-single-pages">
<h3>How to Split Single Pages<a class="headerlink" href="#how-to-split-single-pages" title="Permalink to this headline">¶</a></h3>
<p>This deals with splitting up pages of a PDF in arbitrary pieces. For example, you may have a PDF with <em>Letter</em> format pages which you want to print with a magnification factor of four: each page is split up in 4 pieces which each go to a separate PDF page in <em>Letter</em> format again:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Create a PDF copy with split-up pages (posterize)</span>
<span class="sd">---------------------------------------------------</span>
<span class="sd">License: GNU AFFERO GPL V3</span>
<span class="sd">(c) 2018 Jorj X. McKie</span>

<span class="sd">Usage</span>
<span class="sd">------</span>
<span class="sd">python posterize.py input.pdf</span>

<span class="sd">Result</span>
<span class="sd">-------</span>
<span class="sd">A file &quot;poster-input.pdf&quot; with 4 output pages for every input page.</span>

<span class="sd">Notes</span>
<span class="sd">-----</span>
<span class="sd">(1) Output file is chosen to have page dimensions of 1/4 of input.</span>

<span class="sd">(2) Easily adapt the example to make n pages per input, or decide per each</span>
<span class="sd">    input page or whatever.</span>

<span class="sd">Dependencies</span>
<span class="sd">------------</span>
<span class="sd">PyMuPDF 1.12.2 or later</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="kn">from</span> <span class="nn">__future__</span> <span class="kn">import</span> <span class="n">print_function</span>
<span class="kn">import</span> <span class="nn">fitz</span><span class="o">,</span> <span class="nn">sys</span>
<span class="n">infile</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>  <span class="c1"># input file name</span>
<span class="n">src</span> <span class="o">=</span> <span class="n">fitz</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">infile</span><span class="p">)</span>
<span class="n">doc</span> <span class="o">=</span> <span class="n">fitz</span><span class="o">.</span><span class="n">open</span><span class="p">()</span>  <span class="c1"># empty output PDF</span>

<span class="k">for</span> <span class="n">spage</span> <span class="ow">in</span> <span class="n">src</span><span class="p">:</span>  <span class="c1"># for each page in input</span>
    <span class="n">r</span> <span class="o">=</span> <span class="n">spage</span><span class="o">.</span><span class="n">rect</span>  <span class="c1"># input page rectangle</span>
    <span class="n">d</span> <span class="o">=</span> <span class="n">fitz</span><span class="o">.</span><span class="n">Rect</span><span class="p">(</span><span class="n">spage</span><span class="o">.</span><span class="n">cropbox_position</span><span class="p">,</span>  <span class="c1"># CropBox displacement if not</span>
                  <span class="n">spage</span><span class="o">.</span><span class="n">cropbox_position</span><span class="p">)</span>  <span class="c1"># starting at (0, 0)</span>
    <span class="c1">#--------------------------------------------------------------------------</span>
    <span class="c1"># example: cut input page into 2 x 2 parts</span>
    <span class="c1">#--------------------------------------------------------------------------</span>
    <span class="n">r1</span> <span class="o">=</span> <span class="n">r</span> <span class="o">/</span> <span class="mi">2</span>  <span class="c1"># top left rect</span>
    <span class="n">r2</span> <span class="o">=</span> <span class="n">r1</span> <span class="o">+</span> <span class="p">(</span><span class="n">r1</span><span class="o">.</span><span class="n">width</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">r1</span><span class="o">.</span><span class="n">width</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>  <span class="c1"># top right rect</span>
    <span class="n">r3</span> <span class="o">=</span> <span class="n">r1</span> <span class="o">+</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">r1</span><span class="o">.</span><span class="n">height</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">r1</span><span class="o">.</span><span class="n">height</span><span class="p">)</span>  <span class="c1"># bottom left rect</span>
    <span class="n">r4</span> <span class="o">=</span> <span class="n">fitz</span><span class="o">.</span><span class="n">Rect</span><span class="p">(</span><span class="n">r1</span><span class="o">.</span><span class="n">br</span><span class="p">,</span> <span class="n">r</span><span class="o">.</span><span class="n">br</span><span class="p">)</span>  <span class="c1"># bottom right rect</span>
    <span class="n">rect_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">r1</span><span class="p">,</span> <span class="n">r2</span><span class="p">,</span> <span class="n">r3</span><span class="p">,</span> <span class="n">r4</span><span class="p">]</span>  <span class="c1"># put them in a list</span>

    <span class="k">for</span> <span class="n">rx</span> <span class="ow">in</span> <span class="n">rect_list</span><span class="p">:</span>  <span class="c1"># run thru rect list</span>
        <span class="n">rx</span> <span class="o">+=</span> <span class="n">d</span>  <span class="c1"># add the CropBox displacement</span>
        <span class="n">page</span> <span class="o">=</span> <span class="n">doc</span><span class="o">.</span><span class="n">new_page</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span>  <span class="c1"># new output page with rx dimensions</span>
                           <span class="n">width</span> <span class="o">=</span> <span class="n">rx</span><span class="o">.</span><span class="n">width</span><span class="p">,</span>
                           <span class="n">height</span> <span class="o">=</span> <span class="n">rx</span><span class="o">.</span><span class="n">height</span><span class="p">)</span>
        <span class="n">page</span><span class="o">.</span><span class="n">show_pdf_page</span><span class="p">(</span>
                <span class="n">page</span><span class="o">.</span><span class="n">rect</span><span class="p">,</span>  <span class="c1"># fill all new page with the image</span>
                <span class="n">src</span><span class="p">,</span>  <span class="c1"># input document</span>
                <span class="n">spage</span><span class="o">.</span><span class="n">number</span><span class="p">,</span>  <span class="c1"># input page number</span>
                <span class="n">clip</span> <span class="o">=</span> <span class="n">rx</span><span class="p">,</span>  <span class="c1"># which part to use of input page</span>
            <span class="p">)</span>

<span class="c1"># that&#39;s it, save output file</span>
<span class="n">doc</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="s2">&quot;poster-&quot;</span> <span class="o">+</span> <span class="n">src</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
         <span class="n">garbage</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span>  <span class="c1"># eliminate duplicate objects</span>
         <span class="n">deflate</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>  <span class="c1"># compress stuff where possible</span>
<span class="p">)</span>
</pre></div>
</div>
<p>This shows what happens to an input page:</p>
<img alt="_images/img-posterize.png" src="_images/img-posterize.png" />
</div>
<hr class="docutils" />
<div class="section" id="how-to-combine-single-pages">
<h3>How to Combine Single Pages<a class="headerlink" href="#how-to-combine-single-pages" title="Permalink to this headline">¶</a></h3>
<p>This deals with joining PDF pages to form a new PDF with pages each combining two or four original ones (also called “2-up”, “4-up”, etc.). This could be used to create booklets or thumbnail-like overviews:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">Copy an input PDF to output combining every 4 pages</span>
<span class="sd">---------------------------------------------------</span>
<span class="sd">License: GNU AFFERO GPL V3</span>
<span class="sd">(c) 2018 Jorj X. McKie</span>

<span class="sd">Usage</span>
<span class="sd">------</span>
<span class="sd">python 4up.py input.pdf</span>

<span class="sd">Result</span>
<span class="sd">-------</span>
<span class="sd">A file &quot;4up-input.pdf&quot; with 1 output page for every 4 input pages.</span>

<span class="sd">Notes</span>
<span class="sd">-----</span>
<span class="sd">(1) Output file is chosen to have A4 portrait pages. Input pages are scaled</span>
<span class="sd">    maintaining side proportions. Both can be changed, e.g. based on input</span>
<span class="sd">    page size. However, note that not all pages need to have the same size, etc.</span>

<span class="sd">(2) Easily adapt the example to combine just 2 pages (like for a booklet) or</span>
<span class="sd">    make the output page dimension dependent on input, or whatever.</span>

<span class="sd">Dependencies</span>
<span class="sd">-------------</span>
<span class="sd">PyMuPDF 1.12.1 or later</span>
<span class="sd">&#39;&#39;&#39;</span>
<span class="kn">from</span> <span class="nn">__future__</span> <span class="kn">import</span> <span class="n">print_function</span>
<span class="kn">import</span> <span class="nn">fitz</span><span class="o">,</span> <span class="nn">sys</span>
<span class="n">infile</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
<span class="n">src</span> <span class="o">=</span> <span class="n">fitz</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">infile</span><span class="p">)</span>
<span class="n">doc</span> <span class="o">=</span> <span class="n">fitz</span><span class="o">.</span><span class="n">open</span><span class="p">()</span>  <span class="c1"># empty output PDF</span>

<span class="n">width</span><span class="p">,</span> <span class="n">height</span> <span class="o">=</span> <span class="n">fitz</span><span class="o">.</span><span class="n">PaperSize</span><span class="p">(</span><span class="s2">&quot;a4&quot;</span><span class="p">)</span>  <span class="c1"># A4 portrait output page format</span>
<span class="n">r</span> <span class="o">=</span> <span class="n">fitz</span><span class="o">.</span><span class="n">Rect</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">width</span><span class="p">,</span> <span class="n">height</span><span class="p">)</span>

<span class="c1"># define the 4 rectangles per page</span>
<span class="n">r1</span> <span class="o">=</span> <span class="n">r</span> <span class="o">/</span> <span class="mi">2</span>  <span class="c1"># top left rect</span>
<span class="n">r2</span> <span class="o">=</span> <span class="n">r1</span> <span class="o">+</span> <span class="p">(</span><span class="n">r1</span><span class="o">.</span><span class="n">width</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">r1</span><span class="o">.</span><span class="n">width</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>  <span class="c1"># top right</span>
<span class="n">r3</span> <span class="o">=</span> <span class="n">r1</span> <span class="o">+</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">r1</span><span class="o">.</span><span class="n">height</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">r1</span><span class="o">.</span><span class="n">height</span><span class="p">)</span>  <span class="c1"># bottom left</span>
<span class="n">r4</span> <span class="o">=</span> <span class="n">fitz</span><span class="o">.</span><span class="n">Rect</span><span class="p">(</span><span class="n">r1</span><span class="o">.</span><span class="n">br</span><span class="p">,</span> <span class="n">r</span><span class="o">.</span><span class="n">br</span><span class="p">)</span>  <span class="c1"># bottom right</span>

<span class="c1"># put them in a list</span>
<span class="n">r_tab</span> <span class="o">=</span> <span class="p">[</span><span class="n">r1</span><span class="p">,</span> <span class="n">r2</span><span class="p">,</span> <span class="n">r3</span><span class="p">,</span> <span class="n">r4</span><span class="p">]</span>

<span class="c1"># now copy input pages to output</span>
<span class="k">for</span> <span class="n">spage</span> <span class="ow">in</span> <span class="n">src</span><span class="p">:</span>
    <span class="k">if</span> <span class="n">spage</span><span class="o">.</span><span class="n">number</span> <span class="o">%</span> <span class="mi">4</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>  <span class="c1"># create new output page</span>
        <span class="n">page</span> <span class="o">=</span> <span class="n">doc</span><span class="o">.</span><span class="n">new_page</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span>
                      <span class="n">width</span> <span class="o">=</span> <span class="n">width</span><span class="p">,</span>
                      <span class="n">height</span> <span class="o">=</span> <span class="n">height</span><span class="p">)</span>
    <span class="c1"># insert input page into the correct rectangle</span>
    <span class="n">page</span><span class="o">.</span><span class="n">show_pdf_page</span><span class="p">(</span><span class="n">r_tab</span><span class="p">[</span><span class="n">spage</span><span class="o">.</span><span class="n">number</span> <span class="o">%</span> <span class="mi">4</span><span class="p">],</span>  <span class="c1"># select output rect</span>
                     <span class="n">src</span><span class="p">,</span>  <span class="c1"># input document</span>
                     <span class="n">spage</span><span class="o">.</span><span class="n">number</span><span class="p">)</span>  <span class="c1"># input page number</span>

<span class="c1"># by all means, save new file using garbage collection and compression</span>
<span class="n">doc</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="s2">&quot;4up-&quot;</span> <span class="o">+</span> <span class="n">infile</span><span class="p">,</span> <span class="n">garbage</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">deflate</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
<p>Example effect:</p>
<img alt="_images/img-4up.png" src="_images/img-4up.png" />
</div>
<hr class="docutils" />
<div class="section" id="how-to-convert-any-document-to-pdf">
<h3>How to Convert Any Document to PDF<a class="headerlink" href="#how-to-convert-any-document-to-pdf" title="Permalink to this headline">¶</a></h3>
<p>Here is a script that converts any PyMuPDF supported document to a PDF. These include XPS, EPUB, FB2, CBZ and all image formats, including multi-page TIFF images.</p>
<p>It features maintaining any metadata, table of contents and links contained in the source document:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">__future__</span> <span class="kn">import</span> <span class="n">print_function</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Demo script: Convert input file to a PDF</span>
<span class="sd">-----------------------------------------</span>
<span class="sd">Intended for multi-page input files like XPS, EPUB etc.</span>

<span class="sd">Features:</span>
<span class="sd">---------</span>
<span class="sd">Recovery of table of contents and links of input file.</span>
<span class="sd">While this works well for bookmarks (outlines, table of contents),</span>
<span class="sd">links will only work if they are not of type &quot;LINK_NAMED&quot;.</span>
<span class="sd">This link type is skipped by the script.</span>

<span class="sd">For XPS and EPUB input, internal links however **are** of type &quot;LINK_NAMED&quot;.</span>
<span class="sd">Base library MuPDF does not resolve them to page numbers.</span>

<span class="sd">So, for anyone expert enough to know the internal structure of these</span>
<span class="sd">document types, can further interpret and resolve these link types.</span>

<span class="sd">Dependencies</span>
<span class="sd">--------------</span>
<span class="sd">PyMuPDF v1.14.0+</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">fitz</span>
<span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="n">fitz</span><span class="o">.</span><span class="n">VersionBind</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">)))</span> <span class="o">&gt;=</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">14</span><span class="p">,</span><span class="mi">0</span><span class="p">]):</span>
    <span class="k">raise</span> <span class="ne">SystemExit</span><span class="p">(</span><span class="s2">&quot;need PyMuPDF v1.14.0+&quot;</span><span class="p">)</span>
<span class="n">fn</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Converting &#39;</span><span class="si">%s</span><span class="s2">&#39; to &#39;</span><span class="si">%s</span><span class="s2">.pdf&#39;&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">fn</span><span class="p">,</span> <span class="n">fn</span><span class="p">))</span>

<span class="n">doc</span> <span class="o">=</span> <span class="n">fitz</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">fn</span><span class="p">)</span>

<span class="n">b</span> <span class="o">=</span> <span class="n">doc</span><span class="o">.</span><span class="n">convert_to_pdf</span><span class="p">()</span>  <span class="c1"># convert to pdf</span>
<span class="n">pdf</span> <span class="o">=</span> <span class="n">fitz</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="s2">&quot;pdf&quot;</span><span class="p">,</span> <span class="n">b</span><span class="p">)</span>  <span class="c1"># open as pdf</span>

<span class="n">toc</span><span class="o">=</span> <span class="n">doc</span><span class="o">.</span><span class="n">het_toc</span><span class="p">()</span>  <span class="c1"># table of contents of input</span>
<span class="n">pdf</span><span class="o">.</span><span class="n">set_toc</span><span class="p">(</span><span class="n">toc</span><span class="p">)</span>  <span class="c1"># simply set it for output</span>
<span class="n">meta</span> <span class="o">=</span> <span class="n">doc</span><span class="o">.</span><span class="n">metadata</span>  <span class="c1"># read and set metadata</span>
<span class="k">if</span> <span class="ow">not</span> <span class="n">meta</span><span class="p">[</span><span class="s2">&quot;producer&quot;</span><span class="p">]:</span>
    <span class="n">meta</span><span class="p">[</span><span class="s2">&quot;producer&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;PyMuPDF v&quot;</span> <span class="o">+</span> <span class="n">fitz</span><span class="o">.</span><span class="n">VersionBind</span>

<span class="k">if</span> <span class="ow">not</span> <span class="n">meta</span><span class="p">[</span><span class="s2">&quot;creator&quot;</span><span class="p">]:</span>
    <span class="n">meta</span><span class="p">[</span><span class="s2">&quot;creator&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;PyMuPDF PDF converter&quot;</span>
<span class="n">meta</span><span class="p">[</span><span class="s2">&quot;modDate&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">fitz</span><span class="o">.</span><span class="n">getPDFnow</span><span class="p">()</span>
<span class="n">meta</span><span class="p">[</span><span class="s2">&quot;creationDate&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">meta</span><span class="p">[</span><span class="s2">&quot;modDate&quot;</span><span class="p">]</span>
<span class="n">pdf</span><span class="o">.</span><span class="n">set_metadata</span><span class="p">(</span><span class="n">meta</span><span class="p">)</span>

<span class="c1"># now process the links</span>
<span class="n">link_cnti</span> <span class="o">=</span> <span class="mi">0</span>
<span class="n">link_skip</span> <span class="o">=</span> <span class="mi">0</span>
<span class="k">for</span> <span class="n">pinput</span> <span class="ow">in</span> <span class="n">doc</span><span class="p">:</span>  <span class="c1"># iterate through input pages</span>
    <span class="n">links</span> <span class="o">=</span> <span class="n">pinput</span><span class="o">.</span><span class="n">get_links</span><span class="p">()</span>  <span class="c1"># get list of links</span>
    <span class="n">link_cnti</span> <span class="o">+=</span> <span class="nb">len</span><span class="p">(</span><span class="n">links</span><span class="p">)</span>  <span class="c1"># count how many</span>
    <span class="n">pout</span> <span class="o">=</span> <span class="n">pdf</span><span class="p">[</span><span class="n">pinput</span><span class="o">.</span><span class="n">number</span><span class="p">]</span>  <span class="c1"># read corresp. output page</span>
    <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="n">links</span><span class="p">:</span>  <span class="c1"># iterate though the links</span>
        <span class="k">if</span> <span class="n">l</span><span class="p">[</span><span class="s2">&quot;kind&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">fitz</span><span class="o">.</span><span class="n">LINK_NAMED</span><span class="p">:</span>  <span class="c1"># we do not handle named links</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;named link page&quot;</span><span class="p">,</span> <span class="n">pinput</span><span class="o">.</span><span class="n">number</span><span class="p">,</span> <span class="n">l</span><span class="p">)</span>
            <span class="n">link_skip</span> <span class="o">+=</span> <span class="mi">1</span>  <span class="c1"># count them</span>
            <span class="k">continue</span>
        <span class="n">pout</span><span class="o">.</span><span class="n">insert_link</span><span class="p">(</span><span class="n">l</span><span class="p">)</span>  <span class="c1"># simply output the others</span>

<span class="c1"># save the conversion result</span>
<span class="n">pdf</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">fn</span> <span class="o">+</span> <span class="s2">&quot;.pdf&quot;</span><span class="p">,</span> <span class="n">garbage</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">deflate</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="c1"># say how many named links we skipped</span>
<span class="k">if</span> <span class="n">link_cnti</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Skipped </span><span class="si">%i</span><span class="s2"> named links of a total of </span><span class="si">%i</span><span class="s2"> in input.&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">link_skip</span><span class="p">,</span> <span class="n">link_cnti</span><span class="p">))</span>
</pre></div>
</div>
</div>
<hr class="docutils" />
<div class="section" id="how-to-deal-with-messages-issued-by-mupdf">
<h3>How to Deal with Messages Issued by MuPDF<a class="headerlink" href="#how-to-deal-with-messages-issued-by-mupdf" title="Permalink to this headline">¶</a></h3>
<p>Since PyMuPDF v1.16.0, <strong>error messages</strong> issued by the underlying MuPDF library are being redirected to the Python standard device <em>sys.stderr</em>. So you can handle them like any other output going to this devices.</p>
<p>In addition, these messages go to the internal buffer together with any MuPDF warnings – see below.</p>
<p>We always prefix these messages with an identifying string <em>“mupdf:”</em>.
If you prefer to not see recoverable MuPDF errors at all, issue the command <code class="docutils literal notranslate"><span class="pre">fitz.TOOLS.mupdf_display_errors(False)</span></code>.</p>
<p>MuPDF warnings continue to be stored in an internal buffer and can be viewed using <a class="reference internal" href="tools.html#Tools.mupdf_warnings" title="Tools.mupdf_warnings"><code class="xref py py-meth docutils literal notranslate"><span class="pre">Tools.mupdf_warnings()</span></code></a>.</p>
<p>Please note that MuPDF errors may or may not lead to Python exceptions. In other words, you may see error messages from which MuPDF can recover and continue processing.</p>
<p>Example output for a <strong>recoverable error</strong>. We are opening a damaged PDF, but MuPDF is able to repair it and gives us a few information on what happened. Then we illustrate how to find out whether the document can later be saved incrementally. Checking the <a class="reference internal" href="document.html#Document.is_dirty" title="Document.is_dirty"><code class="xref py py-attr docutils literal notranslate"><span class="pre">Document.is_dirty</span></code></a> attribute at this point also indicates that the open had to repair the document:</p>
<div class="doctest highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="kn">import</span> <span class="nn">fitz</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">doc</span> <span class="o">=</span> <span class="n">fitz</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="s2">&quot;damaged-file.pdf&quot;</span><span class="p">)</span>  <span class="c1"># leads to a sys.stderr message:</span>
<span class="go">mupdf: cannot find startxref</span>
<span class="gp">&gt;&gt;&gt; </span><span class="nb">print</span><span class="p">(</span><span class="n">fitz</span><span class="o">.</span><span class="n">TOOLS</span><span class="o">.</span><span class="n">mupdf_warnings</span><span class="p">())</span>  <span class="c1"># check if there is more info:</span>
<span class="go">cannot find startxref</span>
<span class="go">trying to repair broken xref</span>
<span class="go">repairing PDF document</span>
<span class="go">object missing &#39;endobj&#39; token</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">doc</span><span class="o">.</span><span class="n">can_save_incrementally</span><span class="p">()</span>  <span class="c1"># this is to be expected:</span>
<span class="go">False</span>
<span class="gp">&gt;&gt;&gt; </span><span class="c1"># the following indicates whether there are updates so far</span>
<span class="gp">&gt;&gt;&gt; </span><span class="c1"># this is the case because of the repair actions:</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">doc</span><span class="o">.</span><span class="n">is_dirty</span>
<span class="go">True</span>
<span class="gp">&gt;&gt;&gt; </span><span class="c1"># the document has nevertheless been created:</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">doc</span>
<span class="go">fitz.Document(&#39;damaged-file.pdf&#39;)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="c1"># we now know that any save must occur to a new file</span>
</pre></div>
</div>
<p>Example output for an <strong>unrecoverable error</strong>:</p>
<div class="doctest highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="kn">import</span> <span class="nn">fitz</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">doc</span> <span class="o">=</span> <span class="n">fitz</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="s2">&quot;does-not-exist.pdf&quot;</span><span class="p">)</span>
<span class="go">mupdf: cannot open does-not-exist.pdf: No such file or directory</span>
<span class="gt">Traceback (most recent call last):</span>
  File <span class="nb">&quot;&lt;pyshell#1&gt;&quot;</span>, line <span class="m">1</span>, in <span class="n">&lt;module&gt;</span>
    <span class="n">doc</span> <span class="o">=</span> <span class="n">fitz</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="s2">&quot;does-not-exist.pdf&quot;</span><span class="p">)</span>
  File <span class="nb">&quot;C:\Users\Jorj\AppData\Local\Programs\Python\Python37\lib\site-packages\fitz\fitz.py&quot;</span>, line <span class="m">2200</span>, in <span class="n">__init__</span>
    <span class="n">_fitz</span><span class="o">.</span><span class="n">Document_swiginit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">_fitz</span><span class="o">.</span><span class="n">new_Document</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">stream</span><span class="p">,</span> <span class="n">filetype</span><span class="p">,</span> <span class="n">rect</span><span class="p">,</span> <span class="n">width</span><span class="p">,</span> <span class="n">height</span><span class="p">,</span> <span class="n">fontsize</span><span class="p">))</span>
<span class="gr">RuntimeError</span>: <span class="n">cannot open does-not-exist.pdf: No such file or directory</span>
<span class="go">&gt;&gt;&gt;</span>
</pre></div>
</div>
</div>
<hr class="docutils" />
<div class="section" id="how-to-deal-with-pdf-encryption">
<h3>How to Deal with PDF Encryption<a class="headerlink" href="#how-to-deal-with-pdf-encryption" title="Permalink to this headline">¶</a></h3>
<p>Starting with version 1.16.0, PDF decryption and encryption (using passwords) are fully supported. You can do the following:</p>
<ul>
<li><p>Check whether a document is password protected / (still) encrypted (<a class="reference internal" href="document.html#Document.needs_pass" title="Document.needs_pass"><code class="xref py py-attr docutils literal notranslate"><span class="pre">Document.needs_pass</span></code></a>, <a class="reference internal" href="document.html#Document.is_encrypted" title="Document.is_encrypted"><code class="xref py py-attr docutils literal notranslate"><span class="pre">Document.is_encrypted</span></code></a>).</p></li>
<li><p>Gain access authorization to a document (<a class="reference internal" href="document.html#Document.authenticate" title="Document.authenticate"><code class="xref py py-meth docutils literal notranslate"><span class="pre">Document.authenticate()</span></code></a>).</p></li>
<li><p>Set encryption details for PDF files using <a class="reference internal" href="document.html#Document.save" title="Document.save"><code class="xref py py-meth docutils literal notranslate"><span class="pre">Document.save()</span></code></a> or <code class="xref py py-meth docutils literal notranslate"><span class="pre">Document.write()</span></code> and</p>
<blockquote>
<div><ul class="simple">
<li><p>decrypt or encrypt the content</p></li>
<li><p>set password(s)</p></li>
<li><p>set the encryption method</p></li>
<li><p>set permission details</p></li>
</ul>
</div></blockquote>
</li>
</ul>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>A PDF document may have two different passwords:</p>
<ul class="simple">
<li><p>The <strong>owner password</strong> provides full access rights, including changing passwords, encryption method, or permission detail.</p></li>
<li><p>The <strong>user password</strong> provides access to document content according to the established permission details. If present, opening the PDF in a viewer will require providing it.</p></li>
</ul>
<p>Method <a class="reference internal" href="document.html#Document.authenticate" title="Document.authenticate"><code class="xref py py-meth docutils literal notranslate"><span class="pre">Document.authenticate()</span></code></a> will automatically establish access rights according to the password used.</p>
</div>
<p>The following snippet creates a new PDF and encrypts it with separate user and owner passwords. Permissions are granted to print, copy and annotate, but no changes are allowed to someone authenticating with the user password:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">fitz</span>

<span class="n">text</span> <span class="o">=</span> <span class="s2">&quot;some secret information&quot;</span>  <span class="c1"># keep this data secret</span>
<span class="n">perm</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span>
    <span class="n">fitz</span><span class="o">.</span><span class="n">PDF_PERM_ACCESSIBILITY</span>  <span class="c1"># always use this</span>
    <span class="o">|</span> <span class="n">fitz</span><span class="o">.</span><span class="n">PDF_PERM_PRINT</span>  <span class="c1"># permit printing</span>
    <span class="o">|</span> <span class="n">fitz</span><span class="o">.</span><span class="n">PDF_PERM_COPY</span>  <span class="c1"># permit copying</span>
    <span class="o">|</span> <span class="n">fitz</span><span class="o">.</span><span class="n">PDF_PERM_ANNOTATE</span>  <span class="c1"># permit annotations</span>
<span class="p">)</span>
<span class="n">owner_pass</span> <span class="o">=</span> <span class="s2">&quot;owner&quot;</span>  <span class="c1"># owner password</span>
<span class="n">user_pass</span> <span class="o">=</span> <span class="s2">&quot;user&quot;</span>  <span class="c1"># user password</span>
<span class="n">encrypt_meth</span> <span class="o">=</span> <span class="n">fitz</span><span class="o">.</span><span class="n">PDF_ENCRYPT_AES_256</span>  <span class="c1"># strongest algorithm</span>
<span class="n">doc</span> <span class="o">=</span> <span class="n">fitz</span><span class="o">.</span><span class="n">open</span><span class="p">()</span>  <span class="c1"># empty pdf</span>
<span class="n">page</span> <span class="o">=</span> <span class="n">doc</span><span class="o">.</span><span class="n">new_page</span><span class="p">()</span>  <span class="c1"># empty page</span>
<span class="n">page</span><span class="o">.</span><span class="n">insert_text</span><span class="p">((</span><span class="mi">50</span><span class="p">,</span> <span class="mi">72</span><span class="p">),</span> <span class="n">text</span><span class="p">)</span>  <span class="c1"># insert the data</span>
<span class="n">doc</span><span class="o">.</span><span class="n">save</span><span class="p">(</span>
    <span class="s2">&quot;secret.pdf&quot;</span><span class="p">,</span>
    <span class="n">encryption</span><span class="o">=</span><span class="n">encrypt_meth</span><span class="p">,</span>  <span class="c1"># set the encryption method</span>
    <span class="n">owner_pw</span><span class="o">=</span><span class="n">owner_pass</span><span class="p">,</span>  <span class="c1"># set the owner password</span>
    <span class="n">user_pw</span><span class="o">=</span><span class="n">user_pass</span><span class="p">,</span>  <span class="c1"># set the user password</span>
    <span class="n">permissions</span><span class="o">=</span><span class="n">perm</span><span class="p">,</span>  <span class="c1"># set permissions</span>
<span class="p">)</span>
</pre></div>
</div>
<p>Opening this document with some viewer (Nitro Reader 5) reflects these settings:</p>
<a class="reference internal image-reference" href="_images/img-encrypting.jpg"><img alt="_images/img-encrypting.jpg" src="_images/img-encrypting.jpg" style="width: 299.5px; height: 322.5px;" /></a>
<p><strong>Decrypting</strong> will automatically happen on save as before when no encryption parameters are provided.</p>
<p>To <strong>keep the encryption method</strong> of a PDF save it using <em>encryption=fitz.PDF_ENCRYPT_KEEP</em>. If <em>doc.can_save_incrementally() == True</em>, an incremental save is also possible.</p>
<p>To <strong>change the encryption method</strong> specify the full range of options above (encryption, owner_pw, user_pw, permissions). An incremental save is <strong>not possible</strong> in this case.</p>
</div>
</div>
<hr class="docutils" />
<div class="section" id="common-issues-and-their-solutions">
<h2>Common Issues and their Solutions<a class="headerlink" href="#common-issues-and-their-solutions" title="Permalink to this headline">¶</a></h2>
<div class="section" id="changing-annotations-unexpected-behaviour">
<h3>Changing Annotations: Unexpected Behaviour<a class="headerlink" href="#changing-annotations-unexpected-behaviour" title="Permalink to this headline">¶</a></h3>
<div class="section" id="problem">
<h4>Problem<a class="headerlink" href="#problem" title="Permalink to this headline">¶</a></h4>
<p>There are two scenarios:</p>
<ol class="arabic simple">
<li><p><strong>Updating</strong> an annotation with PyMuPDF which was created by some other software.</p></li>
<li><p><strong>Creating</strong> an annotation with PyMuPDF and later changing it with some other software.</p></li>
</ol>
<p>In both cases you may experience unintended changes, like a different annotation icon or text font, the fill color or line dashing have disappeared, line end symbols have changed their size or even have disappeared too, etc.</p>
</div>
<div class="section" id="cause">
<h4>Cause<a class="headerlink" href="#cause" title="Permalink to this headline">¶</a></h4>
<p>Annotation maintenance is handled differently by each PDF maintenance application. Some annotation types may not be supported, or not be supported fully or some details may be handled in a different way than in another application. <strong>There is no standard.</strong></p>
<p>Almost always a PDF application also comes with its own icons (file attachments, sticky notes and stamps) and its own set of supported text fonts. For example:</p>
<ul class="simple">
<li><p>(Py-) MuPDF only supports these 5 basic fonts for ‘FreeText’ annotations: Helvetica, Times-Roman, Courier, ZapfDingbats and Symbol – no italics / no bold variations. When changing a ‘FreeText’ annotation created by some other app, its font will probably not be recognized nor accepted and be replaced by Helvetica.</p></li>
<li><p>PyMuPDF supports all PDF text markers (highlight, underline, strikeout, squiggly), but these types cannot be updated with Adobe Acrobat Reader.</p></li>
</ul>
<p>In most cases there also exists limited support for line dashing which causes existing dashes to be replaced by straight lines. For example:</p>
<ul class="simple">
<li><p>PyMuPDF fully supports all line dashing forms, while other viewers only accept a limited subset.</p></li>
</ul>
</div>
<div class="section" id="solutions">
<h4>Solutions<a class="headerlink" href="#solutions" title="Permalink to this headline">¶</a></h4>
<p>Unfortunately there is not much you can do in most of these cases.</p>
<ol class="arabic simple">
<li><p>Stay with the same software for <strong>creating and changing</strong> an annotation.</p></li>
<li><p>When using PyMuPDF to change an “alien” annotation, try to <strong>avoid</strong> <a class="reference internal" href="annot.html#Annot.update" title="Annot.update"><code class="xref py py-meth docutils literal notranslate"><span class="pre">Annot.update()</span></code></a>. The following methods <strong>can be used without it,</strong> so that the original appearance should be maintained:</p></li>
</ol>
<blockquote>
<div><ul class="simple">
<li><p><a class="reference internal" href="annot.html#Annot.set_rect" title="Annot.set_rect"><code class="xref py py-meth docutils literal notranslate"><span class="pre">Annot.set_rect()</span></code></a> (location changes)</p></li>
<li><p><a class="reference internal" href="annot.html#Annot.set_flags" title="Annot.set_flags"><code class="xref py py-meth docutils literal notranslate"><span class="pre">Annot.set_flags()</span></code></a> (annotation behaviour)</p></li>
<li><p><a class="reference internal" href="annot.html#Annot.set_info" title="Annot.set_info"><code class="xref py py-meth docutils literal notranslate"><span class="pre">Annot.set_info()</span></code></a> (meta information, except changes to <em>content</em>)</p></li>
<li><p><a class="reference internal" href="annot.html#Annot.set_popup" title="Annot.set_popup"><code class="xref py py-meth docutils literal notranslate"><span class="pre">Annot.set_popup()</span></code></a> (create popup or change its rect)</p></li>
<li><p><code class="xref py py-meth docutils literal notranslate"><span class="pre">Annot.set_optional_content()</span></code> (add / remove reference to optional content information)</p></li>
<li><p><a class="reference internal" href="annot.html#Annot.set_open" title="Annot.set_open"><code class="xref py py-meth docutils literal notranslate"><span class="pre">Annot.set_open()</span></code></a></p></li>
<li><p><a class="reference internal" href="annot.html#Annot.update_file" title="Annot.update_file"><code class="xref py py-meth docutils literal notranslate"><span class="pre">Annot.update_file()</span></code></a> (file attachment changes)</p></li>
</ul>
</div></blockquote>
</div>
</div>
<div class="section" id="misplaced-item-insertions-on-pdf-pages">
<h3>Misplaced Item Insertions on PDF Pages<a class="headerlink" href="#misplaced-item-insertions-on-pdf-pages" title="Permalink to this headline">¶</a></h3>
<div class="section" id="id7">
<h4>Problem<a class="headerlink" href="#id7" title="Permalink to this headline">¶</a></h4>
<p>You inserted an item (like an image, an annotation or some text) on an existing PDF page, but later you find it being placed at a different location than intended. For example an image should be inserted at the top, but it unexpectedly appears near the bottom of the page.</p>
</div>
<div class="section" id="id8">
<h4>Cause<a class="headerlink" href="#id8" title="Permalink to this headline">¶</a></h4>
<p>The creator of the PDF has established a non-standard page geometry without keeping it “local” (as they should!). Most commonly, the PDF standard point (0,0) at <em>bottom-left</em> has been changed to the <em>top-left</em> point. So top and bottom are reversed – causing your insertion to be misplaced.</p>
<p>The visible image of a PDF page is controlled by commands coded in a special mini-language. For an overview of this language consult “Operator Summary” on pp. 985 of the <a class="reference internal" href="app4.html#adobemanual"><span class="std std-ref">Adobe PDF References</span></a>. These commands are stored in <a class="reference internal" href="glossary.html#contents" title="contents"><code class="xref py py-data docutils literal notranslate"><span class="pre">contents</span></code></a> objects as strings (<em>bytes</em> in PyMuPDF).</p>
<p>There are commands in that language, which change the coordinate system of the page for all the following commands. In order to limit the scope of such commands local, they must be wrapped by the command pair <em>q</em> (“save graphics state”, or “stack”) and <em>Q</em> (“restore graphics state”, or “unstack”).</p>
<p>So the PDF creator did this:</p>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>stream
1 0 0 -1 0 792 cm    % &lt;=== change of coordinate system:
...                  % letter page, top / bottom reversed
...                  % remains active beyond these lines
endstream
</pre></div>
</div>
<p>where they should have done this:</p>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>stream
q                    % put the following in a stack
1 0 0 -1 0 792 cm    % &lt;=== scope of this is limited by Q command
...                  % here, a different geometry exists
Q                    % after this line, geometry of outer scope prevails
endstream
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<ul class="simple">
<li><p>In the mini-language’s syntax, spaces and line breaks are equally accepted token delimiters.</p></li>
<li><p>Multiple consecutive delimiters are treated as one.</p></li>
<li><p>Keywords “stream” and “endstream” are inserted automatically – not by the programmer.</p></li>
</ul>
</div>
</div>
<div class="section" id="id9">
<h4>Solutions<a class="headerlink" href="#id9" title="Permalink to this headline">¶</a></h4>
<p>Since v1.16.0, there is the property <a class="reference internal" href="functions.html#Page.is_wrapped" title="Page.is_wrapped"><code class="xref py py-attr docutils literal notranslate"><span class="pre">Page.is_wrapped</span></code></a>, which lets you check whether a page’s contents are wrapped in that string pair.</p>
<p>If it is <em>False</em> or if you want to be on the safe side, pick one of the following:</p>
<ol class="arabic simple">
<li><p>The easiest way: in your script, do a <code class="xref py py-meth docutils literal notranslate"><span class="pre">Page.cleanContents()</span></code> before you do your first item insertion.</p></li>
<li><p>Pre-process your PDF with the MuPDF command line utility <em>mutool clean -c …</em> and work with its output file instead.</p></li>
<li><p>Directly wrap the page’s <a class="reference internal" href="glossary.html#contents" title="contents"><code class="xref py py-data docutils literal notranslate"><span class="pre">contents</span></code></a> with the stacking commands before you do your first item insertion.</p></li>
</ol>
<p><strong>Solutions 1. and 2.</strong> use the same technical basis and <strong>do a lot more</strong> than what is required in this context: they also clean up other inconsistencies or redundancies that may exist, multiple <em>/Contents</em> objects will be concatenated into one, and much more.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>For <strong>incremental saves,</strong> solution 1. has an unpleasant implication: it will bloat the update delta, because it changes so many things and, in addition, stores the <strong>cleaned contents uncompressed</strong>. So, if you use <code class="xref py py-meth docutils literal notranslate"><span class="pre">Page.cleanContents()</span></code> you should consider <strong>saving to a new file</strong> with (at least) <em>garbage=3</em> and <em>deflate=True</em>.</p>
</div>
<p><strong>Solution 3.</strong> is completely under your control and only does the minimum corrective action. There exists a handy low-level utility function which you can use for this. Suggested procedure:</p>
<ul class="simple">
<li><p><strong>Prepend</strong> the missing stacking command by executing <em>fitz.TOOLS._insert_contents(page, b”qn”, False)</em>.</p></li>
<li><p><strong>Append</strong> an unstacking command by executing <em>fitz.TOOLS._insert_contents(page, b”nQ”, True)</em>.</p></li>
<li><p>Alternatively, just use <code class="xref py py-meth docutils literal notranslate"><span class="pre">Page._wrap_contents()</span></code>, which executes the previous two functions.</p></li>
</ul>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>If small incremental update deltas are a concern, this approach is the most effective. Other contents objects are not touched. The utility method creates two new PDF <a class="reference internal" href="glossary.html#stream" title="stream"><code class="xref py py-data docutils literal notranslate"><span class="pre">stream</span></code></a> objects and inserts them before, resp. after the page’s other <a class="reference internal" href="glossary.html#contents" title="contents"><code class="xref py py-data docutils literal notranslate"><span class="pre">contents</span></code></a>. We therefore recommend the following snippet to get this situation under control:</p>
<div class="doctest highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="k">if</span> <span class="ow">not</span> <span class="n">page</span><span class="o">.</span><span class="n">is_wrapped</span><span class="p">:</span>
<span class="go">        page.wrap_contents()</span>
<span class="gp">&gt;&gt;&gt; </span><span class="c1"># start inserting text, images or annotations here</span>
</pre></div>
</div>
</div>
</div>
</div>
</div>
<hr class="docutils" />
<div class="section" id="low-level-interfaces">
<h2>Low-Level Interfaces<a class="headerlink" href="#low-level-interfaces" title="Permalink to this headline">¶</a></h2>
<p>Numerous methods are available to access and manipulate PDF files on a fairly low level. Admittedly, a clear distinction between “low level” and “normal” functionality is not always possible or subject to personal taste.</p>
<p>It also may happen, that functionality previously deemed low-level is later on assessed as being part of the normal interface. This has happened in v1.14.0 for the class <a class="reference internal" href="tools.html#tools"><span class="std std-ref">Tools</span></a> – you now find it as an item in the Classes chapter.</p>
<p>Anyway – it is a matter of documentation only: in which chapter of the documentation do you find what. Everything is available always and always via the same interface.</p>
<hr class="docutils" />
<div class="section" id="how-to-iterate-through-the-xref-table">
<h3>How to Iterate through the <a class="reference internal" href="glossary.html#xref" title="xref"><code class="xref py py-data docutils literal notranslate"><span class="pre">xref</span></code></a> Table<a class="headerlink" href="#how-to-iterate-through-the-xref-table" title="Permalink to this headline">¶</a></h3>
<p>A PDF’s <a class="reference internal" href="glossary.html#xref" title="xref"><code class="xref py py-data docutils literal notranslate"><span class="pre">xref</span></code></a> table is a list of all objects defined in the file. This table may easily contain many thousand entries – the manual <a class="reference internal" href="app4.html#adobemanual"><span class="std std-ref">Adobe PDF References</span></a> for example has over 330’000 objects. Table entry “0” is reserved and must not be touched.
The following script loops through the <a class="reference internal" href="glossary.html#xref" title="xref"><code class="xref py py-data docutils literal notranslate"><span class="pre">xref</span></code></a> table and prints each object’s definition:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">xreflen</span> <span class="o">=</span> <span class="n">doc</span><span class="o">.</span><span class="n">xref_length</span><span class="p">()</span>  <span class="c1"># length of objects table</span>
<span class="gp">&gt;&gt;&gt; </span><span class="k">for</span> <span class="n">xref</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">xreflen</span><span class="p">):</span>  <span class="c1"># skip item 0!</span>
<span class="go">        print(&quot;&quot;)</span>
<span class="go">        print(&quot;object %i (stream: %s)&quot; % (xref, doc.is_stream(xref)))</span>
<span class="go">        print(doc.xref_object(i, compressed=False))</span>
</pre></div>
</div>
<p>This produces the following output:</p>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>object 1 (stream: False)
&lt;&lt;
    /ModDate (D:20170314122233-04&#39;00&#39;)
    /PXCViewerInfo (PDF-XChange Viewer;2.5.312.1;Feb  9 2015;12:00:06;D:20170314122233-04&#39;00&#39;)
&gt;&gt;

object 2 (stream: False)
&lt;&lt;
    /Type /Catalog
    /Pages 3 0 R
&gt;&gt;

object 3 (stream: False)
&lt;&lt;
    /Kids [ 4 0 R 5 0 R ]
    /Type /Pages
    /Count 2
&gt;&gt;

object 4 (stream: False)
&lt;&lt;
    /Type /Page
    /Annots [ 6 0 R ]
    /Parent 3 0 R
    /Contents 7 0 R
    /MediaBox [ 0 0 595 842 ]
    /Resources 8 0 R
&gt;&gt;
...
object 7 (stream: True)
&lt;&lt;
    /Length 494
    /Filter /FlateDecode
&gt;&gt;
...
</pre></div>
</div>
<p>A PDF object definition is an ordinary ASCII string.</p>
</div>
<hr class="docutils" />
<div class="section" id="how-to-handle-object-streams">
<h3>How to Handle Object Streams<a class="headerlink" href="#how-to-handle-object-streams" title="Permalink to this headline">¶</a></h3>
<p>Some object types contain additional data apart from their object definition. Examples are images, fonts, embedded files or commands describing the appearance of a page.</p>
<p>Objects of these types are called “stream objects”. PyMuPDF allows reading an object’s stream via method <a class="reference internal" href="document.html#Document.xref_stream" title="Document.xref_stream"><code class="xref py py-meth docutils literal notranslate"><span class="pre">Document.xref_stream()</span></code></a> with the object’s <a class="reference internal" href="glossary.html#xref" title="xref"><code class="xref py py-data docutils literal notranslate"><span class="pre">xref</span></code></a> as an argument. And it is also possible to write back a modified version of a stream using <code class="xref py py-meth docutils literal notranslate"><span class="pre">Document.updatefStream()</span></code>.</p>
<p>Assume that the following snippet wants to read all streams of a PDF for whatever reason:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">xreflen</span> <span class="o">=</span> <span class="n">doc</span><span class="o">.</span><span class="n">xref_length</span><span class="p">()</span> <span class="c1"># number of objects in file</span>
<span class="gp">&gt;&gt;&gt; </span><span class="k">for</span> <span class="n">xref</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">xreflen</span><span class="p">):</span> <span class="c1"># skip item 0!</span>
<span class="go">        if stream := doc.xref_stream(xref):</span>
<span class="go">            # do something with it (it is a bytes object or None)</span>
<span class="go">            # e.g. just write it back:</span>
<span class="go">            doc.update_stream(xref, stream)</span>
</pre></div>
</div>
<p><a class="reference internal" href="document.html#Document.xref_stream" title="Document.xref_stream"><code class="xref py py-meth docutils literal notranslate"><span class="pre">Document.xref_stream()</span></code></a> automatically returns a stream decompressed as a bytes object – and <a class="reference internal" href="document.html#Document.update_stream" title="Document.update_stream"><code class="xref py py-meth docutils literal notranslate"><span class="pre">Document.update_stream()</span></code></a> automatically compresses it if beneficial.</p>
</div>
<hr class="docutils" />
<div class="section" id="how-to-handle-page-contents">
<h3>How to Handle Page Contents<a class="headerlink" href="#how-to-handle-page-contents" title="Permalink to this headline">¶</a></h3>
<p>A PDF page can have zero or multiple <a class="reference internal" href="glossary.html#contents" title="contents"><code class="xref py py-data docutils literal notranslate"><span class="pre">contents</span></code></a> objects. These are stream objects describing <strong>what</strong> appears <strong>where</strong> on a page (like text and images). They are written in a special mini-language described e.g. in chapter “APPENDIX A - Operator Summary” on page 985 of the <a class="reference internal" href="app4.html#adobemanual"><span class="std std-ref">Adobe PDF References</span></a>.</p>
<p>Every PDF reader application must be able to interpret the contents syntax to reproduce the intended appearance of the page.</p>
<p>If multiple <a class="reference internal" href="glossary.html#contents" title="contents"><code class="xref py py-data docutils literal notranslate"><span class="pre">contents</span></code></a> objects are provided, they must be read and interpreted in the specified sequence in exactly the same way as if these streams were provided as a concatenation of the several.</p>
<p>There are good technical arguments for having multiple <a class="reference internal" href="glossary.html#contents" title="contents"><code class="xref py py-data docutils literal notranslate"><span class="pre">contents</span></code></a> objects:</p>
<ul class="simple">
<li><p>It is a lot easier and faster to just add new <a class="reference internal" href="glossary.html#contents" title="contents"><code class="xref py py-data docutils literal notranslate"><span class="pre">contents</span></code></a> objects than maintaining a single big one (which entails reading, decompressing, modifying, recompressing, and rewriting it for each change).</p></li>
<li><p>When working with incremental updates, a modified big <a class="reference internal" href="glossary.html#contents" title="contents"><code class="xref py py-data docutils literal notranslate"><span class="pre">contents</span></code></a> object will bloat the update delta and can thus easily negate the efficiency of incremental saves.</p></li>
</ul>
<p>For example, PyMuPDF adds new, small <a class="reference internal" href="glossary.html#contents" title="contents"><code class="xref py py-data docutils literal notranslate"><span class="pre">contents</span></code></a> objects in methods <a class="reference internal" href="page.html#Page.insert_image" title="Page.insert_image"><code class="xref py py-meth docutils literal notranslate"><span class="pre">Page.insert_image()</span></code></a>, <a class="reference internal" href="page.html#Page.show_pdf_page" title="Page.show_pdf_page"><code class="xref py py-meth docutils literal notranslate"><span class="pre">Page.show_pdf_page()</span></code></a> and the <a class="reference internal" href="shape.html#shape"><span class="std std-ref">Shape</span></a> methods.</p>
<p>However, there are also situations when a <strong>single</strong> <a class="reference internal" href="glossary.html#contents" title="contents"><code class="xref py py-data docutils literal notranslate"><span class="pre">contents</span></code></a> object is beneficial: it is easier to interpret and better compressible than multiple smaller ones.</p>
<p>Here are two ways of combining multiple contents of a page:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="c1"># method 1: use the clean function</span>
<span class="gp">&gt;&gt;&gt; </span><span class="k">for</span> <span class="n">page</span> <span class="ow">in</span> <span class="n">doc</span><span class="p">:</span>
<span class="go">        page.clean_contents()  # cleans and combines multiple Contents</span>
<span class="go">        xref = page.get_contents()[0]  # only one /Contents now!</span>
<span class="go">        cont = doc.xref_stream(xref)</span>
<span class="go">        # do something with the cleaned, combined contents</span>

<span class="gp">&gt;&gt;&gt; </span><span class="c1"># method 2: concatenate multiple contents yourself</span>
<span class="gp">&gt;&gt;&gt; </span><span class="k">for</span> <span class="n">page</span> <span class="ow">in</span> <span class="n">doc</span><span class="p">:</span>
<span class="go">        cont = b&quot;&quot;              # initialize contents</span>
<span class="go">        for xref in page.get_contents(): # loop through content xrefs</span>
<span class="go">            cont += doc.xref_stream(xref)</span>
<span class="go">        # do something with the combined contents</span>
</pre></div>
</div>
<p>The clean function <a class="reference internal" href="functions.html#Page.clean_contents" title="Page.clean_contents"><code class="xref py py-meth docutils literal notranslate"><span class="pre">Page.clean_contents()</span></code></a> does a lot more than just glueing <a class="reference internal" href="glossary.html#contents" title="contents"><code class="xref py py-data docutils literal notranslate"><span class="pre">contents</span></code></a> objects: it also corrects and optimizes the PDF operator syntax of the page and removes any inconsistencies with the page’s object definition.</p>
</div>
<hr class="docutils" />
<div class="section" id="how-to-access-the-pdf-catalog">
<h3>How to Access the PDF Catalog<a class="headerlink" href="#how-to-access-the-pdf-catalog" title="Permalink to this headline">¶</a></h3>
<p>This is a central (“root”) object of a PDF. It serves as a starting point to reach important other objects and it also contains some global options for the PDF:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="kn">import</span> <span class="nn">fitz</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">doc</span><span class="o">=</span><span class="n">fitz</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="s2">&quot;PyMuPDF.pdf&quot;</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">cat</span> <span class="o">=</span> <span class="n">doc</span><span class="o">.</span><span class="n">pdf_catalog</span><span class="p">()</span>  <span class="c1"># get xref of the /Catalog</span>
<span class="gp">&gt;&gt;&gt; </span><span class="nb">print</span><span class="p">(</span><span class="n">doc</span><span class="o">.</span><span class="n">xref_object</span><span class="p">(</span><span class="n">cat</span><span class="p">))</span>  <span class="c1"># print object definition</span>
<span class="go">&lt;&lt;</span>
<span class="go">    /Type/Catalog                 % object type</span>
<span class="go">    /Pages 3593 0 R               % points to page tree</span>
<span class="go">    /OpenAction 225 0 R           % action to perform on open</span>
<span class="go">    /Names 3832 0 R               % points to global names tree</span>
<span class="go">    /PageMode /UseOutlines        % initially show the TOC</span>
<span class="go">    /PageLabels&lt;&lt;/Nums[0&lt;&lt;/S/D&gt;&gt;2&lt;&lt;/S/r&gt;&gt;8&lt;&lt;/S/D&gt;&gt;]&gt;&gt; % labels given to pages</span>
<span class="go">    /Outlines 3835 0 R            % points to outline tree</span>
<span class="go">&gt;&gt;</span>
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Indentation, line breaks and comments are inserted here for clarification purposes only and will not normally appear. For more information on the PDF catalog see section 3.6.1 on page 137 of the <a class="reference internal" href="app4.html#adobemanual"><span class="std std-ref">Adobe PDF References</span></a>.</p>
</div>
</div>
<hr class="docutils" />
<div class="section" id="how-to-access-the-pdf-file-trailer">
<h3>How to Access the PDF File Trailer<a class="headerlink" href="#how-to-access-the-pdf-file-trailer" title="Permalink to this headline">¶</a></h3>
<p>The trailer of a PDF file is a <a class="reference internal" href="glossary.html#dictionary" title="dictionary"><code class="xref py py-data docutils literal notranslate"><span class="pre">dictionary</span></code></a> located towards the end of the file. It contains special objects, and pointers to important other information. See <a class="reference internal" href="app4.html#adobemanual"><span class="std std-ref">Adobe PDF References</span></a> p. 96. Here is an overview:</p>
<table class="docutils align-default">
<colgroup>
<col style="width: 7%" />
<col style="width: 11%" />
<col style="width: 82%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p><strong>Key</strong></p></th>
<th class="head"><p><strong>Type</strong></p></th>
<th class="head"><p><strong>Value</strong></p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>Size</p></td>
<td><p>int</p></td>
<td><p>Number of entries in the cross-reference table + 1.</p></td>
</tr>
<tr class="row-odd"><td><p>Prev</p></td>
<td><p>int</p></td>
<td><p>Offset to previous <a class="reference internal" href="glossary.html#xref" title="xref"><code class="xref py py-data docutils literal notranslate"><span class="pre">xref</span></code></a> section (indicates incremental updates).</p></td>
</tr>
<tr class="row-even"><td><p>Root</p></td>
<td><p>dictionary</p></td>
<td><p>(indirect) Pointer to the catalog. See previous section.</p></td>
</tr>
<tr class="row-odd"><td><p>Encrypt</p></td>
<td><p>dictionary</p></td>
<td><p>Pointer to encryption object (encrypted files only).</p></td>
</tr>
<tr class="row-even"><td><p>Info</p></td>
<td><p>dictionary</p></td>
<td><p>(indirect) Pointer to information (metadata).</p></td>
</tr>
<tr class="row-odd"><td><p>ID</p></td>
<td><p>array</p></td>
<td><p>File identifier consisting of two byte strings.</p></td>
</tr>
<tr class="row-even"><td><p>XRefStm</p></td>
<td><p>int</p></td>
<td><p>Offset of a cross-reference stream. See <a class="reference internal" href="app4.html#adobemanual"><span class="std std-ref">Adobe PDF References</span></a> p. 109.</p></td>
</tr>
</tbody>
</table>
<p>Access this information via PyMuPDF with <a class="reference internal" href="document.html#Document.pdf_trailer" title="Document.pdf_trailer"><code class="xref py py-meth docutils literal notranslate"><span class="pre">Document.pdf_trailer()</span></code></a>.</p>
<div class="doctest highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="kn">import</span> <span class="nn">fitz</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">doc</span><span class="o">=</span><span class="n">fitz</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="s2">&quot;PyMuPDF.pdf&quot;</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="nb">print</span><span class="p">(</span><span class="n">doc</span><span class="o">.</span><span class="n">pdf_trailer</span><span class="p">())</span>
<span class="go">&lt;&lt;</span>
<span class="go">/Type /XRef</span>
<span class="go">/Index [ 0 8263 ]</span>
<span class="go">/Size 8263</span>
<span class="go">/W [ 1 3 1 ]</span>
<span class="go">/Root 8260 0 R</span>
<span class="go">/Info 8261 0 R</span>
<span class="go">/ID [ &lt;4339B9CEE46C2CD28A79EBDDD67CC9B3&gt; &lt;4339B9CEE46C2CD28A79EBDDD67CC9B3&gt; ]</span>
<span class="go">/Length 19883</span>
<span class="go">/Filter /FlateDecode</span>
<span class="go">&gt;&gt;</span>
<span class="go">&gt;&gt;&gt;</span>
</pre></div>
</div>
</div>
<hr class="docutils" />
<div class="section" id="how-to-access-xml-metadata">
<h3>How to Access XML Metadata<a class="headerlink" href="#how-to-access-xml-metadata" title="Permalink to this headline">¶</a></h3>
<p>A PDF may contain XML metadata in addition to the standard metadata format. In fact, most PDF viewer or modification software adds this type of information when saving the PDF (Adobe, Nitro PDF, PDF-XChange, etc.).</p>
<p>PyMuPDF has no way to <strong>interpret or change</strong> this information directly, because it contains no XML features. XML metadata is however stored as a <a class="reference internal" href="glossary.html#stream" title="stream"><code class="xref py py-data docutils literal notranslate"><span class="pre">stream</span></code></a> object, so it can be read, modified with appropriate software and written back.</p>
<div class="doctest highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">xmlmetadata</span> <span class="o">=</span> <span class="n">doc</span><span class="o">.</span><span class="n">get_xml_metadata</span><span class="p">()</span>
<span class="gp">&gt;&gt;&gt; </span><span class="nb">print</span><span class="p">(</span><span class="n">xmlmetadata</span><span class="p">)</span>
<span class="go">&lt;?xpacket begin=&quot;\ufeff&quot; id=&quot;W5M0MpCehiHzreSzNTczkc9d&quot;?&gt;</span>
<span class="go">&lt;x:xmpmeta xmlns:x=&quot;adobe:ns:meta/&quot; x:xmptk=&quot;3.1-702&quot;&gt;</span>
<span class="go">&lt;rdf:RDF xmlns:rdf=&quot;http://www.w3.org/1999/02/22-rdf-syntax-ns#&quot;&gt;</span>
<span class="gp">...</span>
<span class="go">omitted data</span>
<span class="gp">...</span>
<span class="go">&lt;?xpacket end=&quot;w&quot;?&gt;</span>
</pre></div>
</div>
<p>Using some XML package, the XML data can be interpreted and / or modified and then stored back. The following also works, if the PDF previously had no XML metadata:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="c1"># write back modified XML metadata:</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">doc</span><span class="o">.</span><span class="n">set_xml_metadata</span><span class="p">(</span><span class="n">xmlmetadata</span><span class="p">)</span>
<span class="go">&gt;&gt;&gt;</span>
<span class="gp">&gt;&gt;&gt; </span><span class="c1"># XML metadata can be deleted like this:</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">doc</span><span class="o">.</span><span class="n">del_xml_metadata</span><span class="p">()</span>
</pre></div>
</div>
</div>
<hr class="docutils" />
<div class="section" id="how-to-read-and-update-pdf-objects">
<h3>How to Read and Update PDF Objects<a class="headerlink" href="#how-to-read-and-update-pdf-objects" title="Permalink to this headline">¶</a></h3>
<p>There also exist granular, elegant ways to access and manipulate selected PDF <a class="reference internal" href="glossary.html#dictionary" title="dictionary"><code class="xref py py-data docutils literal notranslate"><span class="pre">dictionary</span></code></a> keys.</p>
<ul>
<li><p><a class="reference internal" href="document.html#Document.xref_get_keys" title="Document.xref_get_keys"><code class="xref py py-meth docutils literal notranslate"><span class="pre">Document.xref_get_keys()</span></code></a> returns the PDF keys of the object at <a class="reference internal" href="glossary.html#xref" title="xref"><code class="xref py py-data docutils literal notranslate"><span class="pre">xref</span></code></a>:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">In</span> <span class="p">[</span><span class="mi">1</span><span class="p">]:</span> <span class="kn">import</span> <span class="nn">fitz</span>
<span class="n">In</span> <span class="p">[</span><span class="mi">2</span><span class="p">]:</span> <span class="n">doc</span> <span class="o">=</span> <span class="n">fitz</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="s2">&quot;pymupdf.pdf&quot;</span><span class="p">)</span>
<span class="n">In</span> <span class="p">[</span><span class="mi">3</span><span class="p">]:</span> <span class="n">page</span> <span class="o">=</span> <span class="n">doc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="n">In</span> <span class="p">[</span><span class="mi">4</span><span class="p">]:</span> <span class="kn">from</span> <span class="nn">pprint</span> <span class="kn">import</span> <span class="n">pprint</span>
<span class="n">In</span> <span class="p">[</span><span class="mi">5</span><span class="p">]:</span> <span class="n">pprint</span><span class="p">(</span><span class="n">doc</span><span class="o">.</span><span class="n">xref_get_keys</span><span class="p">(</span><span class="n">page</span><span class="o">.</span><span class="n">xref</span><span class="p">))</span>
<span class="p">(</span><span class="s1">&#39;Type&#39;</span><span class="p">,</span> <span class="s1">&#39;Contents&#39;</span><span class="p">,</span> <span class="s1">&#39;Resources&#39;</span><span class="p">,</span> <span class="s1">&#39;MediaBox&#39;</span><span class="p">,</span> <span class="s1">&#39;Parent&#39;</span><span class="p">)</span>
</pre></div>
</div>
</li>
<li><p>Compare with the full object definition:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">In</span> <span class="p">[</span><span class="mi">6</span><span class="p">]:</span> <span class="nb">print</span><span class="p">(</span><span class="n">doc</span><span class="o">.</span><span class="n">xref_object</span><span class="p">(</span><span class="n">page</span><span class="o">.</span><span class="n">xref</span><span class="p">))</span>
<span class="o">&lt;&lt;</span>
  <span class="o">/</span><span class="n">Type</span> <span class="o">/</span><span class="n">Page</span>
  <span class="o">/</span><span class="n">Contents</span> <span class="mi">1297</span> <span class="mi">0</span> <span class="n">R</span>
  <span class="o">/</span><span class="n">Resources</span> <span class="mi">1296</span> <span class="mi">0</span> <span class="n">R</span>
  <span class="o">/</span><span class="n">MediaBox</span> <span class="p">[</span> <span class="mi">0</span> <span class="mi">0</span> <span class="mi">612</span> <span class="mi">792</span> <span class="p">]</span>
  <span class="o">/</span><span class="n">Parent</span> <span class="mi">1301</span> <span class="mi">0</span> <span class="n">R</span>
<span class="o">&gt;&gt;</span>
</pre></div>
</div>
</li>
<li><p>Single keys can also be accessed directly via <a class="reference internal" href="document.html#Document.xref_get_key" title="Document.xref_get_key"><code class="xref py py-meth docutils literal notranslate"><span class="pre">Document.xref_get_key()</span></code></a>. The value <strong>always is a string</strong> together with type information, that helps interpreting it:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">In</span> <span class="p">[</span><span class="mi">7</span><span class="p">]:</span> <span class="n">doc</span><span class="o">.</span><span class="n">xref_get_key</span><span class="p">(</span><span class="n">page</span><span class="o">.</span><span class="n">xref</span><span class="p">,</span> <span class="s2">&quot;MediaBox&quot;</span><span class="p">)</span>
<span class="n">Out</span><span class="p">[</span><span class="mi">7</span><span class="p">]:</span> <span class="p">(</span><span class="s1">&#39;array&#39;</span><span class="p">,</span> <span class="s1">&#39;[0 0 612 792]&#39;</span><span class="p">)</span>
</pre></div>
</div>
</li>
<li><p>Here is a full listing of the above page keys:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">In</span> <span class="p">[</span><span class="mi">9</span><span class="p">]:</span> <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">doc</span><span class="o">.</span><span class="n">xref_get_keys</span><span class="p">(</span><span class="n">page</span><span class="o">.</span><span class="n">xref</span><span class="p">):</span>
<span class="o">...</span><span class="p">:</span>        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> = </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">doc</span><span class="o">.</span><span class="n">xref_get_key</span><span class="p">(</span><span class="n">page</span><span class="o">.</span><span class="n">xref</span><span class="p">,</span> <span class="n">key</span><span class="p">)))</span>
<span class="o">...</span><span class="p">:</span>
<span class="n">Type</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;name&#39;</span><span class="p">,</span> <span class="s1">&#39;/Page&#39;</span><span class="p">)</span>
<span class="n">Contents</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;xref&#39;</span><span class="p">,</span> <span class="s1">&#39;1297 0 R&#39;</span><span class="p">)</span>
<span class="n">Resources</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;xref&#39;</span><span class="p">,</span> <span class="s1">&#39;1296 0 R&#39;</span><span class="p">)</span>
<span class="n">MediaBox</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;array&#39;</span><span class="p">,</span> <span class="s1">&#39;[0 0 612 792]&#39;</span><span class="p">)</span>
<span class="n">Parent</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;xref&#39;</span><span class="p">,</span> <span class="s1">&#39;1301 0 R&#39;</span><span class="p">)</span>
</pre></div>
</div>
</li>
<li><p>An undefined key inquiry returns <code class="docutils literal notranslate"><span class="pre">('null',</span> <span class="pre">'null')</span></code> – PDF object type <code class="docutils literal notranslate"><span class="pre">null</span></code> corresponds to <code class="docutils literal notranslate"><span class="pre">None</span></code> in Python. Similar for the booleans <code class="docutils literal notranslate"><span class="pre">true</span></code> and <code class="docutils literal notranslate"><span class="pre">false</span></code>.</p></li>
<li><p>Let us add a new key to the page definition that sets its rotation to 90 degrees (you are aware that there actually exists <a class="reference internal" href="page.html#Page.set_rotation" title="Page.set_rotation"><code class="xref py py-meth docutils literal notranslate"><span class="pre">Page.set_rotation()</span></code></a> for this?):</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">In</span> <span class="p">[</span><span class="mi">11</span><span class="p">]:</span> <span class="n">doc</span><span class="o">.</span><span class="n">xref_get_key</span><span class="p">(</span><span class="n">page</span><span class="o">.</span><span class="n">xref</span><span class="p">,</span> <span class="s2">&quot;Rotate&quot;</span><span class="p">)</span>  <span class="c1"># no rotation set:</span>
<span class="n">Out</span><span class="p">[</span><span class="mi">11</span><span class="p">]:</span> <span class="p">(</span><span class="s1">&#39;null&#39;</span><span class="p">,</span> <span class="s1">&#39;null&#39;</span><span class="p">)</span>
<span class="n">In</span> <span class="p">[</span><span class="mi">12</span><span class="p">]:</span> <span class="n">doc</span><span class="o">.</span><span class="n">xref_set_key</span><span class="p">(</span><span class="n">page</span><span class="o">.</span><span class="n">xref</span><span class="p">,</span> <span class="s2">&quot;Rotate&quot;</span><span class="p">,</span> <span class="s2">&quot;90&quot;</span><span class="p">)</span>  <span class="c1"># insert a new key</span>
<span class="n">In</span> <span class="p">[</span><span class="mi">13</span><span class="p">]:</span> <span class="nb">print</span><span class="p">(</span><span class="n">doc</span><span class="o">.</span><span class="n">xref_object</span><span class="p">(</span><span class="n">page</span><span class="o">.</span><span class="n">xref</span><span class="p">))</span>  <span class="c1"># confirm success</span>
<span class="o">&lt;&lt;</span>
  <span class="o">/</span><span class="n">Type</span> <span class="o">/</span><span class="n">Page</span>
  <span class="o">/</span><span class="n">Contents</span> <span class="mi">1297</span> <span class="mi">0</span> <span class="n">R</span>
  <span class="o">/</span><span class="n">Resources</span> <span class="mi">1296</span> <span class="mi">0</span> <span class="n">R</span>
  <span class="o">/</span><span class="n">MediaBox</span> <span class="p">[</span> <span class="mi">0</span> <span class="mi">0</span> <span class="mi">612</span> <span class="mi">792</span> <span class="p">]</span>
  <span class="o">/</span><span class="n">Parent</span> <span class="mi">1301</span> <span class="mi">0</span> <span class="n">R</span>
  <span class="o">/</span><span class="n">Rotate</span> <span class="mi">90</span>
<span class="o">&gt;&gt;</span>
</pre></div>
</div>
</li>
<li><p>This method can also be used to remove a key from the <a class="reference internal" href="glossary.html#xref" title="xref"><code class="xref py py-data docutils literal notranslate"><span class="pre">xref</span></code></a> dictionary by setting its value to <code class="docutils literal notranslate"><span class="pre">null</span></code>: The following will remove the rotation specification from the page: <code class="docutils literal notranslate"><span class="pre">doc.xref_set_key(page.xref,</span> <span class="pre">&quot;Rotate&quot;,</span> <span class="pre">&quot;null&quot;)</span></code>. Similarly, to remove all links, annotations and fields from a page, use <code class="docutils literal notranslate"><span class="pre">doc.xref_set_key(page.xref,</span> <span class="pre">&quot;Annots&quot;,</span> <span class="pre">&quot;null&quot;)</span></code>. Because <code class="docutils literal notranslate"><span class="pre">Annots</span></code> by definition is an array, setting en empty array with the statement <code class="docutils literal notranslate"><span class="pre">doc.xref_set_key(page.xref,</span> <span class="pre">&quot;Annots&quot;,</span> <span class="pre">&quot;[]&quot;)</span></code> would do the same job in this case.</p></li>
<li><p>PDF dictionaries can be hierarchically nested. In the following page object definition both, <code class="docutils literal notranslate"><span class="pre">Font</span></code> and <code class="docutils literal notranslate"><span class="pre">XObject</span></code> are subdictionaries of <code class="docutils literal notranslate"><span class="pre">Resources</span></code>:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">In</span> <span class="p">[</span><span class="mi">15</span><span class="p">]:</span> <span class="nb">print</span><span class="p">(</span><span class="n">doc</span><span class="o">.</span><span class="n">xref_object</span><span class="p">(</span><span class="n">page</span><span class="o">.</span><span class="n">xref</span><span class="p">))</span>
<span class="o">&lt;&lt;</span>
  <span class="o">/</span><span class="n">Type</span> <span class="o">/</span><span class="n">Page</span>
  <span class="o">/</span><span class="n">Contents</span> <span class="mi">1297</span> <span class="mi">0</span> <span class="n">R</span>
  <span class="o">/</span><span class="n">Resources</span> <span class="o">&lt;&lt;</span>
    <span class="o">/</span><span class="n">XObject</span> <span class="o">&lt;&lt;</span>
      <span class="o">/</span><span class="n">Im1</span> <span class="mi">1291</span> <span class="mi">0</span> <span class="n">R</span>
    <span class="o">&gt;&gt;</span>
    <span class="o">/</span><span class="n">Font</span> <span class="o">&lt;&lt;</span>
      <span class="o">/</span><span class="n">F39</span> <span class="mi">1299</span> <span class="mi">0</span> <span class="n">R</span>
      <span class="o">/</span><span class="n">F40</span> <span class="mi">1300</span> <span class="mi">0</span> <span class="n">R</span>
    <span class="o">&gt;&gt;</span>
  <span class="o">&gt;&gt;</span>
  <span class="o">/</span><span class="n">MediaBox</span> <span class="p">[</span> <span class="mi">0</span> <span class="mi">0</span> <span class="mi">612</span> <span class="mi">792</span> <span class="p">]</span>
  <span class="o">/</span><span class="n">Parent</span> <span class="mi">1301</span> <span class="mi">0</span> <span class="n">R</span>
  <span class="o">/</span><span class="n">Rotate</span> <span class="mi">90</span>
<span class="o">&gt;&gt;</span>
</pre></div>
</div>
</li>
<li><p>The above situation <strong>is supported</strong> by methods <a class="reference internal" href="document.html#Document.xref_set_key" title="Document.xref_set_key"><code class="xref py py-meth docutils literal notranslate"><span class="pre">Document.xref_set_key()</span></code></a> and <a class="reference internal" href="document.html#Document.xref_get_key" title="Document.xref_get_key"><code class="xref py py-meth docutils literal notranslate"><span class="pre">Document.xref_get_key()</span></code></a>: use a path-like notation to point at the required key. For example, to retrieve the value of key <code class="docutils literal notranslate"><span class="pre">Im1</span></code> above, specify the complete chain of dictionaries “above” it in the key argument: <code class="docutils literal notranslate"><span class="pre">&quot;Resources/XObject/Im1&quot;</span></code>:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">In</span> <span class="p">[</span><span class="mi">16</span><span class="p">]:</span> <span class="n">doc</span><span class="o">.</span><span class="n">xref_get_key</span><span class="p">(</span><span class="n">page</span><span class="o">.</span><span class="n">xref</span><span class="p">,</span> <span class="s2">&quot;Resources/XObject/Im1&quot;</span><span class="p">)</span>
<span class="n">Out</span><span class="p">[</span><span class="mi">16</span><span class="p">]:</span> <span class="p">(</span><span class="s1">&#39;xref&#39;</span><span class="p">,</span> <span class="s1">&#39;1291 0 R&#39;</span><span class="p">)</span>
</pre></div>
</div>
</li>
<li><p>The path notation can also be used to <strong>directly set a value</strong>: use the following to let <code class="docutils literal notranslate"><span class="pre">Im1</span></code> point to a different object:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">In</span> <span class="p">[</span><span class="mi">17</span><span class="p">]:</span> <span class="n">doc</span><span class="o">.</span><span class="n">xref_set_key</span><span class="p">(</span><span class="n">page</span><span class="o">.</span><span class="n">xref</span><span class="p">,</span> <span class="s2">&quot;Resources/XObject/Im1&quot;</span><span class="p">,</span> <span class="s2">&quot;9999 0 R&quot;</span><span class="p">)</span>
<span class="n">In</span> <span class="p">[</span><span class="mi">18</span><span class="p">]:</span> <span class="nb">print</span><span class="p">(</span><span class="n">doc</span><span class="o">.</span><span class="n">xref_object</span><span class="p">(</span><span class="n">page</span><span class="o">.</span><span class="n">xref</span><span class="p">))</span>  <span class="c1"># confirm success:</span>
<span class="o">&lt;&lt;</span>
  <span class="o">/</span><span class="n">Type</span> <span class="o">/</span><span class="n">Page</span>
  <span class="o">/</span><span class="n">Contents</span> <span class="mi">1297</span> <span class="mi">0</span> <span class="n">R</span>
  <span class="o">/</span><span class="n">Resources</span> <span class="o">&lt;&lt;</span>
    <span class="o">/</span><span class="n">XObject</span> <span class="o">&lt;&lt;</span>
      <span class="o">/</span><span class="n">Im1</span> <span class="mi">9999</span> <span class="mi">0</span> <span class="n">R</span>
    <span class="o">&gt;&gt;</span>
    <span class="o">/</span><span class="n">Font</span> <span class="o">&lt;&lt;</span>
      <span class="o">/</span><span class="n">F39</span> <span class="mi">1299</span> <span class="mi">0</span> <span class="n">R</span>
      <span class="o">/</span><span class="n">F40</span> <span class="mi">1300</span> <span class="mi">0</span> <span class="n">R</span>
    <span class="o">&gt;&gt;</span>
  <span class="o">&gt;&gt;</span>
  <span class="o">/</span><span class="n">MediaBox</span> <span class="p">[</span> <span class="mi">0</span> <span class="mi">0</span> <span class="mi">612</span> <span class="mi">792</span> <span class="p">]</span>
  <span class="o">/</span><span class="n">Parent</span> <span class="mi">1301</span> <span class="mi">0</span> <span class="n">R</span>
  <span class="o">/</span><span class="n">Rotate</span> <span class="mi">90</span>
<span class="o">&gt;&gt;</span>
</pre></div>
</div>
<p>Be aware, that <strong>no semantic checks</strong> whatsoever will take place here: if the PDF has no xref 9999, it won’t be detected at this point.</p>
</li>
<li><p>If a key does not exist, it will be created by setting its value. Moreover, if any intermediate keys do not exist either, they will also be created as necessary. The following creates an array <code class="docutils literal notranslate"><span class="pre">D</span></code> several levels below the existing dictionary <code class="docutils literal notranslate"><span class="pre">A</span></code>. Intermediate dictionaries <code class="docutils literal notranslate"><span class="pre">B</span></code> and <code class="docutils literal notranslate"><span class="pre">C</span></code> are automatically created:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">In</span> <span class="p">[</span><span class="mi">5</span><span class="p">]:</span> <span class="nb">print</span><span class="p">(</span><span class="n">doc</span><span class="o">.</span><span class="n">xref_object</span><span class="p">(</span><span class="n">xref</span><span class="p">))</span>  <span class="c1"># some existing PDF object:</span>
<span class="o">&lt;&lt;</span>
  <span class="o">/</span><span class="n">A</span> <span class="o">&lt;&lt;</span>
  <span class="o">&gt;&gt;</span>
<span class="o">&gt;&gt;</span>
<span class="n">In</span> <span class="p">[</span><span class="mi">6</span><span class="p">]:</span> <span class="c1"># the following will create &#39;B&#39;, &#39;C&#39; and &#39;D&#39;</span>
<span class="n">In</span> <span class="p">[</span><span class="mi">7</span><span class="p">]:</span> <span class="n">doc</span><span class="o">.</span><span class="n">xref_set_key</span><span class="p">(</span><span class="n">xref</span><span class="p">,</span> <span class="s2">&quot;A/B/C/D&quot;</span><span class="p">,</span> <span class="s2">&quot;[1 2 3 4]&quot;</span><span class="p">)</span>
<span class="n">In</span> <span class="p">[</span><span class="mi">8</span><span class="p">]:</span> <span class="nb">print</span><span class="p">(</span><span class="n">doc</span><span class="o">.</span><span class="n">xref_object</span><span class="p">(</span><span class="n">xref</span><span class="p">))</span>  <span class="c1"># check out what happened:</span>
<span class="o">&lt;&lt;</span>
  <span class="o">/</span><span class="n">A</span> <span class="o">&lt;&lt;</span>
    <span class="o">/</span><span class="n">B</span> <span class="o">&lt;&lt;</span>
      <span class="o">/</span><span class="n">C</span> <span class="o">&lt;&lt;</span>
        <span class="o">/</span><span class="n">D</span> <span class="p">[</span> <span class="mi">1</span> <span class="mi">2</span> <span class="mi">3</span> <span class="mi">4</span> <span class="p">]</span>
      <span class="o">&gt;&gt;</span>
    <span class="o">&gt;&gt;</span>
  <span class="o">&gt;&gt;</span>
<span class="o">&gt;&gt;</span>
</pre></div>
</div>
</li>
<li><p>When setting key values, basic <strong>PDF syntax checking</strong> will be done by MuPDF. For example, new keys can only be created <strong>below a dictionary</strong>. The following tries to create some new string item <code class="docutils literal notranslate"><span class="pre">E</span></code> below the previously created array <code class="docutils literal notranslate"><span class="pre">D</span></code>:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">In</span> <span class="p">[</span><span class="mi">9</span><span class="p">]:</span> <span class="c1"># &#39;D&#39; is an array, no dictionary!</span>
<span class="n">In</span> <span class="p">[</span><span class="mi">10</span><span class="p">]:</span> <span class="n">doc</span><span class="o">.</span><span class="n">xref_set_key</span><span class="p">(</span><span class="n">xref</span><span class="p">,</span> <span class="s2">&quot;A/B/C/D/E&quot;</span><span class="p">,</span> <span class="s2">&quot;(hello)&quot;</span><span class="p">)</span>
<span class="n">mupdf</span><span class="p">:</span> <span class="ow">not</span> <span class="n">a</span> <span class="nb">dict</span> <span class="p">(</span><span class="n">array</span><span class="p">)</span>
<span class="o">---</span> <span class="o">...</span> <span class="o">---</span>
<span class="ne">RuntimeError</span><span class="p">:</span> <span class="ow">not</span> <span class="n">a</span> <span class="nb">dict</span> <span class="p">(</span><span class="n">array</span><span class="p">)</span>
</pre></div>
</div>
</li>
<li><p>It is also <strong>not possible</strong>, to create a key if some higher level key is an <strong>“indirect”</strong> object, i.e. an xref. In other words, xrefs can only be modified directly and not implicitely via other objects referencing them:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">In</span> <span class="p">[</span><span class="mi">13</span><span class="p">]:</span> <span class="c1"># the following object points to an xref</span>
<span class="n">In</span> <span class="p">[</span><span class="mi">14</span><span class="p">]:</span> <span class="nb">print</span><span class="p">(</span><span class="n">doc</span><span class="o">.</span><span class="n">xref_object</span><span class="p">(</span><span class="mi">4</span><span class="p">))</span>
<span class="o">&lt;&lt;</span>
  <span class="o">/</span><span class="n">E</span> <span class="mi">3</span> <span class="mi">0</span> <span class="n">R</span>
<span class="o">&gt;&gt;</span>
<span class="n">In</span> <span class="p">[</span><span class="mi">15</span><span class="p">]:</span> <span class="c1"># &#39;E&#39; is an indirect object and cannot be modified here!</span>
<span class="n">In</span> <span class="p">[</span><span class="mi">16</span><span class="p">]:</span> <span class="n">doc</span><span class="o">.</span><span class="n">xref_set_key</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="s2">&quot;E/F&quot;</span><span class="p">,</span> <span class="s2">&quot;90&quot;</span><span class="p">)</span>
<span class="n">mupdf</span><span class="p">:</span> <span class="n">path</span> <span class="n">to</span> <span class="s1">&#39;F&#39;</span> <span class="n">has</span> <span class="n">indirects</span>
<span class="o">---</span> <span class="o">...</span> <span class="o">---</span>
<span class="ne">RuntimeError</span><span class="p">:</span> <span class="n">path</span> <span class="n">to</span> <span class="s1">&#39;F&#39;</span> <span class="n">has</span> <span class="n">indirects</span>
</pre></div>
</div>
</li>
</ul>
<div class="admonition caution">
<p class="admonition-title">Caution</p>
<p>These are expert functions! There are no validations as to whether valid PDF objects, xrefs, etc. are specified. As with other low-level methods there exists the risk to render the PDF, or parts of it unusable.</p>
</div>
</div>
</div>
</div>


            <div class="clearer"></div>
          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
  <h3><a href="index.html">Table of Contents</a></h3>
  <ul>
<li><a class="reference internal" href="#">Collection of Recipes</a><ul>
<li><a class="reference internal" href="#images">Images</a><ul>
<li><a class="reference internal" href="#how-to-make-images-from-document-pages">How to Make Images from Document Pages</a></li>
<li><a class="reference internal" href="#how-to-increase-image-resolution">How to Increase Image Resolution</a></li>
<li><a class="reference internal" href="#how-to-create-partial-pixmaps-clips">How to Create Partial Pixmaps (Clips)</a></li>
<li><a class="reference internal" href="#how-to-create-or-suppress-annotation-images">How to Create or Suppress Annotation Images</a></li>
<li><a class="reference internal" href="#how-to-extract-images-non-pdf-documents">How to Extract Images: Non-PDF Documents</a></li>
<li><a class="reference internal" href="#how-to-extract-images-pdf-documents">How to Extract Images: PDF Documents</a></li>
<li><a class="reference internal" href="#how-to-handle-stencil-masks">How to Handle Stencil Masks</a></li>
<li><a class="reference internal" href="#how-to-make-one-pdf-of-all-your-pictures-or-files">How to Make one PDF of all your Pictures (or Files)</a></li>
<li><a class="reference internal" href="#how-to-create-vector-images">How to Create Vector Images</a></li>
<li><a class="reference internal" href="#how-to-convert-images">How to Convert Images</a></li>
<li><a class="reference internal" href="#how-to-use-pixmaps-gluing-images">How to Use Pixmaps: Gluing Images</a></li>
<li><a class="reference internal" href="#how-to-use-pixmaps-making-a-fractal">How to Use Pixmaps: Making a Fractal</a></li>
<li><a class="reference internal" href="#how-to-interface-with-numpy">How to Interface with NumPy</a></li>
<li><a class="reference internal" href="#how-to-add-images-to-a-pdf-page">How to Add Images to a PDF Page</a></li>
</ul>
</li>
<li><a class="reference internal" href="#text">Text</a><ul>
<li><a class="reference internal" href="#how-to-extract-all-document-text">How to Extract all Document Text</a></li>
<li><a class="reference internal" href="#how-to-extract-text-from-within-a-rectangle">How to Extract Text from within a Rectangle</a></li>
<li><a class="reference internal" href="#how-to-extract-text-in-natural-reading-order">How to Extract Text in Natural Reading Order</a></li>
<li><a class="reference internal" href="#how-to-extract-tables-from-documents">How to Extract Tables from Documents</a></li>
<li><a class="reference internal" href="#how-to-mark-extracted-text">How to Mark Extracted Text</a></li>
<li><a class="reference internal" href="#how-to-mark-searched-text">How to Mark Searched Text</a></li>
<li><a class="reference internal" href="#how-to-mark-non-horizontal-text">How to Mark Non-horizontal Text</a></li>
<li><a class="reference internal" href="#how-to-analyze-font-characteristics">How to Analyze Font Characteristics</a></li>
<li><a class="reference internal" href="#how-to-insert-text">How to Insert Text</a><ul>
<li><a class="reference internal" href="#how-to-write-text-lines">How to Write Text Lines</a></li>
<li><a class="reference internal" href="#how-to-fill-a-text-box">How to Fill a Text Box</a></li>
<li><a class="reference internal" href="#how-to-use-non-standard-encoding">How to Use Non-Standard Encoding</a></li>
</ul>
</li>
</ul>
</li>
<li><a class="reference internal" href="#annotations">Annotations</a><ul>
<li><a class="reference internal" href="#how-to-add-and-modify-annotations">How to Add and Modify Annotations</a></li>
<li><a class="reference internal" href="#how-to-use-freetext">How to Use FreeText</a></li>
<li><a class="reference internal" href="#using-buttons-and-javascript">Using Buttons and JavaScript</a></li>
<li><a class="reference internal" href="#how-to-use-ink-annotations">How to Use Ink Annotations</a></li>
</ul>
</li>
<li><a class="reference internal" href="#drawing-and-graphics">Drawing and Graphics</a></li>
<li><a class="reference internal" href="#extracting-drawings">Extracting Drawings</a></li>
<li><a class="reference internal" href="#multiprocessing">Multiprocessing</a></li>
<li><a class="reference internal" href="#general">General</a><ul>
<li><a class="reference internal" href="#how-to-open-with-a-wrong-file-extension">How to Open with a Wrong File Extension</a></li>
<li><a class="reference internal" href="#how-to-embed-or-attach-files">How to Embed or Attach Files</a></li>
<li><a class="reference internal" href="#how-to-delete-and-re-arrange-pages">How to Delete and Re-Arrange Pages</a></li>
<li><a class="reference internal" href="#how-to-join-pdfs">How to Join PDFs</a></li>
<li><a class="reference internal" href="#how-to-add-pages">How to Add Pages</a></li>
<li><a class="reference internal" href="#how-to-dynamically-clean-up-corrupt-pdfs">How To Dynamically Clean Up Corrupt PDFs</a></li>
<li><a class="reference internal" href="#how-to-split-single-pages">How to Split Single Pages</a></li>
<li><a class="reference internal" href="#how-to-combine-single-pages">How to Combine Single Pages</a></li>
<li><a class="reference internal" href="#how-to-convert-any-document-to-pdf">How to Convert Any Document to PDF</a></li>
<li><a class="reference internal" href="#how-to-deal-with-messages-issued-by-mupdf">How to Deal with Messages Issued by MuPDF</a></li>
<li><a class="reference internal" href="#how-to-deal-with-pdf-encryption">How to Deal with PDF Encryption</a></li>
</ul>
</li>
<li><a class="reference internal" href="#common-issues-and-their-solutions">Common Issues and their Solutions</a><ul>
<li><a class="reference internal" href="#changing-annotations-unexpected-behaviour">Changing Annotations: Unexpected Behaviour</a><ul>
<li><a class="reference internal" href="#problem">Problem</a></li>
<li><a class="reference internal" href="#cause">Cause</a></li>
<li><a class="reference internal" href="#solutions">Solutions</a></li>
</ul>
</li>
<li><a class="reference internal" href="#misplaced-item-insertions-on-pdf-pages">Misplaced Item Insertions on PDF Pages</a><ul>
<li><a class="reference internal" href="#id7">Problem</a></li>
<li><a class="reference internal" href="#id8">Cause</a></li>
<li><a class="reference internal" href="#id9">Solutions</a></li>
</ul>
</li>
</ul>
</li>
<li><a class="reference internal" href="#low-level-interfaces">Low-Level Interfaces</a><ul>
<li><a class="reference internal" href="#how-to-iterate-through-the-xref-table">How to Iterate through the <code class="xref py py-data docutils literal notranslate"><span class="pre">xref</span></code> Table</a></li>
<li><a class="reference internal" href="#how-to-handle-object-streams">How to Handle Object Streams</a></li>
<li><a class="reference internal" href="#how-to-handle-page-contents">How to Handle Page Contents</a></li>
<li><a class="reference internal" href="#how-to-access-the-pdf-catalog">How to Access the PDF Catalog</a></li>
<li><a class="reference internal" href="#how-to-access-the-pdf-file-trailer">How to Access the PDF File Trailer</a></li>
<li><a class="reference internal" href="#how-to-access-xml-metadata">How to Access XML Metadata</a></li>
<li><a class="reference internal" href="#how-to-read-and-update-pdf-objects">How to Read and Update PDF Objects</a></li>
</ul>
</li>
</ul>
</li>
</ul>

  <h4>Previous topic</h4>
  <p class="topless"><a href="tutorial.html"
                        title="previous chapter">Tutorial</a></p>
  <h4>Next topic</h4>
  <p class="topless"><a href="module.html"
                        title="next chapter">Using <em>fitz</em> as a Module</a></p>
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" />
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="module.html" title="Using fitz as a Module"
             >next</a> |</li>
        <li class="right" >
          <a href="tutorial.html" title="Tutorial"
             >previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="index.html">PyMuPDF 1.18.9 documentation</a> &#187;</li>
        <li class="nav-item nav-item-this"><a href="">Collection of Recipes</a></li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
        &#169; Copyright 2015-2021, Jorj X. McKie.
      Last updated on 10. Feb 2021.
      Created using <a href="https://www.sphinx-doc.org/">Sphinx</a> 3.4.3.
    </div>
  </body>
</html>